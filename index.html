<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Iron Log - é“æ—¥è®°</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class', // <--- æ ¸å¿ƒä¿®å¤ç‚¹ï¼šå¼€å¯æ‰‹åŠ¨ class æ¨¡å¼
            theme: {
                extend: {
                    colors: {
                        iron: '#A3FF00',
                    },
                    animation: {
                        'pulse-fast': 'pulse-fast 1s cubic-bezier(0.4, 0, 0.6, 1) infinite',
                    },
                    keyframes: {
                        'pulse-fast': {
                            '0%, 100%': {
                                transform: 'scale(1)',
                                boxShadow: '0 0 0 rgba(249, 115, 22, 0)'
                            },
                            '50%': {
                                transform: 'scale(1.02)',
                                boxShadow: '0 0 20px rgba(249, 115, 22, 0.5)'
                            }
                        }
                    }
                }
            }
        }
    </script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.15.0/Sortable.min.js"></script>
    <style>
        /* æ‹–æ‹½æ—¶çš„å¹½çµæ ·å¼ (Ghost) */
        /* === V15.3 æŒ‰å‹åé¦ˆ === */

        /* å…¨å±€ç§»é™¤çº¢è‰²è¾¹æ¡† */
        * {
            outline: none !important;
        }
        *:focus {
            outline: none !important;
            box-shadow: none !important;
        }

        /* é˜²æ­¢æ»šåŠ¨æ¡å¯¼è‡´çš„å¸ƒå±€åç§» */
        html {
            /* overflow-y: scroll; */
        }
        /* body {
            overflow-x: hidden;
            width: 100vw;
        } */

        /* === GPU åŠ é€Ÿä¼˜åŒ– === */
        /* è®­ç»ƒå¡ç‰‡å®¹å™¨ - GPUåŠ é€Ÿ */
        .plan-card {
            /* will-change: transform; */
            /* transform: translateZ(0); */
            /* backface-visibility: hidden; */
            /* -webkit-backface-visibility: hidden; */
        }

        /* æ·»åŠ é¢æ¿åŠ¨ç”»ä¼˜åŒ– */
        #add-panel {
            /* will-change: opacity, transform; */
        }

        /* æ–°å¡ç‰‡æ·»åŠ åŠ¨ç”» */
        @keyframes cardSlideIn {
            0% {
                opacity: 0;
                transform: translateY(30px) scale(0.95);
            }
            100% {
                opacity: 1;
                transform: translateY(0) scale(1);
            }
        }

        .newly-added-card {
            animation: cardSlideIn 0.5s cubic-bezier(0.16, 1, 0.3, 1) forwards;
        }

        /* ä¼˜åŒ–transitionæ€§èƒ½ - ä½¿ç”¨å…·ä½“å±æ€§ */
        .optimized-transition {
            transition-property: opacity, transform;
            transition-duration: 0.3s;
            transition-timing-function: cubic-bezier(0.4, 0, 0.2, 1);
        }

        /* === V25.0 SortableJS åŠ¨ç”»ä¼˜åŒ– === */
        /* å…³é”®ï¼šä¸è¦é˜»æ­¢ transform åŠ¨ç”»ï¼ŒSortableJS éœ€è¦ç”¨å®ƒæ¥å®ç°ä¸æ»‘ä½ç§» */

        /* å½“ Sortable æ£€æµ‹åˆ°é•¿æŒ‰å‡†å¤‡å°±ç»ªæ—¶ï¼Œä¼šè‡ªåŠ¨æ·»åŠ è¿™ä¸ªç±» */
        .sortable-chosen {
            transform: scale(0.95) !important; /* æ˜æ˜¾ç¼©å° */
            box-shadow: 0 0 0 3px #A3FF00, 0 10px 40px rgba(163, 255, 0, 0.4) !important; /* æ˜æ˜¾çš„ç»¿è‰²å‘å…‰è¾¹æ¡† */
            opacity: 0.9 !important;
            transition: all 0.3s cubic-bezier(0.22, 1, 0.36, 1) !important;
        }

        /* å ä½ç¬¦æ ·å¼ (æ‹–èµ°åç•™ä¸‹çš„å‘) */
        .sortable-ghost {
            opacity: 0.4 !important;
            background: #F3F4F6 !important;
            border: 2px dashed #A3FF00 !important;
            transform: scale(0.98) !important;
            /* å‘ä¸éœ€è¦è¿‡æ¸¡åŠ¨ç”» */
            transition: none !important;
        }

        html.dark .sortable-ghost {
            background: #27272a !important;
            border: 2px dashed #A3FF00 !important;
        }

        /* æ­£åœ¨æ‹–æ‹½çš„å¡ç‰‡ (Drag) */
        .sortable-drag {
            cursor: grabbing !important;
            transform: scale(1.05) rotate(2deg) !important; /* æ˜æ˜¾æ”¾å¤§ + è½»å¾®æ—‹è½¬ */
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5), 0 0 0 4px #A3FF00 !important; /* è¶…å¤§é˜´å½± + ç»¿è‰²è¾¹æ¡† */
            opacity: 1 !important;
            /* æ‹–æ‹½ä¸­çš„å¡ç‰‡ä¸éœ€è¦è¿‡æ¸¡ */
            transition: none !important;
            z-index: 9999 !important;
        }

        /* å…¶ä»–å¡ç‰‡è‡ªåŠ¨è®©ä½çš„åŠ¨ç”» - ç”± SortableJS è‡ªåŠ¨æ·»åŠ  */
        .swipe-container {
            /* åªå…è®¸ transform æœ‰è¿‡æ¸¡ï¼Œè®© SortableJS æ§åˆ¶ä½ç½®åŠ¨ç”» */
            transition-property: transform;
            transition-timing-function: cubic-bezier(0.25, 1, 0.5, 1);
        }

        /* æ‹–æ‹½æ¨¡å¼ä¸‹çš„å…¨å±€æ ·å¼ */
        body.dragging-mode {
            cursor: grabbing;
            user-select: none;
        }

        body.dragging-mode .swipe-container {
            cursor: grab;
        }
    </style>
    <style>
        /* åœ†ç¯è¿›åº¦åŠ¨ç”» */
        .progress-ring__circle {
            transition: stroke-dashoffset 0.6s cubic-bezier(0.4, 0, 0.2, 1);
            transform: rotate(-90deg);
            transform-origin: 50% 50%;
        }

        /* å€’è®¡æ—¶åŠ¨ç”» */
        .timer-pulse {
            animation: pulse 1s ease-in-out infinite;
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }

        /* å·¨å¤§æŒ‰é’®ç‚¹å‡»æ•ˆæœ */
        .huge-btn:active {
            transform: scale(0.95);
        }

        /* å¡ç‰‡å®Œæˆé«˜äº® */
        .card-completed {
            background: linear-gradient(135deg, #A3FF00 0%, #7FFF00 100%) !important;
            border-color: #A3FF00 !important;
        }

        .card-completed .text-white,
        .card-completed .dark\:text-white {
            color: black !important;
        }

        .card-completed .text-zinc-400,
        .card-completed .dark\:text-zinc-400 {
            color: rgba(0,0,0,0.7) !important;
        }

        .card-completed .text-gray-500 {
            color: rgba(0,0,0,0.6) !important;
        }

        /* æ ‡ç­¾é¡µåˆ‡æ¢ */
        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        /* åº•éƒ¨å¯¼èˆªæ æ ·å¼ç”± JavaScript åŠ¨æ€æ§åˆ¶ */

        /* iPhone åº•éƒ¨å®‰å…¨åŒºåŸŸ */
        @supports (padding: max(0px)) {
            .pb-safe {
                padding-bottom: max(1rem, env(safe-area-inset-bottom));
            }
        }

        /* æ–¹å—ç‚¹å‡»æ•ˆæœ */
        .active\:scale-95:active {
            transform: scale(0.95);
        }

        /* å†…é˜´å½±æ•ˆæœ */
        .shadow-inner {
            box-shadow: inset 0 2px 4px 0 rgba(0, 0, 0, 0.3);
        }

        /* æ˜äº®æ¨¡å¼ä¸‹çš„å†…é˜´å½± */
        html:not(.dark) .shadow-inner {
            box-shadow: inset 0 1px 2px 0 rgba(0, 0, 0, 0.1);
        }

        /* iOS Reminders é£æ ¼æ³¡æ³¡åŠ¨ç”» */
        @keyframes spring-in {
            0% {
                transform: scale(0);
                opacity: 0;
            }
            50% {
                transform: scale(1.1);
            }
            100% {
                transform: scale(1);
                opacity: 1;
            }
        }

        .animate-spring-in {
            animation: spring-in 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }

        /* V18.0 æ¸è¿›å¼å‘ˆç°åŠ¨ç”» */
        @keyframes slide-up-fade {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .animate-slide-up {
            animation: slide-up-fade 0.4s cubic-bezier(0.16, 1, 0.3, 1) forwards;
        }

        /* V19.0 å±•å¼€åŠ¨ç”» */
        @keyframes slide-down-fade {
            from {
                opacity: 0;
                max-height: 0;
            }
            to {
                opacity: 1;
                max-height: 1000px;
            }
        }

        .animate-slide-down {
            animation: slide-down-fade 0.3s cubic-bezier(0.16, 1, 0.3, 1) forwards;
        }

        /* ä»ªè¡¨ç›˜å±•å¼€/æ”¶èµ·åŠ¨ç”» */
        @keyframes slide-down {
            from {
                opacity: 0;
                transform: translateY(-20px) scale(0.95);
            }
            to {
                opacity: 1;
                transform: translateY(0) scale(1);
            }
        }

        .animate-slide-down {
            animation: slide-down 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }

        /* V12.0 æ‰‹é£ç´æ·¡å…¥åŠ¨ç”» */
        @keyframes fade-in {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .animate-fade-in {
            animation: fade-in 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }

        /* æ–°æ·»åŠ å¡ç‰‡ä»ä¸Šæ–¹æ»‘å…¥åŠ¨ç”» */
        @keyframes card-slide-in {
            0% {
                opacity: 0;
                transform: translateY(-40px) scale(0.95);
            }
            100% {
                opacity: 1;
                transform: translateY(0) scale(1);
            }
        }

        .card-slide-in {
            animation: card-slide-in 0.5s cubic-bezier(0.16, 1, 0.3, 1) forwards;
        }

        /* === V13.0 å¼ºåˆ¶ç‰©ç†å¼•æ“ === */

        /* æ²‰åº•å‰çš„é«˜å…‰æ ·å¼ */
        .preparing-to-sink {
            transform: scale(1.05) translateY(-8px) !important;
            box-shadow: 0 20px 40px -5px rgba(163, 255, 0, 0.4) !important;
            border-color: #A3FF00 !important;
            background-color: rgba(163, 255, 0, 0.05) !important;
            z-index: 100 !important; /* å±‚çº§ä¸€å®šè¦æœ€é«˜ */
            transition: all 0.6s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }

        /* å…³é”®ï¼šå¼ºåˆ¶è®©æ‰€æœ‰ transition æ‰§è¡Œæ…¢åŠ¨ä½œ */
        ::view-transition-group(*) {
            animation-duration: 0.8s !important;
            animation-timing-function: cubic-bezier(0.34, 1.56, 0.64, 1) !important;
        }

        /* ç¡®ä¿æ—§ä½ç½®å’Œæ–°ä½ç½®çš„å¿«ç…§æ··åˆæ¨¡å¼æ­£å¸¸ */
        ::view-transition-old(*),
        ::view-transition-new(*) {
            /* é˜²æ­¢æ··è‰²å¯¼è‡´å˜é»‘ */
            mix-blend-mode: normal;
            height: 100%;
            width: 100%;
        }

        /* V13.0 æ²‰åº•åŠ¨ç”»çš„å…³é”®å¸§ */
        @keyframes cinematic-sink {
            0% {
                transform: scale(1.05) translateY(-8px);
                box-shadow: 0 20px 40px -5px rgba(163, 255, 0, 0.3);
                opacity: 1;
            }
            30% {
                transform: scale(1.02) translateY(-4px);
                box-shadow: 0 15px 30px -5px rgba(163, 255, 0, 0.2);
                opacity: 1;
            }
            100% {
                transform: scale(1) translateY(0);
                box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
                opacity: 1;
            }
        }

        .cinematic-sinking {
            animation: cinematic-sink 0.8s cubic-bezier(0.4, 0, 0.2, 1) forwards;
        }

        /* ç”µå½±çº§ä¸æ»‘æ²‰åº•åŠ¨ç”» - å››é˜¶æ®µ */
        /* é˜¶æ®µ1ï¼šæµ®èµ· */
        @keyframes float-up {
            0% {
                transform: scale(1) translateY(0);
            }
            100% {
                transform: scale(1.08) translateY(-16px);
                box-shadow: 0 25px 50px -12px rgba(163, 255, 0, 0.5);
            }
        }

        /* é˜¶æ®µ2ï¼šæ‚¬æµ®å‘¼å¸ */
        @keyframes hover-breathe {
            0%, 100% {
                transform: scale(1.08) translateY(-16px);
                box-shadow: 0 25px 50px -12px rgba(163, 255, 0, 0.5);
            }
            50% {
                transform: scale(1.1) translateY(-18px);
                box-shadow: 0 30px 60px -12px rgba(163, 255, 0, 0.6);
            }
        }

        /* é˜¶æ®µ3ï¼šè½åœ°æ¢å¤ */
        @keyframes land-gently {
            0% {
                transform: scale(1.08) translateY(-16px);
            }
            100% {
                transform: scale(1) translateY(0);
            }
        }

        .sinking-float-up {
            animation: float-up 0.6s cubic-bezier(0.34, 1.56, 0.64, 1) forwards;
        }

        .sinking-hover-breathe {
            animation: hover-breathe 0.8s ease-in-out forwards;
        }

        .sinking-land {
            animation: land-gently 0.5s cubic-bezier(0.34, 1.56, 0.64, 1) forwards;
        }

        /* æ²‰åº•è¿‡æ¸¡åŠ¨ç”» - ç”¨äºå¹³æ»‘ç§»åŠ¨åˆ°æ–°ä½ç½® */
        .sinking-transition {
            transition: transform 1.2s cubic-bezier(0.23, 1, 0.32, 1),
                        opacity 0.4s ease;
        }

        /* æ·»åŠ åŠ¨ä½œæŒ‰é’®çš„å¾®åŠ¨ç”» */
        .add-glow-btn {
            position: relative;
            overflow: hidden;
        }

        .add-glow-btn::before {
            content: '';
            position: absolute;
            inset: 0;
            background: radial-gradient(circle at center, rgba(163, 255, 0, 0.1) 0%, transparent 70%);
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .add-glow-btn:hover::before {
            opacity: 1;
        }

        /* === V14.2 ä¿®å¤ç‰ˆï¼šSiri è¾¹ç¼˜æµå…‰ (ä¸‰æ˜æ²»é®ç½©æ³•) === */

        /* 1. æ—‹è½¬åŠ¨ç”» */
        @keyframes border-flow {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }

        /* 2. å‘¼å¸åŠ¨ç”» */
        @keyframes border-breathe {
            0%, 100% { opacity: 1; filter: blur(8px); }
            50% { opacity: 0.6; filter: blur(6px); }
        }

        /* === V21.0 All-in-One: å…¨åŠŸèƒ½ä¿®å¤ç‰ˆ === */

        /* 1. åŸºç¡€å¡ç‰‡æ ·å¼ */
        .swipe-container.plan-card {
            position: relative;
            background-color: #fafafa; /* é»˜è®¤ï¼šæµ…ç°å®å¿ƒ */
            overflow: hidden; /* é»˜è®¤éšè—æº¢å‡º */
            touch-action: pan-y;
            user-select: none;
            -webkit-user-select: none;
            transition: all 0.3s cubic-bezier(0.2, 0.8, 0.2, 1);
        }

        html.dark .swipe-container.plan-card {
            background-color: #18181b; /* æ·±è‰²æ¨¡å¼ï¼šzinc-900 å®å¿ƒ */
        }

        /* 2. V24.0: å®ŒæˆçŠ¶æ€ä¸“ç”¨æ ·å¼ */
        .swipe-container.plan-card.is-completed {
            background-color: rgba(163, 255, 0, 0.2) !important;
            border-color: #A3FF00 !important;
        }

        .swipe-container.plan-card.is-completed .card-content-layer {
            background-color: transparent !important; /* å¼ºåˆ¶é€æ˜ï¼Œè®©å¤–å±‚ç»¿è‰²é€è¿›æ¥ */
        }

        /* 3. éæ¿€æ´»çŠ¶æ€ï¼šå¡ç‰‡å†…å®¹å±‚å¿…é¡»æœ‰å®å¿ƒèƒŒæ™¯ï¼ˆé®æŒ¡çº¢è‰²åˆ é™¤å±‚ï¼‰ */
        .plan-card:not(.is-active):not(.is-completed) .card-content-layer {
            background-color: #ffffff !important; /* æµ…è‰²ï¼šçº¯ç™½ */
        }

        html.dark .plan-card:not(.is-active):not(.is-completed) .card-content-layer {
            background-color: #18181b !important; /* æ·±è‰²ï¼šzinc-900 */
        }

        /* 4. æ¿€æ´»çŠ¶æ€ï¼šå…è®¸å…‰æ™•æº¢å‡º */
        .plan-card.is-active {
            overflow: visible !important;
            z-index: 10;
        }

        /* 5. æ¿€æ´»çŠ¶æ€ï¼šå¼ºåˆ¶éšè—çº¢è‰²åˆ é™¤å±‚ï¼ˆé˜²æ­¢é€çº¢ï¼‰ */
        .plan-card.is-active .delete-action-layer {
            display: none !important;
        }

        /* 6. æ¿€æ´»çŠ¶æ€ï¼šSiri æµå…‰ç‰¹æ•ˆ - åœ¨ .plan-card ä¸Šåº”ç”¨ä¼ªå…ƒç´  */
        /* æµå…‰æ¸å˜å±‚ (::before) - æœ€åº•å±‚ */
        .plan-card.is-active::before {
            content: '';
            position: absolute;
            inset: -2px;
            z-index: 0; /* åœ¨åˆ é™¤å±‚ä¹‹ä¸Šï¼Œä½†åœ¨å†…å®¹ä¹‹ä¸‹ */
            border-radius: 1.5rem;
            background: linear-gradient(60deg, #A3FF00, #00E5FF, #FF00DD, #A3FF00);
            background-size: 300% 300%;
            animation: border-flow 4s ease infinite, border-breathe 3s ease-in-out infinite alternate;
            filter: blur(8px);
            pointer-events: none;
        }

        /* å®å¿ƒé®ç½©å±‚ (::after) - ä¸­é—´å±‚ï¼ŒæŒ¡ä½æµå…‰ä¸­å¿ƒ */
        .plan-card.is-active::after {
            content: '';
            position: absolute;
            inset: 0;
            z-index: 1; /* åœ¨æµå…‰å±‚ä¹‹ä¸Š */
            border-radius: 1.5rem;
            background-color: #ffffff; /* æµ…è‰²æ¨¡å¼ */
            pointer-events: none;
        }

        html.dark .plan-card.is-active::after {
            background-color: #09090b; /* æ·±è‰²æ¨¡å¼ï¼šzinc-950 */
        }

        /* 7. æ¿€æ´»çŠ¶æ€ï¼šå†…å®¹å±‚éœ€è¦é€æ˜æ‰èƒ½çœ‹åˆ°ä¸‹é¢çš„é®ç½©å±‚ */
        .plan-card.is-active .card-content-layer {
            background: transparent !important;
            border-color: transparent !important;
            position: relative;
            z-index: 2; /* æœ€é¡¶å±‚ */
        }

        /* 8. åˆ é™¤æŒ‰é’®å±‚ï¼ˆéæ¿€æ´»çŠ¶æ€ï¼‰ */
        .delete-action-layer {
            position: absolute;
            top: 1px;
            bottom: 1px;
            right: 1px;
            left: 1px;
            width: auto;
            background-color: #ef4444;
            border-radius: inherit;
            display: flex;
            align-items: center;
            justify-content: flex-end;
            padding-right: 2rem;
            z-index: 0;
        }

        /* === V15.0 å·¦æ»‘åˆ é™¤æ ·å¼ï¼ˆå·²æ•´åˆåˆ°V21.0ï¼‰ === */
        /* åˆ é™¤æ—¶çš„æ¶ˆå¤±åŠ¨ç”» */
        @keyframes slide-out-left {
            to {
                transform: translateX(-100%);
                opacity: 0;
                height: 0;
                margin: 0;
                padding: 0;
            }
        }
        .being-deleted {
            animation: slide-out-left 0.4s forwards ease-in-out;
        }
    </style>
</head>
<body class="font-sans tracking-wide min-h-screen bg-[#F5F5F7] dark:bg-black text-gray-900 dark:text-white transition-colors duration-300">

    <!-- ============ è®­ç»ƒé¡µé¢ ============ -->
    <div id="tab-workout" class="tab-content active">
        <!-- ä¸»å®¹å™¨ -->
        <div class="max-w-md mx-auto min-h-screen px-6 py-6 pb-28 flex flex-col relative">

            <!-- Appleé£æ ¼é¡¶éƒ¨ Header -->
            <header class="flex justify-between items-end mb-0">
                <!-- å·¦ä¾§ï¼šä¿¡æ¯åŒº -->
                <div class="flex flex-col">
                    <!-- Date: Uppercase, wide tracking -->
                    <p id="current-date" class="text-[10px] font-bold text-zinc-500 uppercase tracking-[0.2em] mb-1">MONDAY, JAN 19</p>
                    <!-- Title: Large, bold, with status dot -->
                    <div class="flex items-center gap-2">
                        <h1 class="text-3xl font-black text-white tracking-tight">å¼€å§‹è®­ç»ƒ</h1>
                        <!-- Pulsing status dot (only visible when training is active) -->
                        <div id="status-dot" class="hidden relative">
                            <div class="w-2 h-2 bg-[#A3FF00] rounded-full"></div>
                            <div class="absolute inset-0 w-2 h-2 bg-[#A3FF00] rounded-full animate-ping opacity-75"></div>
                        </div>
                    </div>
                </div>

                <!-- å³ä¾§ï¼šControl Island -->
                <div class="flex items-center gap-2">
                    <!-- End Button -->
                    <button id="end-session-btn" class="hidden px-4 py-1.5 bg-red-500/10 text-red-500 hover:bg-red-500 hover:text-white transition-colors duration-200 rounded-lg text-xs font-bold whitespace-nowrap">
                        ç»“æŸè®­ç»ƒ
                    </button>

                    <!-- Timer: Monospace, digital watch style -->
                    <div id="timer-container" class="hidden px-3 py-1 bg-zinc-900 border border-white/10 rounded-lg">
                        <span id="session-timer" class="text-sm font-mono text-[#A3FF00] tabular-nums font-semibold">00:00</span>
                    </div>

                    <!-- Theme Toggle -->
                    <button id="theme-toggle-btn" class="w-8 h-8 flex items-center justify-center text-zinc-500 hover:text-white transition-colors rounded-lg hover:bg-zinc-900">
                        <span id="theme-icon" class="text-sm">ğŸŒ™</span>
                    </button>
                </div>
            </header>

            <!-- ç®€æ´SVGè¿›åº¦ç¯ -->
            <div class="flex justify-center items-center pt-0 pb-2">
                <div class="relative" style="width: 260px; height: 260px;">
                    <svg width="260" height="260" viewBox="0 0 280 280">
                        <defs>
                            <linearGradient id="outerGrad" x1="0%" y1="0%" x2="100%" y2="100%">
                                <stop offset="0%" stop-color="#A3FF00"/>
                                <stop offset="100%" stop-color="#22c55e"/>
                            </linearGradient>
                            <linearGradient id="innerGrad" x1="0%" y1="0%" x2="100%" y2="100%">
                                <stop offset="0%" stop-color="#22d3ee"/>
                                <stop offset="100%" stop-color="#0891b2"/>
                            </linearGradient>
                        </defs>

                        <!-- å¤–åœˆè½¨é“ -->
                        <circle cx="140" cy="140" r="110" fill="none" stroke="#27272a" stroke-width="14" opacity="0.5"/>
                        <!-- å†…åœˆè½¨é“ -->
                        <circle cx="140" cy="140" r="88" fill="none" stroke="#27272a" stroke-width="14" opacity="0.5"/>

                        <!-- å¤–åœˆè¿›åº¦ -->
                        <circle id="outer-ring" cx="140" cy="140" r="110" fill="none"
                            stroke="url(#outerGrad)" stroke-width="14" stroke-linecap="round"
                            stroke-dasharray="691.15" stroke-dashoffset="684.24"
                            transform="rotate(-90, 140, 140)"
                            style="transition: stroke-dashoffset 0.8s cubic-bezier(0.16, 1, 0.3, 1);"/>

                        <!-- å†…åœˆè¿›åº¦ -->
                        <circle id="inner-ring" cx="140" cy="140" r="88" fill="none"
                            stroke="url(#innerGrad)" stroke-width="14" stroke-linecap="round"
                            stroke-dasharray="552.92" stroke-dashoffset="547.39"
                            transform="rotate(-90, 140, 140)"
                            style="transition: stroke-dashoffset 0.8s cubic-bezier(0.16, 1, 0.3, 1);"/>
                    </svg>

                    <!-- ä¸­å¿ƒæ–‡æœ¬ -->
                    <div class="absolute inset-0 flex flex-col items-center justify-center pointer-events-none">
                        <div id="total-progress" class="text-7xl font-semibold text-white tabular-nums tracking-tight" style="text-shadow: 0 2px 20px rgba(0,0,0,0.8);">0</div>
                        <div class="text-xs font-medium text-zinc-500 mt-1 uppercase tracking-widest">ä»Šæ—¥å®Œæˆ</div>
                    </div>
                </div>
            </div>

            <!-- ç²¾è‡´é»‘é‡‘æ§åˆ¶å° - ç»¿è‰²è§å…‰ç‰ˆæœ¬ -->
            <div class="mb-6 relative w-full rounded-3xl border border-white/10 bg-[#09090b]/80 bg-gradient-to-b from-[#6EDD46]/5 to-transparent shadow-[0_0_40px_-10px_rgba(110,221,70,0.3)] backdrop-blur-xl ring-1 ring-inset ring-white/5 overflow-hidden transition-all duration-500 ease-[cubic-bezier(0.25,1,0.5,1)]"
                 id="add-container">

                <div id="add-trigger" onclick="toggleAddPanel(true)"
                     class="px-6 cursor-pointer group hover:bg-zinc-800/30 dark:hover:bg-black/30 transition-colors flex items-center justify-center gap-3 h-[60px] -mt-0.5">
                    <div class="w-8 h-8 rounded-full bg-zinc-800 dark:bg-black group-hover:bg-[#A3FF00] text-zinc-400 group-hover:text-black flex items-center justify-center transition-colors shrink-0 -mt-2.5">
                        <svg class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="3"><path stroke-linecap="round" stroke-linejoin="round" d="M12 4v16m8-8H4"/></svg>
                    </div>
                    <span class="text-zinc-400 dark:text-zinc-500 font-semibold group-hover:text-[#A3FF00] transition-colors text-base leading-none -mt-2.5">æ·»åŠ æ–°åŠ¨ä½œ</span>
                </div>

                <div id="add-panel" class="hidden opacity-0 px-4 py-3 relative optimized-transition" style="transform: translateY(-10px);">

                    <div class="flex items-end justify-between mb-3 gap-2">

                        <div class="flex-1">
                            <input type="text" id="config-name" placeholder="åŠ¨ä½œåç§°"
                                class="w-full bg-transparent text-2xl font-black text-gray-900 dark:text-white placeholder-gray-400 dark:placeholder-zinc-600 outline-none transition-colors leading-none">
                        </div>

                        <div class="flex items-center gap-2">
                            <div class="flex bg-gray-200 dark:bg-black/40 rounded-full p-0.5 border border-gray-300 dark:border-white/10 shrink-0 h-8 items-center">
                                <button id="type-strength" onclick="selectExerciseType('strength')" class="px-3 h-full text-[10px] font-bold text-white dark:text-black bg-gray-900 dark:bg-[#A3FF00] rounded-full flex items-center transition-colors duration-200">åŠ›é‡</button>
                                <button id="type-cardio" onclick="selectExerciseType('cardio')" class="px-3 h-full text-[10px] font-bold text-zinc-500 dark:text-zinc-400 rounded-full hover:text-zinc-300 dark:hover:text-zinc-200 transition-colors duration-200 flex items-center">æœ‰æ°§</button>
                            </div>
                            <button onclick="toggleAddPanel(false)" class="w-7 h-7 rounded-full bg-gray-300 dark:bg-zinc-800/50 hover:bg-gray-400 dark:hover:bg-zinc-700 flex items-center justify-center text-gray-600 dark:text-zinc-400 transition-colors">
                                <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2.5"><path stroke-linecap="round" stroke-linejoin="round" d="M5 15l7-7 7 7"/></svg>
                            </button>
                        </div>
                    </div>

                    <!-- åŠ›é‡è®­ç»ƒå‚æ•° -->
                    <div id="strength-params" class="grid grid-cols-3 gap-2 mb-3">

                        <div class="h-14 bg-black dark:bg-black/80 rounded-xl px-3 flex items-center justify-between border border-gray-300 dark:border-zinc-800/60 relative group hover:border-[#A3FF00]/30 transition-colors">
                            <input type="number" id="config-sets" value="4" class="bg-transparent text-left text-3xl font-black text-gray-900 dark:text-white w-14 outline-none z-10 focus:text-[#A3FF00] transition-colors p-0 leading-none mt-[-2px]" onchange="updateSetsDetails()">
                            <span class="text-[9px] font-bold text-zinc-500 dark:text-zinc-600 uppercase tracking-widest shrink-0 text-right leading-tight">ç»„</span>
                        </div>

                        <div class="h-14 bg-black dark:bg-black/80 rounded-xl px-3 flex items-center justify-between border border-gray-300 dark:border-zinc-800/60 relative group hover:border-[#A3FF00]/30 transition-colors">
                            <input type="number" id="config-reps" value="10" class="bg-transparent text-left text-3xl font-black text-gray-900 dark:text-white w-14 outline-none z-10 focus:text-[#A3FF00] transition-colors p-0 leading-none mt-[-2px]">
                            <span class="text-[9px] font-bold text-zinc-500 dark:text-zinc-600 uppercase tracking-widest shrink-0 text-right leading-tight">æ¬¡</span>
                        </div>

                        <div class="h-14 bg-black dark:bg-black/80 rounded-xl px-3 flex items-center justify-between border border-gray-300 dark:border-zinc-800/60 relative group hover:border-[#A3FF00]/30 transition-colors">
                            <input type="number" id="config-weight" value="20" class="bg-transparent text-left text-3xl font-black text-gray-900 dark:text-white w-full outline-none z-10 focus:text-[#A3FF00] transition-colors p-0 leading-none mt-[-2px]">
                            <span class="text-[9px] font-bold text-zinc-500 dark:text-zinc-600 uppercase tracking-widest shrink-0 text-right leading-tight">KG</span>
                        </div>
                    </div>

                    <!-- è¯¦ç»†è®¾ç½®æŒ‰é’® -->
                    <div id="advanced-sets-btn-container" class="mb-3">
                        <button onclick="toggleAdvancedSets()" class="w-full py-2 rounded-lg bg-gray-200 dark:bg-zinc-800 text-sm font-bold text-zinc-700 dark:text-zinc-300 hover:bg-gray-300 dark:hover:bg-zinc-700 transition-colors duration-200 flex items-center justify-center gap-2">
                            <svg id="advanced-chevron" class="w-4 h-4 transition-transform duration-200" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2.5">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M19 9l-7 7-7-7" />
                            </svg>
                            <span>è¯¦ç»†è®¾ç½®ï¼ˆæ¯ç»„ç‹¬ç«‹é…ç½®ï¼‰</span>
                        </button>
                    </div>

                    <!-- æ¯ç»„è¯¦ç»†è®¾ç½®ï¼ˆé»˜è®¤éšè—ï¼‰ -->
                    <div id="advanced-sets-container" class="hidden mb-3 max-h-48 overflow-y-auto">
                        <div id="sets-details-list" class="space-y-2">
                            <!-- åŠ¨æ€ç”Ÿæˆ -->
                        </div>
                    </div>

                    <!-- æœ‰æ°§è®­ç»ƒå‚æ•°ï¼ˆé»˜è®¤éšè—ï¼‰ -->
                    <div id="cardio-params" class="hidden mb-3">
                        <div class="h-14 bg-black dark:bg-black/80 rounded-xl px-4 flex items-center justify-between border border-gray-300 dark:border-zinc-800/60 relative group hover:border-[#A3FF00]/30 transition-colors">
                            <input type="number" id="config-duration" value="30" class="bg-transparent text-left text-3xl font-black text-gray-900 dark:text-white w-20 outline-none z-10 focus:text-[#A3FF00] transition-colors p-0 leading-none mt-[-2px]">
                            <span class="text-[9px] font-bold text-zinc-500 dark:text-zinc-600 uppercase tracking-widest shrink-0 text-right leading-tight">åˆ†é’Ÿ</span>
                        </div>
                    </div>

                    <!-- åŠ›é‡è®­ç»ƒçš„ç»„é—´æ­‡ï¼ˆæœ‰æ°§æ—¶ä¸æ˜¾ç¤ºï¼‰ -->
                    <div id="strength-rest" class="mb-3 relative">
                        <span class="absolute -top-2.5 left-3 px-2 bg-[#18181b] dark:bg-black text-[9px] font-bold text-zinc-500 dark:text-zinc-600 tracking-wider">ç»„é—´æ­‡</span>
                        <div class="flex gap-2 h-11 pt-1">
                            <button onclick="selectRest(60, this)" class="rest-btn flex-1 h-full rounded-xl bg-gray-200 dark:bg-zinc-800 text-sm font-bold text-zinc-700 dark:text-zinc-300 hover:bg-gray-300 dark:hover:bg-zinc-700 transition-colors duration-200 flex items-center justify-center">60s</button>
                            <button onclick="selectRest(90, this)" class="rest-btn flex-1 h-full rounded-xl bg-[#A3FF00]/10 text-sm font-bold text-[#A3FF00] border border-[#A3FF00]/50 transition-colors duration-200 flex items-center justify-center">90s</button>
                            <button onclick="selectRest(120, this)" class="rest-btn flex-1 h-full rounded-xl bg-gray-200 dark:bg-zinc-800 text-sm font-bold text-zinc-700 dark:text-zinc-300 hover:bg-gray-300 dark:hover:bg-zinc-700 transition-colors duration-200 flex items-center justify-center">120s</button>
                            <div class="flex-1 bg-gray-200 dark:bg-zinc-800 rounded-xl flex items-center justify-center relative h-full border border-transparent focus-within:border-gray-400 dark:focus-within:border-zinc-600 hover:bg-gray-300 dark:hover:bg-zinc-700 transition-colors">
                                <input type="number" id="config-rest-custom" placeholder="è‡ªå®šä¹‰" class="bg-transparent text-center w-full h-full text-sm font-bold text-gray-900 dark:text-white outline-none placeholder-zinc-500 dark:placeholder-zinc-500" oninput="onCustomRestInput()">
                            </div>
                        </div>
                    </div>

                    <button onclick="addFromCard()"
                        class="w-full h-11 rounded-xl bg-[#A3FF00] hover:bg-[#9add00] text-black font-black text-base shadow-[0_0_20px_rgba(163,255,0,0.15)] active:scale-[0.98] transition-colors duration-200 flex items-center justify-center gap-2">
                        <span>ç¡®è®¤æ·»åŠ </span>
                    </button>
                </div>
            </div>

            <!-- ä»Šæ—¥è®¡åˆ’åˆ—è¡¨ -->
            <div id="plan-list" class="space-y-4">
                <p id="empty-state" class="text-gray-500 dark:text-zinc-600 text-center py-8">
                    <p class="text-2xl mb-2">ğŸ“‹</p>
                    <p>å¼€å§‹æ·»åŠ ä½ çš„ç¬¬ä¸€ä¸ªè®­ç»ƒè®¡åˆ’</p>
                </p>
            </div>

            <!-- æ¸…ç©ºæŒ‰é’® -->
            <div id="clear-all-container" class="hidden mt-6 mb-8">
                <button id="clear-all-btn" class="w-full py-2.5 bg-gray-100 dark:bg-black/40 backdrop-blur-md border border-gray-200 dark:border-[#A3FF00]/10 text-gray-600 dark:text-zinc-400 font-semibold rounded-xl hover:bg-gray-200 dark:hover:bg-black/50 transition-colors duration-200 text-sm">
                    æ¸…ç©ºä»Šæ—¥è®¡åˆ’
                </button>
            </div>

        </div>
    </div>

    <!-- ============ æ—¥å†é¡µé¢ ============ -->
    <div id="tab-calendar" class="tab-content">
        <div class="min-h-screen p-4 bg-black">
            <div class="w-full max-w-md mx-auto">

                <h2 class="text-3xl font-black text-white mb-6">è®­ç»ƒæ—¥å†</h2>

                <!-- æœˆè§†å›¾ -->
                <div class="bg-black/60 backdrop-blur-2xl border border-[#A3FF00]/20 rounded-3xl p-6 mb-6">
                    <!-- æœˆä»½å¯¼èˆª -->
                    <div class="flex justify-between items-center mb-6">
                        <button id="prev-month" class="text-white p-2 hover:bg-white/5 rounded-lg transition-colors duration-200">
                            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"/>
                            </svg>
                        </button>
                        <h3 id="current-month" class="text-xl font-bold text-white">2024å¹´1æœˆ</h3>
                        <button id="next-month" class="text-white p-2 hover:bg-white/5 rounded-lg transition-colors duration-200">
                            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/>
                            </svg>
                        </button>
                    </div>

                    <!-- æ˜ŸæœŸæ ‡é¢˜ -->
                    <div class="grid grid-cols-7 gap-1 mb-2">
                        <div class="text-center text-gray-500 dark:text-zinc-500 text-xs font-semibold">ä¸€</div>
                        <div class="text-center text-gray-500 dark:text-zinc-500 text-xs font-semibold">äºŒ</div>
                        <div class="text-center text-gray-500 dark:text-zinc-500 text-xs font-semibold">ä¸‰</div>
                        <div class="text-center text-gray-500 dark:text-zinc-500 text-xs font-semibold">å››</div>
                        <div class="text-center text-gray-500 dark:text-zinc-500 text-xs font-semibold">äº”</div>
                        <div class="text-center text-gray-500 dark:text-zinc-500 text-xs font-semibold">å…­</div>
                        <div class="text-center text-gray-500 dark:text-zinc-500 text-xs font-semibold">æ—¥</div>
                    </div>

                    <!-- æ—¥æœŸç½‘æ ¼ -->
                    <div id="calendar-grid" class="grid grid-cols-7 gap-1">
                        <!-- åŠ¨æ€ç”Ÿæˆ -->
                    </div>
                </div>

                <!-- é€‰ä¸­æ—¥æœŸçš„è®­ç»ƒè¯¦æƒ… -->
                <div id="selected-date-workout" class="bg-black/60 backdrop-blur-2xl border border-[#A3FF00]/20 rounded-3xl p-6 hidden">
                    <h4 class="text-white font-bold mb-4" id="selected-date-title">1æœˆ15æ—¥</h4>
                    <div id="selected-date-content" class="space-y-3">
                        <!-- åŠ¨æ€ç”Ÿæˆ -->
                    </div>
                </div>

            </div>
        </div>
    </div>

    <!-- ============ æˆ‘çš„é¡µé¢ ============ -->
    <div id="tab-profile" class="tab-content">
        <div class="min-h-screen pt-[5px] pb-2 px-4 bg-black">
            <div class="w-full max-w-md mx-auto">

                <h2 class="text-3xl font-black text-white mb-6">æˆ‘çš„</h2>

                <!-- èº«ä½“æ•°æ® -->
                <div class="bg-black/60 backdrop-blur-2xl border border-[#A3FF00]/20 rounded-3xl p-6 mb-6">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-white font-bold">èº«ä½“æ•°æ®</h3>
                        <button id="edit-body-data-btn" class="text-[#A3FF00] text-sm font-semibold">ç¼–è¾‘</button>
                    </div>
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <p class="text-zinc-500 text-xs mb-1">ä½“é‡</p>
                            <p class="text-white text-2xl font-black"><span id="body-weight">--</span> kg</p>
                        </div>
                        <div>
                            <p class="text-zinc-500 text-xs mb-1">ä½“è„‚ç‡</p>
                            <p class="text-white text-2xl font-black"><span id="body-fat">--</span>%</p>
                        </div>
                    </div>
                </div>

                <!-- ç»„é—´ä¼‘æ¯è®¡æ—¶å™¨ -->
                <div class="bg-black/60 backdrop-blur-2xl border border-[#A3FF00]/20 rounded-3xl p-6 mb-6">
                    <h3 class="text-white font-bold mb-4">ç»„é—´ä¼‘æ¯è®¡æ—¶å™¨</h3>

                    <!-- æ—¶é—´é€‰æ‹© -->
                    <div class="flex gap-2 mb-6">
                        <button class="rest-time-btn flex-1 py-2 bg-black/40 backdrop-blur-md border border-[#A3FF00]/10 text-zinc-400 rounded-lg text-sm font-semibold transition-colors duration-200 hover:bg-black/50" data-time="60">60ç§’</button>
                        <button class="rest-time-btn flex-1 py-2 bg-[#A3FF00]/20 text-[#A3FF00] border border-[#A3FF00]/30 rounded-lg text-sm font-semibold transition-colors duration-200 hover:bg-[#A3FF00]/30" data-time="90">90ç§’</button>
                        <button class="rest-time-btn flex-1 py-2 bg-black/40 backdrop-blur-md border border-[#A3FF00]/10 text-zinc-400 rounded-lg text-sm font-semibold transition-colors duration-200 hover:bg-black/50" data-time="120">120ç§’</button>
                    </div>

                    <!-- è®¡æ—¶å™¨æ˜¾ç¤º -->
                    <div class="flex justify-center mb-6">
                        <div class="relative">
                            <svg class="progress-ring" width="150" height="150">
                                <circle class="text-zinc-800" stroke="currentColor" stroke-width="8" fill="transparent" r="65" cx="75" cy="75"/>
                                <circle id="rest-timer-ring" class="progress-ring__circle" stroke="#A3FF00" stroke-width="8" stroke-linecap="round" fill="transparent" r="65" cx="75" cy="75" stroke-dasharray="408.41" stroke-dashoffset="0"/>
                            </svg>
                            <div class="absolute inset-0 flex items-center justify-center">
                                <div id="rest-timer-display" class="text-4xl font-black text-white">90</div>
                            </div>
                        </div>
                    </div>

                    <!-- æ§åˆ¶æŒ‰é’® -->
                    <div class="flex gap-3">
                        <button id="start-timer-btn" class="flex-1 py-3 bg-[#A3FF00]/20 text-[#A3FF00] font-bold rounded-xl hover:bg-[#A3FF00]/30 transition-colors duration-200">
                            å¼€å§‹
                        </button>
                        <button id="reset-timer-btn" class="flex-1 py-3 bg-black/40 backdrop-blur-md border border-[#A3FF00]/10 text-zinc-400 font-semibold rounded-xl hover:bg-black/50 transition-colors duration-200">
                            é‡ç½®
                        </button>
                    </div>
                </div>

                <!-- PR è®°å½• -->
                <div class="bg-black/60 backdrop-blur-2xl border border-[#A3FF00]/20 rounded-3xl p-6 mb-6">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-white font-bold">ä¸ªäººè®°å½• (PR)</h3>
                    </div>
                    <div id="pr-list" class="space-y-3">
                        <p class="text-zinc-600 text-sm text-center py-4">æš‚æ— è®°å½•</p>
                    </div>
                </div>

            </div>
        </div>
    </div>

    <!-- ============ åº•éƒ¨å¯¼èˆªæ  ============ -->
    <nav class="fixed bottom-0 left-0 right-0 bg-black/80 backdrop-blur-2xl border-t border-[#A3FF00]/20 z-50 pb-safe pt-2">
        <div class="flex justify-around items-center h-16 px-4">

            <button class="nav-item group flex items-center gap-1 pl-4 pr-4 py-2.5 rounded-full transition-all duration-300 ease-[cubic-bezier(0.2,0.8,0.2,1)]" data-tab="workout">
                <svg class="w-6 h-6 transition-transform duration-300 group-[.nav-active]:scale-110" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M13 2L3 14H12L11 22L21 10H12L13 2Z"/>
                </svg>
                <span class="overflow-hidden w-0 opacity-0 group-[.nav-active]:w-auto group-[.nav-active]:opacity-100 group-[.nav-active]:ml-2 text-[15px] font-bold whitespace-nowrap transition-all duration-300">è®­ç»ƒ</span>
            </button>

            <button class="nav-item group flex items-center gap-1 pl-4 pr-4 py-2.5 rounded-full transition-all duration-300 ease-[cubic-bezier(0.2,0.8,0.2,1)]" data-tab="calendar">
                <svg class="w-6 h-6 transition-transform duration-300 group-[.nav-active]:scale-110" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
                    <rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect>
                    <line x1="16" y1="2" x2="16" y2="6"></line>
                    <line x1="8" y1="2" x2="8" y2="6"></line>
                    <line x1="3" y1="10" x2="21" y2="10"></line>
                </svg>
                <span class="overflow-hidden w-0 opacity-0 group-[.nav-active]:w-auto group-[.nav-active]:opacity-100 group-[.nav-active]:ml-2 text-[15px] font-bold whitespace-nowrap transition-all duration-300">æ—¥å†</span>
            </button>

            <button class="nav-item group flex items-center gap-1 pl-4 pr-4 py-2.5 rounded-full transition-all duration-300 ease-[cubic-bezier(0.2,0.8,0.2,1)]" data-tab="profile">
                <svg class="w-6 h-6 transition-transform duration-300 group-[.nav-active]:scale-110" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path>
                    <circle cx="12" cy="7" r="4"></circle>
                </svg>
                <span class="overflow-hidden w-0 opacity-0 group-[.nav-active]:w-auto group-[.nav-active]:opacity-100 group-[.nav-active]:ml-2 text-[15px] font-bold whitespace-nowrap transition-all duration-300">æˆ‘çš„</span>
            </button>

        </div>
    </nav>

    <!-- ============ è·Ÿç»ƒæ¨¡å¼ï¼ˆå…¨å±è¦†ç›–ï¼‰============ -->
    <div id="workout-mode" class="fixed inset-0 bg-white dark:bg-zinc-950 z-50 hidden flex flex-col">
        <div class="flex-1 flex flex-col items-center justify-center p-8">
            <h2 id="workout-exercise-name" class="text-5xl font-black mb-4 text-gray-900 dark:text-white">æ·±è¹²</h2>
            <p id="workout-target" class="text-gray-400 dark:text-zinc-400 text-xl">ç›®æ ‡ï¼š4ç»„ Ã— 10æ¬¡</p>
        </div>

        <!-- æœ¬ç»„æ•°æ®è¾“å…¥åŒº -->
        <div class="px-8 mb-6">
            <div class="flex items-center justify-center gap-4">
                <!-- é‡é‡è¾“å…¥ -->
                <div class="bg-gray-100 dark:bg-white/5 backdrop-blur-xl border-2 border-gray-200 dark:border-white/10 rounded-2xl px-6 py-4 flex-1 max-w-[180px]">
                    <p class="text-gray-500 dark:text-zinc-500 text-xs mb-1 text-center">é‡é‡ (kg)</p>
                    <input type="number" id="current-set-weight" class="w-full bg-transparent text-gray-900 dark:text-white text-4xl font-black text-center focus:outline-none" value="0" min="0" step="0.5">
                </div>

                <!-- æ¬¡æ•°è¾“å…¥ -->
                <div class="bg-gray-100 dark:bg-white/5 backdrop-blur-xl border-2 border-gray-200 dark:border-white/10 rounded-2xl px-6 py-4 flex-1 max-w-[180px]">
                    <p class="text-gray-500 dark:text-zinc-500 text-xs mb-1 text-center">æ¬¡æ•° (reps)</p>
                    <input type="number" id="current-set-reps" class="w-full bg-transparent text-gray-900 dark:text-white text-4xl font-black text-center focus:outline-none" value="10" min="1">
                </div>
            </div>
            <p id="weight-history-hint" class="text-gray-500 dark:text-zinc-600 text-sm text-center mt-3 hidden">
                ä¸Šä¸€ç»„: <span id="last-weight" class="text-[#A3FF00] font-semibold">0</span> kg
            </p>
        </div>

        <div class="text-center mb-8">
            <p class="text-gray-500 dark:text-zinc-500 text-sm mb-2">å·²å®Œæˆ</p>
            <p id="workout-progress" class="text-6xl font-black text-gray-900 dark:text-white">0 / 4</p>
        </div>

        <div class="p-8 pb-16">
            <button id="complete-set-btn" class="huge-btn w-full aspect-square max-w-sm mx-auto rounded-full bg-black dark:bg-[#A3FF00] text-white dark:text-black flex items-center justify-center shadow-sm dark:shadow-lg dark:shadow-[#A3FF00]/20">
                <span class="text-8xl font-black">+</span>
            </button>
            <p class="text-center text-neutral-500 dark:text-zinc-500 text-sm mt-6">ç‚¹å‡»å®Œæˆä¸€ç»„</p>
        </div>

        <button id="close-workout-btn" class="absolute top-4 right-4 w-12 h-12 bg-white dark:bg-white/5 border border-zinc-200 dark:border-white/10 rounded-full flex items-center justify-center text-gray-500 dark:text-zinc-400 hover:text-gray-700 dark:hover:text-white transition-colors duration-200">
            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
            </svg>
        </button>
    </div>

    <!-- ============ åŠ¨ä½œå®Œæˆè¦†ç›–å±‚============ -->
    <div id="exercise-complete-overlay" class="fixed inset-0 bg-black/90 dark:bg-black/95 z-[60] hidden flex-col items-center justify-center backdrop-blur-xl">
        <div class="text-center px-8">
            <div class="text-6xl mb-4">ğŸ‰</div>
            <h2 class="text-4xl font-black text-white mb-2">åŠ¨ä½œå®Œæˆï¼</h2>
            <p id="completed-exercise-name" class="text-gray-300 dark:text-zinc-400 text-xl mb-8">æ·±è¹²</p>

            <div class="space-y-3 max-w-sm mx-auto">
                <button id="next-exercise-btn" class="w-full py-4 bg-white dark:bg-[#A3FF00] text-black dark:text-black font-black text-xl rounded-xl hover:bg-zinc-100 dark:hover:bg-[#92E000] transition-colors duration-200">
                    ç»§ç»­ï¼šä¸‹ä¸€é¡¹
                </button>
                <button id="finish-exercise-btn" class="w-full py-4 bg-white/10 dark:bg-white/5 border border-white/20 dark:border-white/10 text-white font-semibold text-xl rounded-xl hover:bg-white/20 dark:hover:bg-white/10 transition-colors duration-200">
                    å®Œæˆ
                </button>
            </div>
        </div>
    </div>

    <!-- ============ å€’è®¡æ—¶è¦†ç›–å±‚ï¼ˆå…¨å±ï¼‰============ -->
    <div id="rest-timer-overlay" class="fixed inset-0 bg-zinc-950/95 z-60 hidden flex-col items-center justify-center backdrop-blur-xl">
        <div class="text-center">
            <p class="text-zinc-500 text-lg mb-4">ä¼‘æ¯ä¸­</p>
            <div id="timer-display" class="text-8xl font-black text-white dark:text-[#A3FF00] timer-pulse mb-8">01:30</div>

            <div class="flex gap-3 justify-center">
                <button id="skip-rest-btn" class="px-8 py-3 bg-white/5 border border-white/10 text-white font-semibold rounded-xl hover:bg-white/10 transition-colors duration-200">
                    è·³è¿‡
                </button>
                <button id="minimize-timer-btn" class="px-8 py-3 bg-white/5 border border-white/10 text-white font-semibold rounded-xl hover:bg-white/10 transition-colors duration-200 flex items-center gap-2">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7 7"/>
                    </svg>
                    ç¼©å°
                </button>
                <button id="add-30s-btn" class="px-8 py-3 bg-white/5 border border-white/10 text-white font-semibold rounded-xl hover:bg-white/10 transition-colors duration-200">
                    +30ç§’
                </button>
            </div>
        </div>
    </div>

    <!-- ============ å€’è®¡æ—¶æ‚¬æµ®æ¡ï¼ˆæœ€å°åŒ–ï¼‰============ -->
    <div id="rest-timer-bar" class="fixed bottom-0 left-0 right-0 z-50 hidden">
        <div class="backdrop-blur-md bg-zinc-900/95 border-t-2 border-[#A3FF00] px-6 py-3">
            <div class="flex items-center justify-between max-w-md mx-auto">
                <div class="flex items-center gap-4">
                    <div class="text-[#A3FF00]">
                        <svg class="w-6 h-6 animate-pulse" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/>
                        </svg>
                    </div>
                    <div>
                        <p class="text-zinc-400 text-xs">ä¼‘æ¯ä¸­</p>
                        <p id="timer-bar-display" class="text-white text-xl font-black">01:30</p>
                    </div>
                </div>
                <div class="flex items-center gap-2">
                    <button id="timer-bar-skip-btn" class="px-4 py-2 bg-white/10 text-zinc-300 text-sm font-semibold rounded-lg hover:bg-white/20 transition-colors duration-200">
                        è·³è¿‡
                    </button>
                    <button id="timer-bar-expand-btn" class="w-10 h-10 bg-[#A3FF00]/20 border border-[#A3FF00]/30 rounded-lg flex items-center justify-center">
                        <svg class="w-5 h-5 text-[#A3FF00]" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 15l7-7 7 7"/>
                        </svg>
                    </button>
                </div>
            </div>
            <!-- ä¸‹ä¸€ç»„é¢„å‘Š -->
            <div id="next-set-preview" class="text-center mt-2 text-zinc-400 text-xs hidden">
                ä¸‹ä¸€ç»„: <span class="text-[#A3FF00] font-semibold">110kg Ã— 8</span>
            </div>
        </div>
    </div>

    <!-- ============ V9.2 Symmetrical Crystal æ™ºèƒ½ä¼‘æ¯èƒ¶å›Š - å¯¹ç§°æ°´æ™¶ ============ -->
    <div id="smart-rest-capsule" class="fixed left-4 right-4 bottom-24 z-[100] hidden transition-all duration-500 ease-[cubic-bezier(0.32,0.72,0,1)] pb-[env(safe-area-inset-bottom)]">

        <div id="capsule-body" class="mx-auto max-w-[360px] h-[72px] bg-zinc-900/40 dark:bg-black/40 backdrop-blur-3xl border border-white/10 rounded-full shadow-[0_12px_40px_rgba(0,0,0,0.4)] flex items-center justify-center relative overflow-hidden transition-all duration-300">

            <!-- é¡¶éƒ¨é«˜å…‰çº¿ -->
            <div class="absolute inset-x-0 top-0 h-[1px] bg-gradient-to-r from-transparent via-white/20 to-transparent opacity-50"></div>

            <!-- CSS Grid 3åˆ—å¸ƒå±€ï¼šç»å¯¹å¯¹ç§° -->
            <div class="grid grid-cols-[1fr_auto_1fr] items-center w-full px-5 gap-4">

                <!-- å·¦ä¾§ï¼šå‡10ç§’æŒ‰é’® (é å³å¯¹é½) -->
                <div class="flex justify-end">
                    <button id="smart-rest-minus-btn" class="w-10 h-10 rounded-full bg-white/5 hover:bg-white/15 border border-white/5 active:scale-90 flex items-center justify-center transition-colors duration-200 text-white/60 hover:text-white group-hover:border-white/10">
                        <span class="text-[10px] font-bold tracking-tighter">-10</span>
                    </button>
                </div>

                <!-- ä¸­é—´ï¼šè®¡æ—¶å™¨ (ç»å¯¹å±…ä¸­) -->
                <div class="flex items-center justify-center min-w-[100px]">
                    <span id="smart-rest-timer" class="text-4xl font-black font-mono text-white tracking-widest drop-shadow-lg tabular-nums leading-none">00:00</span>
                </div>

                <!-- å³ä¾§ï¼šåŠ 10ç§’ + è·³è¿‡æŒ‰é’® (é å·¦å¯¹é½) -->
                <div class="flex items-center gap-3 justify-start">
                    <button id="smart-rest-plus-btn" class="w-10 h-10 rounded-full bg-white/5 hover:bg-white/15 border border-white/5 active:scale-90 flex items-center justify-center transition-colors duration-200 text-white/60 hover:text-white group-hover:border-white/10">
                        <span class="text-[10px] font-bold tracking-tighter">+10</span>
                    </button>

                    <button onclick="smartRestSkip()" id="smart-rest-skip-btn" class="w-8 h-8 rounded-full flex items-center justify-center text-white/40 hover:text-white hover:bg-white/10 transition-colors duration-200 active:scale-90" aria-label="Skip">
                        <svg class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2.5">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" />
                        </svg>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- ============ å®Œæˆåº†ç¥å¼¹çª— ============ -->
    <div id="celebration-overlay" class="fixed inset-0 bg-zinc-950/90 z-70 hidden flex items-center justify-center backdrop-blur-xl">
        <div class="text-center">
            <div class="text-6xl mb-4">ğŸ‰</div>
            <h3 id="celebration-text" class="text-3xl font-black mb-2 text-white">æ·±è¹²å®Œæˆï¼</h3>
            <p class="text-zinc-400 mb-8">å¹²å¾—æ¼‚äº®ï¼</p>
            <button id="celebration-ok-btn" class="px-12 py-3 bg-[#A3FF00]/20 text-[#A3FF00] font-bold rounded-xl hover:bg-[#A3FF00]/30 transition-colors duration-200">
                ç»§ç»­è®­ç»ƒ
            </button>
        </div>
    </div>

    <script>
        // ============ ä¸»é¢˜åˆ‡æ¢ç³»ç»Ÿ ============

        function initTheme() {
            // è¯»å–ä¿å­˜çš„ä¸»é¢˜åå¥½ï¼Œé»˜è®¤ä½¿ç”¨æ·±è‰²æ¨¡å¼
            const savedTheme = localStorage.getItem('ironlog_theme');
            const isDark = savedTheme === null ? true : savedTheme === 'dark';

            const html = document.documentElement;
            if (isDark) {
                html.classList.add('dark');
            } else {
                html.classList.remove('dark');
            }

            // è®¾ç½®å›¾æ ‡
            const icon = document.getElementById('theme-icon');
            if (icon) {
                icon.textContent = isDark ? 'ğŸŒ™' : 'â˜€ï¸';
            }
        }

        function toggleTheme() {
            const html = document.documentElement;
            const isDark = html.classList.contains('dark');

            if (isDark) {
                html.classList.remove('dark');
                localStorage.setItem('ironlog_theme', 'light');
                document.getElementById('theme-icon').textContent = 'â˜€ï¸';
            } else {
                html.classList.add('dark');
                localStorage.setItem('ironlog_theme', 'dark');
                document.getElementById('theme-icon').textContent = 'ğŸŒ™';
            }
        }

        // ============ æ™ºèƒ½ä¼¸ç¼©ä»ªè¡¨ç›˜ ============

        function toggleDashboard(shouldExpand) {
            const collapsed = document.getElementById('dashboard-collapsed');
            const expanded = document.getElementById('dashboard-expanded');

            if (shouldExpand) {
                // å±•å¼€ä»ªè¡¨ç›˜
                collapsed.classList.add('hidden');
                expanded.classList.remove('hidden');
                expanded.classList.add('animate-slide-down');

                // èšç„¦åˆ°è¾“å…¥æ¡†
                setTimeout(() => {
                    document.getElementById('exercise-name')?.focus();
                }, 100);
            } else {
                // æ”¶èµ·ä»ªè¡¨ç›˜
                expanded.classList.add('hidden');
                expanded.classList.remove('animate-slide-down');
                collapsed.classList.remove('hidden');
            }
        }

        function autoUpdateDashboardState() {
            const plan = getTodaysPlan();
            const collapsed = document.getElementById('dashboard-collapsed');
            const expanded = document.getElementById('dashboard-expanded');

            // è‡ªåŠ¨åˆ¤æ–­ï¼šæ— è®¡åˆ’æ—¶å±•å¼€ï¼Œæœ‰è®¡åˆ’æ—¶æ”¶èµ·
            if (plan && plan.length > 0) {
                // æœ‰è®¡åˆ’ï¼šæ˜¾ç¤ºæ”¶èµ·æ€
                collapsed.classList.remove('hidden');
                expanded.classList.add('hidden');
            } else {
                // æ— è®¡åˆ’ï¼šæ˜¾ç¤ºå±•å¼€æ€
                collapsed.classList.add('hidden');
                expanded.classList.remove('hidden');
            }
        }

        // ============ ç´§å‡‘è¾“å…¥æ§åˆ¶å° ============

        let inputState = {
            selectedType: 'strength',
            selectedRestTime: 90
        };

        // å…¨å±€å‡½æ•°ï¼šç‚¹å‡»é¢„è®¾æŒ‰é’®æ—¶å¡«å…¥è¾“å…¥æ¡†ï¼ˆæå‰å®šä¹‰ï¼Œé¿å… onclick æ—¶æœªå®šä¹‰ï¼‰
        window.setCustomRest = function(seconds) {
            inputState.selectedRestTime = seconds;
            const currentType = inputState.selectedType;
            const customInput = currentType === 'strength'
                ? document.getElementById('custom-rest-input')
                : document.getElementById('custom-rest-input-cardio');

            if (customInput) {
                customInput.value = seconds;
                customInput.parentElement.classList.add('scale-95');
                setTimeout(() => customInput.parentElement.classList.remove('scale-95'), 100);
            }
            updateRestTimeButtons();
        };

        function initInputConsole() {
            // ç±»å‹åˆ‡æ¢ - æ·»åŠ  null æ£€æŸ¥
            const typeStrengthBtn = document.getElementById('type-strength');
            const typeCardioBtn = document.getElementById('type-cardio');

            if (typeStrengthBtn) {
                typeStrengthBtn.addEventListener('click', function() {
                    inputState.selectedType = 'strength';
                    updateTypeButtons();
                    updateSettingsVisibility();
                });
            }

            if (typeCardioBtn) {
                typeCardioBtn.addEventListener('click', function() {
                    inputState.selectedType = 'cardio';
                    updateTypeButtons();
                    updateSettingsVisibility();
                });
            }

            // ä¼‘æ¯æ—¶é—´é€‰æ‹©ï¼ˆé¢„è®¾æŒ‰é’®ï¼‰
            document.querySelectorAll('.rest-time-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    inputState.selectedRestTime = parseInt(this.dataset.time);
                    updateRestTimeButtons();
                });
            });

            // å…¨å±€å‡½æ•°ï¼šè·³è¿‡ä¼‘æ¯
            window.smartRestSkip = function() {
                if (smartRestTimerInterval) {
                    clearInterval(smartRestTimerInterval);
                    smartRestTimerInterval = null;
                    const capsule = document.getElementById('smart-rest-capsule');
                    const capsuleBody = document.getElementById('capsule-body');
                    const timerDisplay = document.getElementById('smart-rest-timer');
                    capsule.classList.add('hidden');
                    // é‡ç½®æ ·å¼ï¼ˆæ¢å¤å¯¹ç§°æ°´æ™¶ï¼‰
                    capsuleBody.classList.remove('border-orange-500/80', 'shadow-[0_0_40px_rgba(249,115,22,0.6)]', 'animate-pulse-fast');
                    capsuleBody.classList.add('border-white/10');
                    timerDisplay.classList.remove('text-orange-400');
                }
            };

            // å…¨å±€å‡½æ•°ï¼šè°ƒæ•´ä¼‘æ¯æ—¶é—´
            window.adjustRestTime = function(delta) {
                if (smartRestTimeLeft > 0) {
                    smartRestTimeLeft += delta;
                    // é™åˆ¶æœ€å°å€¼ä¸º 10 ç§’
                    if (smartRestTimeLeft < 10) smartRestTimeLeft = 10;
                    // åŒæ­¥æ›´æ–°åˆå§‹æ—¶é•¿ï¼Œé¿å…è¿›åº¦æ¡è·³åŠ¨
                    if (delta > 0) {
                        smartRestInitialDuration += delta;
                    } else {
                        smartRestInitialDuration = Math.max(smartRestInitialDuration + delta, smartRestTimeLeft);
                    }
                    updateSmartRestTimerDisplay();
                    if (navigator.vibrate) {
                        navigator.vibrate(10);
                    }
                }
            };

            // è‡ªå®šä¹‰è¾“å…¥æ¡† - åŠ›é‡è®­ç»ƒ
            const customRestInput = document.getElementById('custom-rest-input');
            if (customRestInput) {
                customRestInput.addEventListener('input', function() {
                    const value = parseInt(this.value) || 90;
                    inputState.selectedRestTime = Math.min(Math.max(value, 10), 600); // é™åˆ¶åœ¨ 10-600 ç§’
                    // æ¸…é™¤æŒ‰é’®çš„é€‰ä¸­çŠ¶æ€
                    document.querySelectorAll('.rest-time-btn').forEach(btn => {
                        btn.classList.remove('bg-black', 'dark:bg-[#A3FF00]', 'text-white', 'dark:text-black', 'border-transparent');
                        btn.classList.add('bg-gray-100', 'dark:bg-zinc-800', 'border-zinc-200', 'dark:border-white/5', 'text-gray-500', 'dark:text-zinc-400');
                    });
                });
            }

            // è‡ªå®šä¹‰è¾“å…¥æ¡† - æœ‰æ°§è®­ç»ƒ
            const customRestInputCardio = document.getElementById('custom-rest-input-cardio');
            if (customRestInputCardio) {
                customRestInputCardio.addEventListener('input', function() {
                    const value = parseInt(this.value) || 90;
                    inputState.selectedRestTime = Math.min(Math.max(value, 10), 600); // é™åˆ¶åœ¨ 10-600 ç§’
                    // æ¸…é™¤æŒ‰é’®çš„é€‰ä¸­çŠ¶æ€
                    document.querySelectorAll('.rest-time-btn').forEach(btn => {
                        btn.classList.remove('bg-black', 'dark:bg-[#A3FF00]', 'text-white', 'dark:text-black', 'border-transparent');
                        btn.classList.add('bg-gray-100', 'dark:bg-zinc-800', 'border-zinc-200', 'dark:border-white/5', 'text-gray-500', 'dark:text-zinc-400');
                    });
                });
            }

            // åŠ›é‡è®­ç»ƒæ·»åŠ æŒ‰é’®ï¼ˆæ—§æ§åˆ¶å°ï¼Œå¯èƒ½ä¸å­˜åœ¨ï¼‰
            const addExerciseBtn = document.getElementById('add-exercise-btn');
            if (addExerciseBtn) {
                addExerciseBtn.addEventListener('click', function() {
                    addExercise();
                });
            }

            // æœ‰æ°§è®­ç»ƒæ·»åŠ æŒ‰é’®ï¼ˆæ—§æ§åˆ¶å°ï¼Œå¯èƒ½ä¸å­˜åœ¨ï¼‰
            const addCardioBtn = document.getElementById('add-cardio-btn');
            if (addCardioBtn) {
                addCardioBtn.addEventListener('click', function() {
                    addExercise();
                });
            }

            // å›è½¦æ·»åŠ ï¼ˆæ—§æ§åˆ¶å°ï¼Œå¯èƒ½ä¸å­˜åœ¨ï¼‰
            const exerciseNameInput = document.getElementById('exercise-name');
            if (exerciseNameInput) {
                exerciseNameInput.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter') {
                        addExercise();
                    }
                });
            }
        }

        function updateTypeButtons() {
            const strengthBtn = document.getElementById('type-strength');
            const cardioBtn = document.getElementById('type-cardio');

            if (inputState.selectedType === 'strength') {
                strengthBtn.classList.remove('text-zinc-500');
                strengthBtn.classList.add('bg-zinc-700', 'text-white');
                cardioBtn.classList.remove('bg-zinc-700', 'text-white');
                cardioBtn.classList.add('text-zinc-500');
            } else {
                cardioBtn.classList.remove('text-zinc-500');
                cardioBtn.classList.add('bg-zinc-700', 'text-white');
                strengthBtn.classList.remove('bg-zinc-700', 'text-white');
                strengthBtn.classList.add('text-zinc-500');
            }
        }

        function updateRestTimeButtons() {
            document.querySelectorAll('.rest-time-btn').forEach(btn => {
                const time = parseInt(btn.dataset.time);
                if (time === inputState.selectedRestTime) {
                    // é€‰ä¸­çŠ¶æ€ï¼šæµ…è‰²æ¨¡å¼é»‘è‰²ï¼Œæ·±è‰²æ¨¡å¼è§å…‰ç»¿
                    btn.classList.remove('bg-gray-100', 'dark:bg-zinc-800', 'border-zinc-200', 'dark:border-white/5', 'text-gray-500', 'dark:text-zinc-400');
                    btn.classList.add('bg-black', 'dark:bg-[#A3FF00]', 'text-white', 'dark:text-black', 'border-transparent');
                } else {
                    // æœªé€‰ä¸­çŠ¶æ€ï¼šæµ…è‰²æ¨¡å¼ç™½è‰²+è¾¹æ¡†ï¼Œæ·±è‰²æ¨¡å¼æ·±ç°
                    btn.classList.remove('bg-black', 'dark:bg-[#A3FF00]', 'text-white', 'dark:text-black', 'border-transparent');
                    btn.classList.add('bg-gray-100', 'dark:bg-zinc-800', 'border-zinc-200', 'dark:border-white/5', 'text-gray-500', 'dark:text-zinc-400');
                }
            });
        }

        function updateSettingsVisibility() {
            const strengthSettings = document.getElementById('strength-settings');
            const cardioSettings = document.getElementById('cardio-settings');

            if (inputState.selectedType === 'strength') {
                strengthSettings.classList.remove('hidden');
                cardioSettings.classList.add('hidden');
            } else {
                strengthSettings.classList.add('hidden');
                cardioSettings.classList.remove('hidden');
            }
        }

        function addExercise() {
            const nameInput = document.getElementById('exercise-name');
            const name = nameInput.value.trim();

            if (!name) {
                alert('è¯·è¾“å…¥åŠ¨ä½œåç§°');
                return;
            }

            const plan = getTodaysPlan();
            const newExercise = {
                id: generateId(),
                name: name,
                type: inputState.selectedType,
                restTime: inputState.selectedRestTime
            };

            if (inputState.selectedType === 'strength') {
                newExercise.targetSets = parseInt(document.getElementById('target-sets').value) || 4;
                newExercise.reps = parseInt(document.getElementById('target-reps').value) || 10;
                newExercise.initialWeight = parseFloat(document.getElementById('target-weight').value) || 0;
                newExercise.doneSets = 0;
                newExercise.weightLogs = [];
                newExercise.plannedSets = null;
            } else {
                newExercise.duration = parseInt(document.getElementById('target-duration').value) || 30;
                newExercise.completed = false;
            }

            plan.push(newExercise);
            saveTodaysPlan(plan);
            updateUI();

            // é‡ç½®è¾“å…¥æ¡†
            nameInput.value = '';
            document.getElementById('target-sets').value = '4';
            document.getElementById('target-reps').value = '10';
            document.getElementById('target-weight').value = '0';
            document.getElementById('target-duration').value = '30';
            nameInput.focus();
        }

        // ============ V25/V26 Fusion Data Management ============

        // Global State
        let todayPlans = [];
        const STORAGE_KEY = 'ironlog_today_plans';

        // Initialize
        function initApp() {
            // ä¼˜å…ˆä»æ–°ç³»ç»ŸåŠ è½½ï¼Œå¦‚æœæ²¡æœ‰åˆ™å°è¯•ä»æ—§ç³»ç»ŸåŠ è½½
            let saved = localStorage.getItem(STORAGE_KEY);

            // å¦‚æœæ–°ç³»ç»Ÿæ²¡æœ‰æ•°æ®ï¼Œå°è¯•ä»æ—§ç³»ç»Ÿè¯»å–
            if (!saved) {
                const today = new Date().toDateString();
                saved = localStorage.getItem('ironlog_plan_' + today);
            }

            if (saved) {
                try {
                    todayPlans = JSON.parse(saved);
                    // åŒæ—¶ä¿å­˜åˆ°æ–°ç³»ç»Ÿï¼Œç¡®ä¿æ•°æ®åŒæ­¥
                    localStorage.setItem(STORAGE_KEY, saved);
                } catch(e) {
                    console.error("Data parse error", e);
                    todayPlans = [];
                }
            }
            renderTodayPlan();

            // æ ¹æ®æ˜¯å¦æœ‰åŠ¨ä½œæ¥è®¾ç½®æ§åˆ¶é¢æ¿åˆå§‹çŠ¶æ€
            initControlPanelState();
        }

        // åˆå§‹åŒ–æ§åˆ¶é¢æ¿çŠ¶æ€
        function initControlPanelState() {
            const container = document.getElementById('add-container');
            const trigger = document.getElementById('add-trigger');
            const panel = document.getElementById('add-panel');
            const clearAllContainer = document.getElementById('clear-all-container');

            if (todayPlans.length === 0) {
                // æ²¡æœ‰åŠ¨ä½œï¼šé»˜è®¤å±•å¼€
                container.style.maxHeight = '600px';
                trigger.classList.add('hidden');
                panel.classList.remove('hidden');
                panel.style.opacity = '1';
                panel.style.transform = 'translateY(0) scale(1)';
                // å»¶è¿Ÿèšç„¦
                setTimeout(() => {
                    document.getElementById('config-name').focus();
                }, 300);

                // éšè—æ¸…ç©ºæŒ‰é’®
                if (clearAllContainer) {
                    clearAllContainer.classList.add('hidden');
                }
            } else {
                // æœ‰åŠ¨ä½œï¼šé»˜è®¤æ”¶èµ·
                container.style.maxHeight = '48px';
                trigger.classList.remove('hidden');
                panel.classList.add('hidden');
                panel.style.opacity = '0';

                // æ˜¾ç¤ºæ¸…ç©ºæŒ‰é’®
                if (clearAllContainer) {
                    clearAllContainer.classList.remove('hidden');
                }
            }
        }

        // Save Data
        function saveData() {
            localStorage.setItem(STORAGE_KEY, JSON.stringify(todayPlans));
        }

        // Compatibility functions for old code
        function getTodaysPlan() {
            return todayPlans;
        }

        function saveTodaysPlan(plan) {
            todayPlans = plan;
            saveData();
        }

        // æ›´æ–°UIï¼ˆå…¼å®¹æ—§ä»£ç ï¼‰
        function updateUI() {
            renderTodayPlan();
        }

        function renderPlanList(plan) {
            todayPlans = plan;
            renderTodayPlan();
        }

        // Delete Plan
        function deletePlan(index) {
            if (confirm("ç¡®å®šè¦åˆ é™¤è¿™ä¸ªåŠ¨ä½œå—ï¼Ÿ")) {
                todayPlans.splice(index, 1);
                saveData();
                renderTodayPlan();

                // å¦‚æœåˆ é™¤åæ²¡æœ‰åŠ¨ä½œäº†ï¼Œè‡ªåŠ¨å±•å¼€æ§åˆ¶é¢æ¿
                if (todayPlans.length === 0) {
                    initControlPanelState();
                }
            }
        }

        // === V25 Pure: Quick Add Mode (No Modal) ===

        // Quick add: Instantly creates a default exercise and expands it
        function quickAddPlan() {
            // 1. Create a default empty exercise
            const defaultPlan = {
                id: Date.now(),
                name: "æ–°åŠ¨ä½œ", // Default name
                weight: 20,     // Default weight
                targetSets: 4,  // Default 4 sets
                reps: 10,       // Default 10 reps
                doneSets: 0,
                completed: false,
                isStarted: false,
                isDetailsOpen: true, // Auto-expand after adding, convenient for editing
                setsDetails: [] // Initialize empty array
            };

            // 2. Auto-generate 4 sets of default data
            for (let i = 0; i < defaultPlan.targetSets; i++) {
                defaultPlan.setsDetails.push({
                    weight: defaultPlan.weight,
                    reps: defaultPlan.reps,
                    completed: false
                });
            }

            // 3. Add directly to list
            todayPlans.push(defaultPlan);
            saveData();
            renderTodayPlan();

            // 4. Scroll to bottom
            setTimeout(() => {
                window.scrollTo({ top: document.body.scrollHeight, behavior: 'smooth' });
                // Vibration feedback
                if(navigator.vibrate) navigator.vibrate(30);
            }, 300);
        }

        // === æ·±é‚ƒé»‘é‡‘æ§åˆ¶å°æ ¸å¿ƒé€»è¾‘ ===

        let selectedRestTime = 90;
        let selectedExerciseType = 'strength'; // é»˜è®¤åŠ›é‡
        let isAdvancedSetsOpen = false; // è¯¦ç»†è®¾ç½®å±•å¼€çŠ¶æ€

        // åˆ‡æ¢è¯¦ç»†è®¾ç½®é¢æ¿
        function toggleAdvancedSets() {
            isAdvancedSetsOpen = !isAdvancedSetsOpen;
            const container = document.getElementById('advanced-sets-container');
            const chevron = document.getElementById('advanced-chevron');

            if (isAdvancedSetsOpen) {
                container.classList.remove('hidden');
                chevron.style.transform = 'rotate(180deg)';
                updateSetsDetails(); // ç”Ÿæˆç»„åˆ—è¡¨
            } else {
                container.classList.add('hidden');
                chevron.style.transform = 'rotate(0deg)';
            }
        }

        // æ›´æ–°ç»„æ•°è¯¦ç»†åˆ—è¡¨
        function updateSetsDetails() {
            const sets = parseInt(document.getElementById('config-sets').value) || 4;
            const defaultReps = parseInt(document.getElementById('config-reps').value) || 10;
            const defaultWeight = parseFloat(document.getElementById('config-weight').value) || 0;
            const listContainer = document.getElementById('sets-details-list');

            if (!listContainer) return;

            listContainer.innerHTML = '';

            for (let i = 0; i < sets; i++) {
                const setHtml = `
                    <div class="flex items-center gap-2 bg-gray-100 dark:bg-zinc-900 rounded-lg p-2">
                        <span class="text-xs font-bold text-zinc-500 w-8">ç¬¬${i + 1}ç»„</span>
                        <div class="flex-1 flex gap-2">
                            <div class="flex-1 bg-white dark:bg-zinc-800 rounded px-2 flex items-center border border-gray-200 dark:border-zinc-700">
                                <input type="number" class="set-weight w-full bg-transparent text-sm font-bold text-gray-900 dark:text-white outline-none" value="${defaultWeight}" placeholder="é‡é‡">
                                <span class="text-[9px] text-zinc-500">KG</span>
                            </div>
                            <div class="flex-1 bg-white dark:bg-zinc-800 rounded px-2 flex items-center border border-gray-200 dark:border-zinc-700">
                                <input type="number" class="set-reps w-full bg-transparent text-sm font-bold text-gray-900 dark:text-white outline-none" value="${defaultReps}" placeholder="æ¬¡æ•°">
                                <span class="text-[9px] text-zinc-500">æ¬¡</span>
                            </div>
                        </div>
                    </div>
                `;
                listContainer.innerHTML += setHtml;
            }
        }

        // åˆ‡æ¢è¿åŠ¨ç±»å‹
        function selectExerciseType(type) {
            selectedExerciseType = type;
            const strengthBtn = document.getElementById('type-strength');
            const cardioBtn = document.getElementById('type-cardio');
            const strengthParams = document.getElementById('strength-params');
            const cardioParams = document.getElementById('cardio-params');
            const strengthRest = document.getElementById('strength-rest');
            const advancedSetsBtn = document.getElementById('advanced-sets-btn-container');
            const advancedSetsContainer = document.getElementById('advanced-sets-container');

            if (type === 'strength') {
                // æŒ‰é’®æ ·å¼
                strengthBtn.className = "px-3 h-full text-[10px] font-bold text-white dark:text-black bg-gray-900 dark:bg-[#A3FF00] rounded-full flex items-center transition-colors duration-200";
                cardioBtn.className = "px-3 h-full text-[10px] font-bold text-zinc-500 dark:text-zinc-400 rounded-full hover:text-zinc-300 dark:hover:text-zinc-200 transition-colors duration-200 flex items-center";

                // æ˜¾ç¤º/éšè—å‚æ•°åŒºåŸŸ
                strengthParams.classList.remove('hidden');
                cardioParams.classList.add('hidden');
                strengthRest.classList.remove('hidden');

                // æ˜¾ç¤ºè¯¦ç»†è®¾ç½®æŒ‰é’®ï¼ˆåŠ›é‡è®­ç»ƒéœ€è¦ï¼‰
                if (advancedSetsBtn) advancedSetsBtn.classList.remove('hidden');
                // æ”¶èµ·è¯¦ç»†è®¾ç½®é¢æ¿
                if (advancedSetsContainer) {
                    advancedSetsContainer.classList.add('hidden');
                    isAdvancedSetsOpen = false;
                    const chevron = document.getElementById('advanced-chevron');
                    if (chevron) chevron.style.transform = 'rotate(0deg)';
                }
            } else {
                // æŒ‰é’®æ ·å¼
                strengthBtn.className = "px-3 h-full text-[10px] font-bold text-zinc-500 dark:text-zinc-400 rounded-full hover:text-zinc-300 dark:hover:text-zinc-200 transition-colors duration-200 flex items-center";
                cardioBtn.className = "px-3 h-full text-[10px] font-bold text-white dark:text-black bg-gray-900 dark:bg-[#A3FF00] rounded-full flex items-center transition-colors duration-200";

                // æ˜¾ç¤º/éšè—å‚æ•°åŒºåŸŸ
                strengthParams.classList.add('hidden');
                cardioParams.classList.remove('hidden');
                strengthRest.classList.add('hidden');

                // éšè—è¯¦ç»†è®¾ç½®æŒ‰é’®ï¼ˆæœ‰æ°§è®­ç»ƒä¸éœ€è¦ï¼‰
                if (advancedSetsBtn) advancedSetsBtn.classList.add('hidden');
                // éšè—è¯¦ç»†è®¾ç½®é¢æ¿
                if (advancedSetsContainer) {
                    advancedSetsContainer.classList.add('hidden');
                    isAdvancedSetsOpen = false;
                    const chevron = document.getElementById('advanced-chevron');
                    if (chevron) chevron.style.transform = 'rotate(0deg)';
                }
            }
        }

        // 1. åˆ‡æ¢é¢æ¿ (é«˜çº§ä¸æ»‘åŠ¨ç”»)
        function toggleAddPanel(isOpen) {
            const container = document.getElementById('add-container');
            const trigger = document.getElementById('add-trigger');
            const panel = document.getElementById('add-panel');

            if (isOpen) {
                // å±•å¼€ï¼šå…ˆéšè—è§¦å‘å™¨ï¼Œç„¶ååŒæ­¥å±•å¼€é«˜åº¦å’Œæ·¡å…¥å†…å®¹
                trigger.classList.add('hidden');

                // è®¾ç½®åˆå§‹çŠ¶æ€
                panel.classList.remove('hidden');
                panel.style.opacity = '0';
                panel.style.transform = 'translateY(-8px) scale(0.98)';

                // å…ˆå¼€å§‹é«˜åº¦å±•å¼€
                container.style.transition = 'max-height 0.4s cubic-bezier(0.16, 1, 0.3, 1)';
                container.style.maxHeight = '600px';

                // ç¨åå¼€å§‹å†…å®¹æ·¡å…¥ï¼Œè®©é«˜åº¦å…ˆå±•å¼€ä¸€éƒ¨åˆ†
                requestAnimationFrame(() => {
                    setTimeout(() => {
                        panel.style.transition = 'opacity 0.35s cubic-bezier(0.16, 1, 0.3, 1), transform 0.35s cubic-bezier(0.16, 1, 0.3, 1)';
                        panel.style.opacity = '1';
                        panel.style.transform = 'translateY(0) scale(1)';

                        setTimeout(() => {
                            document.getElementById('config-name').focus();
                        }, 150);
                    }, 50);
                });

            } else {
                // æ”¶èµ·ï¼šåŒæ­¥æ·¡å‡ºã€ä¸Šç§»å’Œé«˜åº¦æ”¶ç¼©
                panel.style.transition = 'opacity 0.3s cubic-bezier(0.4, 0, 1, 1), transform 0.3s cubic-bezier(0.4, 0, 1, 1)';
                panel.style.opacity = '0';
                panel.style.transform = 'translateY(-8px) scale(0.98)';

                // ç¨åå¼€å§‹æ”¶èµ·é«˜åº¦ï¼Œè®©æ·¡å‡ºåŠ¨ç”»å…ˆè¿›è¡Œä¸€éƒ¨åˆ†
                setTimeout(() => {
                    container.style.transition = 'max-height 0.35s cubic-bezier(0.4, 0, 1, 1)';
                    container.style.maxHeight = '48px';
                }, 50);

                // ç­‰å¾…åŠ¨ç”»å®Œæˆåé‡ç½®
                setTimeout(() => {
                    panel.classList.add('hidden');
                    trigger.classList.remove('hidden');
                    panel.style.transform = '';
                }, 350);
            }
        }

        // 2. ç»„é—´æ­‡é€‰æ‹©å™¨ (ç²¾è‡´èƒ¶å›Šæ ·å¼)
        function selectRest(time, btn) {
            selectedRestTime = time;
            // æ¸…é™¤è‡ªå®šä¹‰è¾“å…¥æ¡†
            document.getElementById('config-rest-custom').value = '';
            document.querySelectorAll('.rest-btn').forEach(b => {
                b.className = "rest-btn flex-1 h-full rounded-xl bg-gray-200 dark:bg-zinc-800 text-sm font-bold text-zinc-700 dark:text-zinc-300 hover:bg-gray-300 dark:hover:bg-zinc-700 transition-colors duration-200 flex items-center justify-center";
            });
            btn.className = "rest-btn flex-1 h-full rounded-xl bg-[#A3FF00]/10 text-sm font-bold text-[#A3FF00] border border-[#A3FF00]/50 transition-colors duration-200 flex items-center justify-center";
        }

        // è‡ªå®šä¹‰ç»„é—´æ­‡è¾“å…¥æ—¶æ¸…é™¤é¢„è®¾æŒ‰é’®é€‰ä¸­çŠ¶æ€
        function onCustomRestInput() {
            document.querySelectorAll('.rest-btn').forEach(b => {
                b.className = "rest-btn flex-1 h-full rounded-xl bg-gray-200 dark:bg-zinc-800 text-sm font-bold text-zinc-700 dark:text-zinc-300 hover:bg-gray-300 dark:hover:bg-zinc-700 transition-colors duration-200 flex items-center justify-center";
            });
        }

        // è®°å½•æ–°æ·»åŠ çš„å¡ç‰‡IDï¼Œç”¨äºåŠ¨ç”»
        let newlyAddedCardId = null;

        // 3. ä»æ§åˆ¶å°æ·»åŠ åŠ¨ä½œ
        function addFromCard() {
            const nameInput = document.getElementById('config-name');
            const name = nameInput.value;

            if (!name) {
                nameInput.focus();
                nameInput.classList.add('animate-pulse');
                setTimeout(() => nameInput.classList.remove('animate-pulse'), 500);
                return;
            }

            const type = selectedExerciseType || 'strength';
            let newPlan;

            if (type === 'cardio') {
                // æœ‰æ°§è¿åŠ¨ï¼šåªè®°å½•æ—¶é•¿
                const duration = parseInt(document.getElementById('config-duration').value) || 30;

                newPlan = {
                    id: Date.now(),
                    name: name,
                    type: 'cardio',
                    duration: duration, // åˆ†é’Ÿ
                    completed: false,
                    isStarted: false,
                    isDetailsOpen: false
                };
            } else {
                // åŠ›é‡è®­ç»ƒï¼šè®°å½•ç»„æ•°æ¬¡æ•°é‡é‡
                const sets = parseInt(document.getElementById('config-sets').value) || 4;
                const reps = parseInt(document.getElementById('config-reps').value) || 10;
                const weight = parseFloat(document.getElementById('config-weight').value) || 0;

                // æ£€æŸ¥è‡ªå®šä¹‰ç»„é—´æ­‡
                const customRestInput = document.getElementById('config-rest-custom');
                let restTime = selectedRestTime;
                if (customRestInput.value && customRestInput.value > 0) {
                    restTime = parseInt(customRestInput.value);
                }

                // ç”Ÿæˆæ•°æ® - ä¼˜å…ˆä»è¯¦ç»†è®¾ç½®è¯»å–ï¼Œå¦åˆ™ä½¿ç”¨é»˜è®¤å€¼
                const setsDetails = [];
                const weightInputs = document.querySelectorAll('.set-weight');
                const repsInputs = document.querySelectorAll('.set-reps');

                for (let i = 0; i < sets; i++) {
                    let setWeight = weight;
                    let setReps = reps;

                    // å¦‚æœè¯¦ç»†è®¾ç½®ä¸­æœ‰å€¼ï¼Œä½¿ç”¨è¯¦ç»†è®¾ç½®çš„å€¼
                    if (weightInputs[i] && weightInputs[i].value !== '') {
                        setWeight = parseFloat(weightInputs[i].value) || weight;
                    }
                    if (repsInputs[i] && repsInputs[i].value !== '') {
                        setReps = parseInt(repsInputs[i].value) || reps;
                    }

                    setsDetails.push({ weight: setWeight, reps: setReps, completed: false });
                }

                newPlan = {
                    id: Date.now(),
                    name: name,
                    type: 'strength',
                    weight: setsDetails[0]?.weight || weight,
                    initialWeight: setsDetails[0]?.weight || weight,
                    targetSets: sets,
                    reps: setsDetails[0]?.reps || reps,
                    restTime: restTime,
                    doneSets: 0,
                    completed: false,
                    isStarted: false,
                    isDetailsOpen: false,
                    setsDetails: setsDetails
                };
            }

            todayPlans.push(newPlan);
            newlyAddedCardId = newPlan.id; // è®°å½•æ–°æ·»åŠ çš„ID
            saveData();
            renderTodayPlan();

            // é‡ç½®è¾“å…¥æ¡†
            nameInput.value = '';
            if (type === 'strength') {
                const customRestInput = document.getElementById('config-rest-custom');
                if (customRestInput) customRestInput.value = '';
            }

            // æ”¶èµ·é¢æ¿
            toggleAddPanel(false);

            // æ»šåŠ¨åˆ°åº•éƒ¨
            setTimeout(() => {
                window.scrollTo({ top: document.body.scrollHeight, behavior: 'smooth' });
            }, 300);
        }

        // æ—§ç‰ˆæœ¬å…¼å®¹å‡½æ•°
        function toggleAdvancedCreator(show) {
            toggleAddPanel(show);
        }

        function addFromAdvancedCreator() {
            addFromCard();
        }

        // Helper functions for exercise management

        // Start Training (Simple Toggle)
        function startExercise(id) {
            console.log('[StartExercise] å¼€å§‹è®­ç»ƒï¼Œid:', id);
            const exercise = todayPlans.find(p => p.id === id);
            console.log('[StartExercise] æ‰¾åˆ°åŠ¨ä½œ:', exercise);
            if (exercise) {
                // å¯åŠ¨æ€»è®¡æ—¶
                console.log('[StartExercise] è°ƒç”¨startSessionTimer');
                startSessionTimer();

                exercise.isStarted = true;
                exercise.isDetailsOpen = false; // ç¡®ä¿ä¸è‡ªåŠ¨å±•å¼€ç¬¬ä¸‰å±‚
                saveData();
                renderTodayPlan();
                console.log('[StartExercise] è®­ç»ƒå·²å¯åŠ¨');
            } else {
                console.log('[StartExercise] æœªæ‰¾åˆ°åŠ¨ä½œ');
            }
        }

        // Complete Cardio Exercise
        function completeCardio(id) {
            const exercise = todayPlans.find(p => p.id === id);
            if (exercise && exercise.type === 'cardio') {
                exercise.completed = true;
                // éœ‡åŠ¨åé¦ˆ
                if (navigator.vibrate) {
                    navigator.vibrate([50, 50, 50]);
                }
                saveData();
                renderTodayPlan();
            }
        }

        // Toggle Details Dropdown (ä¼˜åŒ–ç‰ˆï¼šé¿å…å®Œå…¨é‡æ–°æ¸²æŸ“)
        function toggleDetails(id) {
            const exercise = todayPlans.find(p => p.id === id);
            if (exercise) {
                if (typeof exercise.isDetailsOpen === 'undefined') exercise.isDetailsOpen = false;
                exercise.isDetailsOpen = !exercise.isDetailsOpen;
                saveData();

                // ç›´æ¥æ“ä½œ DOMï¼Œé¿å…å®Œå…¨é‡æ–°æ¸²æŸ“
                const card = document.querySelector(`[data-exercise-id="${id}"]`);
                if (card) {
                    const detailsContainer = card.querySelector('.details-container');
                    const chevron = card.querySelector('.details-chevron');

                    if (exercise.isDetailsOpen) {
                        // å±•å¼€
                        if (detailsContainer) {
                            detailsContainer.style.maxHeight = detailsContainer.scrollHeight + 'px';
                            detailsContainer.style.opacity = '1';
                        }
                        if (chevron) {
                            chevron.style.transform = 'rotate(180deg)';
                        }
                    } else {
                        // æ”¶èµ·
                        if (detailsContainer) {
                            detailsContainer.style.maxHeight = '0px';
                            detailsContainer.style.opacity = '0';
                        }
                        if (chevron) {
                            chevron.style.transform = 'rotate(0deg)';
                        }
                    }
                }
            }
        }

        // æµ‹è¯•å‡½æ•° - æ£€æŸ¥æ˜¯å¦èƒ½è¢«è°ƒç”¨
        window.testCompleteSetInline = function() {
            console.log('[TEST] testCompleteSetInline è¢«è°ƒç”¨äº†ï¼');
            alert('æµ‹è¯•å‡½æ•°èƒ½è¢«è°ƒç”¨');
        };

        // Quick Log Bubble (Complete Set)
        window.completeSetInline = function(id, setIndex) {
            console.log('[CompleteSetInline] è°ƒç”¨å‚æ•°:', id, setIndex);
            const exercise = todayPlans.find(p => p.id === id);
            if (!exercise) {
                console.log('[CompleteSetInline] æ‰¾ä¸åˆ°exerciseï¼Œid:', id);
                return;
            }

            console.log('[CompleteSetInline] æ‰¾åˆ°exercise:', exercise.name, 'å½“å‰å®Œæˆç»„æ•°:', exercise.doneSets, 'ç›®æ ‡ç»„æ•°:', exercise.targetSets);

            // å¯åŠ¨ä¼šè¯è®¡æ—¶å™¨
            startSessionTimer();

            // è®°å½•åŸæ¥çš„å®ŒæˆçŠ¶æ€
            const wasCompleted = exercise.doneSets >= exercise.targetSets;
            console.log('[CompleteSetInline] åŸæ¥æ˜¯å¦å®Œæˆ:', wasCompleted);

            // Update the count
            if (setIndex < exercise.doneSets) {
                // Undo: if clicking a previous set
                exercise.doneSets = setIndex;
            } else {
                // Complete: if clicking current or next
                exercise.doneSets = setIndex + 1;
                // éœ‡åŠ¨åé¦ˆ
                if (navigator.vibrate) {
                    navigator.vibrate(50);
                }
            }

            console.log('[CompleteSetInline] æ›´æ–°åå®Œæˆç»„æ•°:', exercise.doneSets);

            // Sync with detailed array if it exists
            if (exercise.setsDetails && exercise.setsDetails[setIndex]) {
                exercise.setsDetails[setIndex].completed = (setIndex < exercise.doneSets);
            }

            // æ£€æŸ¥æ˜¯å¦åˆšåˆšå®Œæˆ
            const isNowCompleted = exercise.doneSets >= exercise.targetSets;
            const justCompleted = !wasCompleted && isNowCompleted;

            console.log('[CompleteSetInline] ç°åœ¨æ˜¯å¦å®Œæˆ:', isNowCompleted, 'åˆšåˆšå®Œæˆ:', justCompleted);

            if (justCompleted) {
                console.log('[CompleteSetInline] è§¦å‘æ²‰åº•åŠ¨ç”»');
                // åˆšå®Œæˆæ‰€æœ‰ç»„ï¼Œè§¦å‘ç”µå½±çº§æ²‰åº•åŠ¨ç”»
                exercise.completed = true;
                saveData();

                // æ¸…é™¤å¯èƒ½æ­£åœ¨è¿è¡Œçš„å€’è®¡æ—¶
                if (smartRestTimerInterval) {
                    clearInterval(smartRestTimerInterval);
                    smartRestTimerInterval = null;
                }

                const performSink = () => {
                    renderTodayPlan();
                    setTimeout(() => {
                        showCompletionCapsule(exercise.name);
                    }, 100);
                };

                cinematicSinkAnimation(id, performSink);
            } else {
                console.log('[CompleteSetInline] æ­£å¸¸æ›´æ–°ï¼Œä¸è§¦å‘åŠ¨ç”»');
                // æœªå®Œæˆï¼Œæ­£å¸¸æ›´æ–°
                saveData();
                renderTodayPlan();

                // å¦‚æœè¿˜æœ‰æœªå®Œæˆçš„ç»„ï¼Œå¯åŠ¨æ™ºèƒ½å€’è®¡æ—¶
                if (exercise.doneSets < exercise.targetSets) {
                    console.log('[CompleteSetInline] å¯åŠ¨å€’è®¡æ—¶ï¼ŒåŠ¨ä½œ:', exercise.name, 'ä¼‘æ¯æ—¶é—´:', exercise.restTime || 90);
                    startSmartRestTimer(exercise, exercise.restTime || 90);
                }
            }
        }

        // Quick add button (+) functionality
        function quickLogSet(index) {
            const exercise = todayPlans[index];
            if (exercise && exercise.doneSets < exercise.targetSets) {
                exercise.doneSets++;
                exercise.isStarted = true;
                // éœ‡åŠ¨åé¦ˆ
                if (navigator.vibrate) {
                    navigator.vibrate(50);
                }
                saveData();
                renderTodayPlan();
            }
        }

        // Generate details HTML for expanded view
        function generateDetailsHtml(exercise, isEditable = false) {
            if (!exercise.setsDetails) return '';

            let html = '';
            exercise.setsDetails.forEach((detail, i) => {
                const isSetDone = i < exercise.doneSets;
                const uniqueId = `${exercise.id}-${i}`;

                if (isEditable) {
                    // å¯ç¼–è¾‘æ¨¡å¼
                    html += `
                        <div class="flex items-center gap-2 p-2 rounded-lg bg-zinc-100 dark:bg-zinc-800">
                            <span class="text-xs font-bold text-zinc-500 w-10">ç¬¬${i + 1}ç»„</span>
                            <div class="flex-1 flex gap-2">
                                <div class="flex-1 bg-white dark:bg-zinc-900 rounded px-2 flex items-center border border-gray-200 dark:border-zinc-700">
                                    <input type="number" id="weight-${uniqueId}" class="edit-weight w-full bg-transparent text-sm font-bold text-gray-900 dark:text-white outline-none" value="${detail.weight}" placeholder="é‡é‡">
                                    <span class="text-[9px] text-zinc-500">KG</span>
                                </div>
                                <div class="flex-1 bg-white dark:bg-zinc-900 rounded px-2 flex items-center border border-gray-200 dark:border-zinc-700">
                                    <input type="number" id="reps-${uniqueId}" class="edit-reps w-full bg-transparent text-sm font-bold text-gray-900 dark:text-white outline-none" value="${detail.reps}" placeholder="æ¬¡æ•°">
                                    <span class="text-[9px] text-zinc-500">æ¬¡</span>
                                </div>
                            </div>
                            <div class="${isSetDone ? 'text-[#A3FF00]' : 'text-zinc-400'}">
                                ${isSetDone ? 'âœ“' : 'â—‹'}
                            </div>
                        </div>
                    `;
                } else {
                    // æŸ¥çœ‹æ¨¡å¼
                    html += `
                        <div class="flex items-center justify-between p-2 rounded-lg bg-zinc-100 dark:bg-zinc-800">
                            <span class="text-xs font-bold text-zinc-500">ç¬¬ ${i + 1} ç»„</span>
                            <div class="flex items-center gap-2">
                                <span class="text-sm font-bold text-zinc-700 dark:text-zinc-300">${detail.weight} kg</span>
                                <span class="text-xs text-zinc-500">Ã—</span>
                                <span class="text-sm font-bold text-zinc-700 dark:text-zinc-300">${detail.reps} æ¬¡</span>
                            </div>
                            <div class="${isSetDone ? 'text-[#A3FF00]' : 'text-zinc-400'}">
                                ${isSetDone ? 'âœ“' : 'â—‹'}
                            </div>
                        </div>
                    `;
                }
            });
            return html;
        }

        // ä¿å­˜ç¼–è¾‘çš„è¯¦æƒ…
        function saveSetDetails(exerciseId) {
            const exercise = todayPlans.find(p => p.id === exerciseId);
            if (!exercise || !exercise.setsDetails) return;

            exercise.setsDetails.forEach((detail, i) => {
                const uniqueId = `${exerciseId}-${i}`;
                const weightInput = document.getElementById(`weight-${uniqueId}`);
                const repsInput = document.getElementById(`reps-${uniqueId}`);

                if (weightInput && weightInput.value !== '') {
                    detail.weight = parseFloat(weightInput.value) || detail.weight;
                }
                if (repsInput && repsInput.value !== '') {
                    detail.reps = parseInt(repsInput.value) || detail.reps;
                }
            });

            // æ›´æ–°ç¬¬ä¸€ç»„çš„å€¼ä½œä¸ºé»˜è®¤æ˜¾ç¤º
            exercise.weight = exercise.setsDetails[0]?.weight || exercise.weight;
            exercise.reps = exercise.setsDetails[0]?.reps || exercise.reps;

            saveData();
            renderTodayPlan();

            // éœ‡åŠ¨åé¦ˆ
            if (navigator.vibrate) {
                navigator.vibrate(50);
            }
        }

        // åˆ‡æ¢ç¼–è¾‘æ¨¡å¼
        function toggleEditMode(exerciseId) {
            const exercise = todayPlans.find(p => p.id === exerciseId);
            if (!exercise) return;

            exercise.isEditMode = !exercise.isEditMode;
            saveData();
            renderTodayPlan();
        }

        // Main render function (V25 classic: glow, Start button, drag-sort)
        function renderTodayPlan() {
            const listContainer = document.getElementById('plan-list');
            if (!listContainer) return;
            listContainer.innerHTML = '';

            // æ™ºèƒ½æ²‰åº•æ’åºï¼šæœªå®Œæˆçš„åœ¨å‰ï¼Œå®Œæˆçš„åœ¨å
            const sortedPlans = [...todayPlans].sort((a, b) => {
                const aIsCardio = a.type === 'cardio';
                const bIsCardio = b.type === 'cardio';
                const aCompleted = aIsCardio ? a.completed : (a.doneSets >= a.targetSets);
                const bCompleted = bIsCardio ? b.completed : (b.doneSets >= b.targetSets);

                // å¦‚æœ a å®Œæˆï¼Œb æœªå®Œæˆï¼Œa æ’åœ¨åé¢
                if (aCompleted && !bCompleted) return 1;
                // å¦‚æœ a æœªå®Œæˆï¼Œb å®Œæˆï¼Œa æ’åœ¨å‰é¢
                if (!aCompleted && bCompleted) return -1;
                // å¦åˆ™ä¿æŒåŸé¡ºåº
                return 0;
            });

            sortedPlans.forEach((exercise, index) => {
                // åˆ¤æ–­æ˜¯å¦ä¸ºæœ‰æ°§è¿åŠ¨
                const isCardio = exercise.type === 'cardio';

                // åŠ›é‡è®­ç»ƒçš„å®ŒæˆçŠ¶æ€
                const isCompleted = isCardio ? exercise.completed : (exercise.doneSets >= exercise.targetSets);
                if (typeof exercise.isStarted === 'undefined') exercise.isStarted = false;
                if (typeof exercise.isDetailsOpen === 'undefined') exercise.isDetailsOpen = false;
                if (typeof exercise.isEditMode === 'undefined') exercise.isEditMode = false;

                const isExpanded = !isCompleted && (isCardio ? false : (exercise.doneSets > 0 || exercise.isStarted));
                const showDetails = isExpanded && exercise.isDetailsOpen;

                let outerClass = "swipe-container plan-card relative mb-3 overflow-hidden border border-white/10 backdrop-blur-xl shadow-[0_0_40px_-10px_rgba(110,221,70,0.3)] ring-1 ring-inset ring-white/5 transition-all duration-300 ";

                // æ ¹æ®å±•å¼€çŠ¶æ€å’Œå®ŒæˆçŠ¶æ€è®¾ç½®åœ†è§’
                if (isCompleted || (!isExpanded && !isCompleted)) {
                    outerClass += "rounded-full "; // å®ŒæˆçŠ¶æ€æˆ–åˆå§‹çŠ¶æ€ï¼šå®Œå…¨åœ†å½¢èƒ¶å›Š
                } else {
                    outerClass += "rounded-3xl "; // å±•å¼€åï¼šåœ†è§’çŸ©å½¢
                }

                if (isCompleted) {
                    // å®ŒæˆçŠ¶æ€ï¼šå¢å¼ºç»¿è‰²è§å…‰ç»ç’ƒ
                    outerClass += "is-completed bg-gradient-to-b from-[#6EDD46]/15 to-transparent bg-[#09090b]/80 border-[#6EDD46]/40 shadow-[0_0_50px_-10px_rgba(110,221,70,0.5)]";
                } else if (isExpanded) {
                    outerClass += "is-active border-transparent bg-gradient-to-b from-[#6EDD46]/8 to-transparent bg-[#09090b]/80";
                } else {
                    outerClass += "bg-gradient-to-b from-[#6EDD46]/5 to-transparent bg-[#09090b]/80 border-white/5";
                }

                let innerClass = "card-content-layer p-3 relative z-20 h-full rounded-[inherit] ";
                if (isCompleted) {
                    innerClass += "bg-transparent";
                } else if (!isExpanded) {
                    innerClass += "bg-transparent"; // ç»ç’ƒæ•ˆæœï¼šå†…å±‚é€æ˜
                }

                // æ ¹æ®ç±»å‹æ˜¾ç¤ºä¸åŒçš„å‰¯æ ‡é¢˜
                const subtitle = isCardio
                    ? `${exercise.duration || 30} åˆ†é’Ÿ`
                    : `${exercise.weight || exercise.initialWeight || 0} KG Ã— ${exercise.targetSets}ç»„ Ã— ${exercise.reps}æ¬¡`;

                // æ£€æŸ¥æ˜¯å¦æ˜¯æ–°æ·»åŠ çš„å¡ç‰‡
                const isNewlyAdded = exercise.id === newlyAddedCardId;
                const newCardAnimationClass = isNewlyAdded ? 'newly-added-card' : '';

                const cardHtml = `
                    <div class="${outerClass} plan-card ${newCardAnimationClass}" data-exercise-id="${exercise.id}" style="view-transition-name: card-${exercise.id};">
                         ${!isCompleted ? `<div class="delete-action-layer bg-red-500/90 backdrop-blur-xl"><div class="flex items-center gap-1 font-bold text-white mr-4"><svg class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2.5"><path stroke-linecap="round" stroke-linejoin="round" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/></svg><span>åˆ é™¤</span></div></div>` : ''}
                         <div class="${innerClass}" onclick="${isCardio ? '' : `toggleDetails(${exercise.id})`}">
                              <div class="flex justify-between items-center">
                                  <div>
                                      <h3 class="text-lg font-black ${isCompleted ? 'text-[#6EDD46]' : 'text-white'}">${exercise.name}</h3>
                                      <p class="text-xs font-medium text-zinc-400 mt-1 uppercase tracking-wide">${subtitle}</p>
                                  </div>
                                  <div>
                                      ${isCompleted ? `
                                          <div class="w-12 h-12 rounded-full bg-[#6EDD46] flex items-center justify-center shadow-lg"><svg class="w-7 h-7 text-black" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="4"><path stroke-linecap="round" stroke-linejoin="round" d="M5 13l4 4L19 7"/></svg></div>
                                      ` : `
                                          ${isCardio ? `
                                              <button onclick="event.stopPropagation(); completeCardio(${exercise.id})" class="bg-[#6EDD46] hover:bg-[#5bc438] text-black font-black text-sm px-5 py-2 rounded-full shadow-lg active:scale-95 flex items-center gap-1 transition-transform"><svg class="w-4 h-4" fill="currentColor" viewBox="0 0 24 24"><path d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>å®Œæˆ</button>
                                          ` : `
                                          ${!isExpanded ? `
                                              <button onclick="event.stopPropagation(); startExercise(${exercise.id})" class="bg-[#6EDD46] hover:bg-[#5bc438] text-black font-black text-sm px-5 py-2 rounded-full shadow-lg active:scale-95 flex items-center gap-1 transition-transform"><svg class="w-4 h-4" fill="currentColor" viewBox="0 0 24 24"><path d="M8 5v14l11-7z"/></svg>å¼€å§‹</button>
                                          ` : `
                                               <div class="w-10 h-10 flex items-center justify-center rounded-full bg-zinc-800/50 backdrop-blur-sm border border-white/10 text-zinc-400 details-chevron transition-transform duration-300 ${showDetails ? 'rotate-180' : ''}"><svg class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2.5"><path stroke-linecap="round" stroke-linejoin="round" d="M19 9l-7 7-7-7"/></svg></div>
                                          `}
                                          `}
                                      `}
                                  </div>
                              </div>
                              ${(!isCardio && isExpanded && !isCompleted) ? `
                                  <div class="mt-3 pt-3">
                                      <!-- ç¬¬äºŒå±‚ï¼šæ³¡æ³¡å’Œ+æŒ‰é’®ï¼ˆå§‹ç»ˆæ˜¾ç¤ºï¼‰ -->
                                      <div class="flex items-center justify-between gap-2 mb-2">
                                          <div class="flex gap-2 flex-wrap">
                                              ${Array(exercise.targetSets).fill().map((_, i) => {
                                                  const isDone = i < exercise.doneSets;
                                                  return `<button onclick="event.stopPropagation(); completeSetInline(${exercise.id}, ${i})" class="w-10 h-10 rounded-xl font-black text-sm transition-all ${isDone ? 'bg-[#6EDD46] text-black scale-100 shadow-[0_0_20px_rgba(110,221,70,0.4)]' : 'bg-[#09090b]/40 backdrop-blur-md border border-white/10 text-zinc-400 hover:bg-[#6EDD46]/10 hover:border-[#6EDD46]/40 hover:text-[#6EDD46] shadow-[0_4px_12px_rgba(0,0,0,0.3)] hover:shadow-[0_0_20px_rgba(110,221,70,0.2)]'}">${isDone ? 'âœ“' : i + 1}</button>`;
                                              }).join('')}
                                          </div>
                                          <button onclick="event.stopPropagation(); quickLogSetById(${exercise.id})" class="flex-1 h-10 bg-[#09090b]/40 backdrop-blur-md border border-white/10 hover:bg-[#6EDD46] hover:border-[#6EDD46] hover:text-black hover:shadow-[0_0_25px_rgba(110,221,70,0.5)] text-zinc-400 rounded-xl flex items-center justify-center font-bold text-xl active:scale-95 transition-colors duration-200 shadow-[0_4px_12px_rgba(0,0,0,0.3)]">+</button>
                                      </div>
                                      <!-- ç¬¬ä¸‰å±‚ï¼šè¯¦æƒ…å†å²è®°å½•ï¼ˆå¯å±•å¼€/æ”¶èµ·ï¼‰ -->
                                      <div class="details-container overflow-hidden transition-all duration-300 ease-out" style="max-height: ${showDetails ? '1000px' : '0px'}; opacity: ${showDetails ? '1' : '0'};" onclick="event.stopPropagation()">
                                          ${showDetails ? `
                                              <div class="space-y-2 bg-[#09090b]/30 backdrop-blur-md border border-white/5 rounded-xl p-2 shadow-[0_4px_12px_rgba(0,0,0,0.2)]">
                                                  <!-- ç¼–è¾‘/ä¿å­˜æŒ‰é’® -->
                                                  <div class="flex gap-2 mb-2">
                                                      ${exercise.isEditMode ?
                                                          `<button onclick="event.stopPropagation(); saveSetDetails(${exercise.id})" class="flex-1 py-1.5 bg-[#A3FF00] hover:bg-[#9add00] text-black font-bold text-xs rounded-lg flex items-center justify-center gap-1 transition-colors">
                                                              <svg class="w-3 h-3" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="3"><path stroke-linecap="round" stroke-linejoin="round" d="M5 13l4 4L19 7"/></svg>
                                                              ä¿å­˜ä¿®æ”¹
                                                          </button>` :
                                                          `<button onclick="event.stopPropagation(); toggleEditMode(${exercise.id})" class="flex-1 py-1.5 bg-zinc-700 hover:bg-zinc-600 text-white font-bold text-xs rounded-lg flex items-center justify-center gap-1 transition-colors">
                                                              <svg class="w-3 h-3" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2.5"><path stroke-linecap="round" stroke-linejoin="round" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"/></svg>
                                                              ç¼–è¾‘æ•°æ®
                                                          </button>`
                                                      }
                                                      <button onclick="toggleDetails(${exercise.id})" class="flex-1 py-1.5 bg-zinc-800 hover:bg-zinc-700 text-zinc-400 font-bold text-xs rounded-lg flex items-center justify-center gap-1 transition-colors">
                                                          <svg class="w-3 h-3" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2.5"><path stroke-linecap="round" stroke-linejoin="round" d="M5 15l7-7 7 7"/></svg>
                                                          æ”¶èµ·
                                                      </button>
                                                  </div>
                                                  <!-- è¯¦æƒ…å†…å®¹ -->
                                                  ${generateDetailsHtml(exercise, exercise.isEditMode)}
                                              </div>
                                          ` : ''}
                                      </div>
                                  </div>
                              ` : ''}
                         </div>
                    </div>
                `;
                listContainer.insertAdjacentHTML('beforeend', cardHtml);
            });

            // æ¸…é™¤æ–°æ·»åŠ æ ‡è®°ï¼Œå¹¶è§¦å‘åŠ¨ç”»
            if (newlyAddedCardId) {
                setTimeout(() => {
                    const newCard = document.querySelector(`[data-exercise-id="${newlyAddedCardId}"]`);
                    if (newCard) {
                        // è§¦å‘é‡æ’ä»¥å¯åŠ¨åŠ¨ç”»
                        newCard.style.animation = 'none';
                        newCard.offsetHeight; // è§¦å‘é‡æ’
                        newCard.style.animation = null;
                    }
                    newlyAddedCardId = null;
                }, 50);
            }

            // æ›´æ–°æ¸…ç©ºæŒ‰é’®çš„æ˜¾ç¤ºçŠ¶æ€
            const clearAllContainer = document.getElementById('clear-all-container');
            if (clearAllContainer) {
                if (todayPlans.length > 0) {
                    clearAllContainer.classList.remove('hidden');
                } else {
                    clearAllContainer.classList.add('hidden');
                }
            }

            // Sortable initialization with Liquid Physics
            if (window.sortableInstance) window.sortableInstance.destroy();
            window.sortableInstance = new Sortable(listContainer, {

                // 1. Slow down to 600ms so the movement is clearly visible
                animation: 600,

                // 2. Add "Friction" using Bezier Curve (Starts smooth, accelerates, brakes soft)
                easing: "cubic-bezier(0.22, 1, 0.36, 1)",

                delay: 150, // å‡å°‘å»¶è¿Ÿï¼Œæ›´å¿«å“åº”
                delayOnTouchOnly: true,
                handle: ".swipe-container", // The whole card is the handle
                filter: ".delete-action-layer, button, input", // Don't drag when clicking buttons
                preventOnFilter: false,

                // Visual classes
                ghostClass: "sortable-ghost", // The invisible placeholder (å‘)
                chosenClass: "sortable-chosen", // The card being dragged (è¢«æ‹–æ‹½çš„)
                dragClass: "sortable-drag", // The floating helper (æ‹–æ‹½ä¸­çš„)

                // Events
                onStart: function(evt) {
                    // å¼ºçƒˆè§¦è§‰åé¦ˆ
                    if (navigator.vibrate) navigator.vibrate([30, 50, 30]);
                    document.body.style.cursor = 'grabbing';
                    // æ·»åŠ é¡µé¢çº§æç¤º
                    evt.item.classList.add('is-dragging');
                },

                onMove: function(evt) {
                    // å®æ—¶è§†è§‰åé¦ˆ
                    return true;
                },

                onEnd: function (evt) {
                    document.body.style.cursor = 'default';
                    evt.item.classList.remove('is-dragging');

                    const oldIndex = evt.oldIndex;
                    const newIndex = evt.newIndex;

                    if (oldIndex !== newIndex) {
                        // Update Data Model
                        const movedItem = todayPlans.splice(oldIndex, 1)[0];
                        todayPlans.splice(newIndex, 0, movedItem);
                        saveData();

                        // éœ‡åŠ¨ç¡®è®¤
                        if (navigator.vibrate) navigator.vibrate([20, 30, 20]);

                        // Do NOT re-render here, let the animation finish naturally
                    }
                },
            });

            // æ›´æ–°è¿›åº¦ç¯
            updateRings(todayPlans);
        }

        // ============ V12.0 æ‰‹é£ç´è¯¦æƒ…å‡½æ•° ============

        function toggleCardDetails(exerciseId, event) {
            // å¦‚æœç‚¹å‡»çš„æ˜¯è¾“å…¥æ¡†æœ¬èº«ï¼Œä¸è¦æ”¶èµ·
            if (event.target.tagName === 'INPUT') return;
            // é˜²æ­¢ç‚¹å‡»æ³¡æ³¡ã€æŒ‰é’®æ—¶è§¦å‘
            if (event.target.closest('.check-bubble') ||
                event.target.closest('.quick-action-btn') ||
                event.target.tagName === 'BUTTON') {
                return;
            }

            const detailsPanel = document.getElementById(`details-${exerciseId}`);
            const arrow = document.getElementById(`arrow-${exerciseId}`);

            if (!detailsPanel) return;

            const isHidden = detailsPanel.classList.contains('hidden');

            if (isHidden) {
                // å±•å¼€
                detailsPanel.classList.remove('hidden');
                detailsPanel.classList.add('animate-fade-in');
                if (arrow) arrow.style.transform = 'rotate(180deg)';
            } else {
                // æ”¶èµ·
                detailsPanel.classList.add('hidden');
                detailsPanel.classList.remove('animate-fade-in');
                if (arrow) arrow.style.transform = 'rotate(0deg)';
            }
        }

        function updateSetDetail(exerciseId, setIndex, field, value) {
            const plan = getTodaysPlan();
            const exercise = plan.find(e => e.id === exerciseId);

            if (!exercise || !exercise.setsDetails) return;

            // æ›´æ–°å¯¹åº”ç»„çš„è¯¦æƒ…
            exercise.setsDetails[setIndex][field] = parseFloat(value) || 0;

            // åŒæ­¥æ›´æ–°åˆå§‹å€¼ï¼ˆå¦‚æœä¿®æ”¹çš„æ˜¯ç¬¬ä¸€ç»„ï¼‰
            if (setIndex === 0) {
                if (field === 'weight') {
                    exercise.initialWeight = parseFloat(value) || 0;
                    exercise.weight = parseFloat(value) || 0;
                }
                if (field === 'reps') {
                    exercise.reps = parseInt(value) || 10;
                }
            }

            // ä¿å­˜åˆ°æœ¬åœ°ï¼ˆä¸é‡æ–°æ¸²æŸ“ï¼Œä¿æŒè¾“å…¥æ¡†ç„¦ç‚¹ï¼‰
            saveTodaysPlan(plan);

            // å¾®å¼±éœ‡åŠ¨åé¦ˆ
            if (navigator.vibrate) {
                navigator.vibrate(5);
            }
        }

        // ============ å¿«é€Ÿæ—¥å¿—å‡½æ•°ï¼ˆåŠ ç»ƒé€»è¾‘ï¼‰============

        // V24.0: é€šè¿‡ ID å¿«é€Ÿè®°å½•ä¸€ç»„ï¼ˆä¿®å¤ç´¢å¼•é—®é¢˜ï¼‰
        function quickLogSetById(exerciseId) {
            const plan = getTodaysPlan();
            const exercise = plan.find(ex => ex.id === exerciseId);

            if (!exercise) return;

            // å¯åŠ¨ä¼šè¯è®¡æ—¶å™¨
            startSessionTimer();

            if (exercise.type === 'cardio') {
                // æœ‰æ°§è®­ç»ƒï¼šåˆ‡æ¢å®ŒæˆçŠ¶æ€
                exercise.completed = !exercise.completed;
                saveTodaysPlan(plan);
                renderPlanList(plan);
            } else {
                // åŠ›é‡è®­ç»ƒï¼šå¢åŠ å·²å®Œæˆç»„æ•°
                if (exercise.doneSets < exercise.targetSets) {
                    exercise.doneSets++;
                    exercise.isStarted = true; // ç¡®ä¿çŠ¶æ€ä¸ºè¿›è¡Œä¸­
                    exercise.isDetailsOpen = false; // ç¡®ä¿ä¸è‡ªåŠ¨å±•å¼€ç¬¬ä¸‰å±‚
                    saveTodaysPlan(plan);

                    // éœ‡åŠ¨åé¦ˆ
                    if (navigator.vibrate) navigator.vibrate(30);

                    // æ¸²æŸ“æ›´æ–°åçš„åˆ—è¡¨
                    renderPlanList(plan);

                    // å¯åŠ¨æ™ºèƒ½å€’è®¡æ—¶
                    if (exercise.doneSets < exercise.targetSets) {
                        startSmartRestTimer(exercise, exercise.restTime || 90);
                    } else {
                        // åˆšå®Œæˆæœ€åä¸€ç»„ï¼Œæ¸…é™¤å€’è®¡æ—¶å¹¶æ˜¾ç¤ºå®Œæˆèƒ¶å›Š
                        if (smartRestTimerInterval) {
                            clearInterval(smartRestTimerInterval);
                            smartRestTimerInterval = null;
                        }
                        showCompletionCapsule(exercise.name);
                    }
                }
            }
        }

        // æ˜¾ç¤ºå®Œæˆèƒ¶å›Š - Appleé£æ ¼
        let completionCapsuleTimeout = null; // ä¿å­˜å®Œæˆèƒ¶å›Šçš„å®šæ—¶å™¨ID

        function showCompletionCapsule(exerciseName) {
            // å…ˆæ¸…é™¤å¯èƒ½æ­£åœ¨è¿è¡Œçš„å€’è®¡æ—¶å’Œå®Œæˆèƒ¶å›Šå®šæ—¶å™¨
            if (smartRestTimerInterval) {
                clearInterval(smartRestTimerInterval);
                smartRestTimerInterval = null;
            }
            if (completionCapsuleTimeout) {
                clearTimeout(completionCapsuleTimeout);
                completionCapsuleTimeout = null;
            }

            const capsule = document.getElementById('smart-rest-capsule');
            const capsuleBody = document.getElementById('capsule-body');
            const timerDisplay = document.getElementById('smart-rest-timer');

            if (capsule && capsuleBody && timerDisplay) {
                // é‡ç½®æ‰€æœ‰æ ·å¼
                capsuleBody.classList.remove('border-orange-500/80', 'shadow-[0_0_40px_rgba(249,115,22,0.6)]', 'animate-pulse-fast', 'bg-[#A3FF00]/10', 'border-[#A3FF00]/30');
                capsuleBody.classList.add('border-white/10');

                // é‡ç½®æ–‡å­—æ ·å¼
                timerDisplay.classList.remove('text-orange-400', 'text-[#A3FF00]', 'font-black');

                // æ˜¾ç¤ºèƒ¶å›Š
                capsule.classList.remove('hidden');
                capsule.style.opacity = '0';
                capsule.style.transform = 'translateY(20px)';

                // Appleé£æ ¼çš„å†…å®¹ - å¸¦å›¾æ ‡ï¼ˆéšè—æ§åˆ¶æŒ‰é’®ï¼‰
                // å…ˆéšè—æ‰€æœ‰æ§åˆ¶æŒ‰é’®
                const minusBtn = document.getElementById('smart-rest-minus-btn');
                const plusBtn = document.getElementById('smart-rest-plus-btn');
                const skipBtn = document.getElementById('smart-rest-skip-btn');
                if (minusBtn) minusBtn.style.display = 'none';
                if (plusBtn) plusBtn.style.display = 'none';
                if (skipBtn) skipBtn.style.display = 'none';

                timerDisplay.innerHTML = `
                    <div class="flex items-center justify-center gap-3">
                        <div class="w-8 h-8 rounded-full bg-gradient-to-br from-[#A3FF00] to-[#7ACC00] flex items-center justify-center shadow-lg">
                            <svg class="w-5 h-5 text-black" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="3">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M5 13l4 4L19 7"/>
                            </svg>
                        </div>
                        <div class="flex flex-col items-start">
                            <span class="text-sm font-semibold text-gray-900 dark:text-white">å·²å®Œæˆ</span>
                            <span class="text-xs font-medium text-gray-500 dark:text-gray-400">${exerciseName}</span>
                        </div>
                    </div>
                `;

                // åº”ç”¨Appleé£æ ¼çš„èƒ¶å›Šæ ·å¼
                capsuleBody.classList.remove('bg-zinc-900/40', 'dark:bg-black/40');
                capsuleBody.classList.add('bg-white/80', 'dark:bg-black/80', 'backdrop-blur-2xl');
                capsuleBody.style.boxShadow = '0 8px 32px rgba(0, 0, 0, 0.12), 0 0 0 1px rgba(255, 255, 255, 0.1) inset';

                // Appleé£æ ¼ä¼˜é›…è¿›å…¥åŠ¨ç”»
                requestAnimationFrame(() => {
                    capsule.style.transition = 'all 0.8s cubic-bezier(0.16, 1, 0.3, 1)';
                    capsule.style.opacity = '1';
                    capsule.style.transform = 'translateY(0)';
                });

                // 3ç§’åä¼˜é›…æ¶ˆå¤±
                completionCapsuleTimeout = setTimeout(() => {
                    // æ£€æŸ¥æ˜¯å¦æœ‰å€’è®¡æ—¶æ­£åœ¨è¿è¡Œ
                    if (smartRestTimerInterval) {
                        // æœ‰å€’è®¡æ—¶åœ¨è¿è¡Œï¼Œåˆ‡æ¢å›å€’è®¡æ—¶æ˜¾ç¤º
                        console.log('[CompletionCapsule] æ£€æµ‹åˆ°å€’è®¡æ—¶è¿è¡Œï¼Œæ¢å¤å€’è®¡æ—¶æ˜¾ç¤º');
                        capsuleBody.className = 'mx-auto max-w-[360px] h-[72px] bg-zinc-900/40 dark:bg-black/40 backdrop-blur-3xl border border-white/10 rounded-full shadow-[0_12px_40px_rgba(0,0,0,0.4)] flex items-center justify-center relative overflow-hidden transition-all duration-300';
                        capsuleBody.style.boxShadow = '';
                        capsule.style.opacity = '1';
                        capsule.style.transform = '';
                        timerDisplay.className = 'text-2xl font-black text-gray-900 dark:text-white tabular-nums tracking-wider';
                        const minutes = Math.floor(smartRestTimeLeft / 60);
                        const seconds = smartRestTimeLeft % 60;
                        timerDisplay.textContent = `${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;

                        // æ¢å¤æŒ‰é’®æ˜¾ç¤º
                        const minusBtn = document.getElementById('smart-rest-minus-btn');
                        const plusBtn = document.getElementById('smart-rest-plus-btn');
                        const skipBtn = document.getElementById('smart-rest-skip-btn');
                        if (minusBtn) minusBtn.style.display = '';
                        if (plusBtn) plusBtn.style.display = '';
                        if (skipBtn) skipBtn.style.display = '';
                        return;
                    }

                    capsule.style.transition = 'all 0.6s cubic-bezier(0.16, 1, 0.3, 1)';
                    capsule.style.opacity = '0';
                    capsule.style.transform = 'translateY(-10px)';

                    setTimeout(() => {
                        capsule.classList.add('hidden');
                        // æ¢å¤é»˜è®¤æ ·å¼å’ŒæŒ‰é’®
                        capsuleBody.classList.add('bg-zinc-900/40', 'dark:bg-black/40');
                        capsuleBody.classList.remove('bg-white/80', 'dark:bg-black/80', 'backdrop-blur-2xl');
                        capsuleBody.style.boxShadow = '';
                        capsule.style.transition = '';
                        capsule.style.transform = '';

                        // æ¢å¤æŒ‰é’®æ˜¾ç¤º
                        const minusBtn = document.getElementById('smart-rest-minus-btn');
                        const plusBtn = document.getElementById('smart-rest-plus-btn');
                        const skipBtn = document.getElementById('smart-rest-skip-btn');
                        if (minusBtn) minusBtn.style.display = '';
                        if (plusBtn) plusBtn.style.display = '';
                        if (skipBtn) skipBtn.style.display = '';
                    }, 600);
                }, 3000);
            }
        }

        function quickLogSet(exerciseIndex) {
            const plan = getTodaysPlan();
            const exercise = plan[exerciseIndex];

            if (!exercise) return;

            // å¯åŠ¨ä¼šè¯è®¡æ—¶å™¨
            startSessionTimer();

            if (exercise.type === 'cardio') {
                // æœ‰æ°§è®­ç»ƒï¼šåˆ‡æ¢å®ŒæˆçŠ¶æ€
                if (exercise.completed) {
                    // å·²å®Œæˆï¼Œå–æ¶ˆå®Œæˆ
                    exercise.completed = false;
                    plan[exerciseIndex] = exercise;
                    saveTodaysPlan(plan);
                    updateUI();
                } else {
                    // æ ‡è®°å®Œæˆ
                    exercise.completed = true;

                    // å…ˆä¿å­˜æ•°æ®
                    plan[exerciseIndex] = exercise;
                    saveTodaysPlan(plan);

                    // === V16.0 è‡ªåŠ¨åˆ‡æ¢ç„¦ç‚¹åˆ°ä¸‹ä¸€ä¸ªæœªå®Œæˆçš„å¡ç‰‡ ===
                    const nextIncomplete = plan.find(ex => {
                        if (ex.type === 'cardio') {
                            return !ex.completed;
                        } else {
                            return ex.doneSets < ex.targetSets;
                        }
                    });
                    if (nextIncomplete) {
                        activeCardId = nextIncomplete.id;
                    }

                    // ä½¿ç”¨ç”µå½±çº§ä¸æ»‘æ²‰åº•åŠ¨ç”»
                    const performSink = () => {
                        updateUI();
                        setTimeout(() => {
                            showCelebrationInline(exercise.name);
                        }, 100);
                    };

                    cinematicSinkAnimation(exercise.id, performSink);
                }
            } else {
                // åŠ›é‡è®­ç»ƒ
                const nextSetNumber = exercise.doneSets + 1;

                if (nextSetNumber > exercise.targetSets) {
                    // ===== åŠ ç»ƒé€»è¾‘ï¼šæ‰€æœ‰ç»„éƒ½å®Œæˆäº† =====
                    // 1. æ–°å¢ä¸€ç»„
                    exercise.targetSets = nextSetNumber;

                    // 2. è·å–å½“å‰é‡é‡
                    let currentWeight = exercise.initialWeight || 0;
                    let currentReps = exercise.reps || 10;

                    // ä¼˜å…ˆä½¿ç”¨æœ€åä¸€æ¬¡çš„é‡é‡
                    if (exercise.weightLogs && exercise.weightLogs.length > 0) {
                        const lastLog = exercise.weightLogs[exercise.weightLogs.length - 1];
                        currentWeight = typeof lastLog === 'object' ? lastLog.weight : lastLog;
                        if (typeof lastLog === 'object' && lastLog.reps) {
                            currentReps = lastLog.reps;
                        }
                    }

                    // 3. è®°å½•æ–°å¢çš„ç»„
                    if (!exercise.weightLogs) {
                        exercise.weightLogs = [];
                    }

                    exercise.weightLogs.push({
                        weight: currentWeight,
                        reps: currentReps,
                        setNumber: nextSetNumber,
                        timestamp: new Date().toISOString()
                    });

                    // 4. æ›´æ–°å®Œæˆç»„æ•°
                    exercise.doneSets = nextSetNumber;

                    // 5. å¼ºéœ‡åŠ¨åé¦ˆï¼ˆåº†ç¥åŠ ç»ƒï¼‰
                    if (navigator.vibrate) {
                        navigator.vibrate([100, 50, 100, 50, 100]);
                    }

                    plan[exerciseIndex] = exercise;
                    saveTodaysPlan(plan);
                    updateUI();

                } else {
                    // ===== æ­£å¸¸é€»è¾‘ï¼šå®Œæˆä¸‹ä¸€ç»„ =====
                    // è·å–å½“å‰é‡é‡
                    let currentWeight = exercise.initialWeight || 0;
                    let currentReps = exercise.reps || 10;

                    if (exercise.plannedSets && exercise.plannedSets.length >= nextSetNumber) {
                        currentWeight = exercise.plannedSets[nextSetNumber - 1].weight;
                        currentReps = exercise.plannedSets[nextSetNumber - 1].reps;
                    } else if (exercise.weightLogs && exercise.weightLogs.length > 0) {
                        const lastLog = exercise.weightLogs[exercise.weightLogs.length - 1];
                        currentWeight = typeof lastLog === 'object' ? lastLog.weight : lastLog;
                    }

                    // è®°å½•
                    if (!exercise.weightLogs) {
                        exercise.weightLogs = [];
                    }

                    exercise.weightLogs.push({
                        weight: currentWeight,
                        reps: currentReps,
                        setNumber: nextSetNumber,
                        timestamp: new Date().toISOString()
                    });

                    // æ›´æ–°å®Œæˆç»„æ•°
                    exercise.doneSets = nextSetNumber;

                    // éœ‡åŠ¨åé¦ˆ
                    if (navigator.vibrate) {
                        navigator.vibrate(50);
                    }

                    plan[exerciseIndex] = exercise;
                    saveTodaysPlan(plan);
                    updateUI();

                    // å¦‚æœè¿˜æœ‰æœªå®Œæˆçš„ç»„ï¼Œå¯åŠ¨æ™ºèƒ½å€’è®¡æ—¶
                    if (exercise.doneSets < exercise.targetSets) {
                        startSmartRestTimer(exercise, exercise.restTime || 90);
                    } else {
                        // å…¨éƒ¨å®Œæˆ - ç”µå½±çº§ä¸æ»‘æ²‰åº•åŠ¨ç”»
                        exercise.completed = true;

                        // å…ˆä¿å­˜æ•°æ®
                        plan[exerciseIndex] = exercise;
                        saveTodaysPlan(plan);

                        // === V16.0 è‡ªåŠ¨åˆ‡æ¢ç„¦ç‚¹åˆ°ä¸‹ä¸€ä¸ªæœªå®Œæˆçš„å¡ç‰‡ ===
                        // æ‰¾åˆ°ä¸‹ä¸€ä¸ªæœªå®Œæˆçš„å¡ç‰‡
                        const nextIncomplete = plan.find(ex => {
                            if (ex.type === 'cardio') {
                                return !ex.completed;
                            } else {
                                return ex.doneSets < ex.targetSets;
                            }
                        });
                        if (nextIncomplete) {
                            activeCardId = nextIncomplete.id;
                        }

                        // ä½¿ç”¨ç”µå½±çº§ä¸æ»‘æ²‰åº•åŠ¨ç”»
                        const performSink = () => {
                            updateUI();
                            setTimeout(() => {
                                showCelebrationInline(exercise.name);
                            }, 100);
                        };

                        cinematicSinkAnimation(exercise.id, performSink);
                    }
                }
            }
        }

        // ============ æ™ºèƒ½å€’è®¡æ—¶èƒ¶å›Š ============

        let smartRestTimerInterval = null;
        let smartRestTimeLeft = 90;
        let smartRestInitialDuration = 90; // è®°å½•åˆå§‹æ—¶é•¿ç”¨äºè¿›åº¦æ¡è®¡ç®—

        function startSmartRestTimer(exercise, duration) {
            console.log('[SmartRestTimer] å¯åŠ¨å€’è®¡æ—¶ï¼ŒåŠ¨ä½œ:', exercise.name, 'æ—¶é•¿:', duration);

            // æ¸…é™¤å¯èƒ½æ­£åœ¨è¿è¡Œçš„å®Œæˆèƒ¶å›Šå®šæ—¶å™¨
            if (completionCapsuleTimeout) {
                clearTimeout(completionCapsuleTimeout);
                completionCapsuleTimeout = null;
                console.log('[SmartRestTimer] æ¸…é™¤äº†å®Œæˆèƒ¶å›Šå®šæ—¶å™¨');
            }

            smartRestTimeLeft = duration;
            smartRestInitialDuration = duration; // ä¿å­˜åˆå§‹æ—¶é•¿

            const capsule = document.getElementById('smart-rest-capsule');
            const timerDisplay = document.getElementById('smart-rest-timer');

            if (!capsule) {
                console.log('[SmartRestTimer] èƒ¶å›Šå…ƒç´ æœªæ‰¾åˆ°ï¼');
                return;
            }

            // é‡ç½®å¿ƒè·³æ¨¡å¼æ ·å¼ï¼ˆæ¢å¤å¯¹ç§°æ°´æ™¶ï¼‰
            const capsuleBody = document.getElementById('capsule-body');
            if (!capsuleBody) {
                console.log('[SmartRestTimer] capsule-bodyå…ƒç´ æœªæ‰¾åˆ°ï¼');
                return;
            }

            // å½»åº•é‡ç½®èƒ¶å›Šæ ·å¼
            capsuleBody.className = 'mx-auto max-w-[360px] h-[72px] bg-zinc-900/40 dark:bg-black/40 backdrop-blur-3xl border border-white/10 rounded-full shadow-[0_12px_40px_rgba(0,0,0,0.4)] flex items-center justify-center relative overflow-hidden transition-all duration-300';
            capsuleBody.style.boxShadow = '';
            capsule.style.opacity = '';
            capsule.style.transform = '';
            capsule.style.transition = '';

            // é‡ç½®æ–‡å­—æ ·å¼
            timerDisplay.className = 'text-2xl font-black text-gray-900 dark:text-white tabular-nums tracking-wider';
            timerDisplay.innerHTML = '';
            timerDisplay.textContent = `${String(Math.floor(duration / 60)).padStart(2, '0')}:${String(duration % 60).padStart(2, '0')}`;

            // æ¢å¤æŒ‰é’®æ˜¾ç¤º
            const minusBtn = document.getElementById('smart-rest-minus-btn');
            const plusBtn = document.getElementById('smart-rest-plus-btn');
            const skipBtn = document.getElementById('smart-rest-skip-btn');
            if (minusBtn) minusBtn.style.display = '';
            if (plusBtn) plusBtn.style.display = '';
            if (skipBtn) skipBtn.style.display = '';

            // æ˜¾ç¤ºèƒ¶å›Š
            capsule.classList.remove('hidden');
            console.log('[SmartRestTimer] èƒ¶å›Šå·²æ˜¾ç¤º');

            // ç«‹å³æ›´æ–°æ˜¾ç¤º
            updateSmartRestTimerDisplay();

            // æ¸…é™¤æ—§çš„å®šæ—¶å™¨
            if (smartRestTimerInterval) {
                clearInterval(smartRestTimerInterval);
            }

            // å¯åŠ¨å€’è®¡æ—¶
            smartRestTimerInterval = setInterval(() => {
                smartRestTimeLeft--;
                updateSmartRestTimerDisplay();

                if (smartRestTimeLeft <= 0) {
                    clearInterval(smartRestTimerInterval);
                    smartRestTimerInterval = null;
                    // éšè—èƒ¶å›Š
                    capsule.classList.add('hidden');
                    // é‡ç½®æ ·å¼ï¼ˆæ¢å¤å¯¹ç§°æ°´æ™¶ï¼‰
                    const capsuleBody = document.getElementById('capsule-body');
                    capsuleBody.classList.remove('border-orange-500/80', 'shadow-[0_0_40px_rgba(249,115,22,0.6)]', 'animate-pulse-fast');
                    capsuleBody.classList.add('border-white/10');
                    timerDisplay.classList.remove('text-orange-400');

                    // æ’­æ”¾æç¤ºéŸ³
                    if (navigator.vibrate) {
                        navigator.vibrate([200, 100, 200]);
                    }
                }
            }, 1000);
        }

        function updateSmartRestTimerDisplay() {
            const minutes = Math.floor(smartRestTimeLeft / 60);
            const seconds = smartRestTimeLeft % 60;
            const display = `${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;

            // æ›´æ–°è®¡æ—¶å™¨æ–‡å­—
            const timerDisplay = document.getElementById('smart-rest-timer');
            timerDisplay.textContent = display;

            // æœ€å 10 ç§’å¿ƒè·³æ¨¡å¼
            const capsuleBody = document.getElementById('capsule-body');
            if (smartRestTimeLeft <= 10 && smartRestTimeLeft > 0) {
                // æ©™çº¢è‰²è¾¹æ¡† + å¤–å‘å…‰
                capsuleBody.classList.remove('border-white/10');
                capsuleBody.classList.add('border-orange-500/80', 'shadow-[0_0_40px_rgba(249,115,22,0.6)]', 'animate-pulse-fast');
                // çº¢è‰²æ•°å­—
                timerDisplay.classList.add('text-orange-400');
            } else {
                // æ¢å¤æ­£å¸¸æ ·å¼
                capsuleBody.classList.remove('border-orange-500/80', 'shadow-[0_0_40px_rgba(249,115,22,0.6)]', 'animate-pulse-fast');
                capsuleBody.classList.add('border-white/10');
                timerDisplay.classList.remove('text-orange-400');
            }
        }

        function initSmartRestButtons() {
            // ç»‘å®šè·³è¿‡æŒ‰é’®
            document.getElementById('smart-rest-skip-btn').addEventListener('click', function() {
                clearInterval(smartRestTimerInterval);
                smartRestTimerInterval = null;
                const capsule = document.getElementById('smart-rest-capsule');
                const capsuleBody = document.getElementById('capsule-body');
                const timerDisplay = document.getElementById('smart-rest-timer');
                capsule.classList.add('hidden');
                // é‡ç½®æ ·å¼ï¼ˆæ¢å¤å¯¹ç§°æ°´æ™¶ï¼‰
                capsuleBody.classList.remove('border-orange-500/80', 'shadow-[0_0_40px_rgba(249,115,22,0.6)]', 'animate-pulse-fast');
                capsuleBody.classList.add('border-white/10');
                timerDisplay.classList.remove('text-orange-400');
            });

            // ç»‘å®šå‡10ç§’æŒ‰é’®
            document.getElementById('smart-rest-minus-btn').addEventListener('click', function() {
                if (smartRestTimeLeft > 10) {
                    smartRestTimeLeft -= 10;
                    // æ›´æ–°åˆå§‹æ—¶é•¿ï¼Œé¿å…è¿›åº¦æ¡è·³åŠ¨
                    smartRestInitialDuration = Math.max(smartRestInitialDuration - 10, smartRestTimeLeft);
                    updateSmartRestTimerDisplay();
                    if (navigator.vibrate) {
                        navigator.vibrate(10);
                    }
                }
            });

            // ç»‘å®šåŠ 10ç§’æŒ‰é’®
            document.getElementById('smart-rest-plus-btn').addEventListener('click', function() {
                smartRestTimeLeft += 10;
                smartRestInitialDuration += 10; // åŒæ­¥å¢åŠ åˆå§‹æ—¶é•¿
                updateSmartRestTimerDisplay();
                if (navigator.vibrate) {
                    navigator.vibrate(10);
                }
            });
        }

        // ç”µå½±çº§ä¸æ»‘æ²‰åº•åŠ¨ç”» - FLIPæŠ€æœ¯å®ç°
        function cinematicSinkAnimation(exerciseId, callback) {
            const card = document.querySelector(`[data-exercise-id="${exerciseId}"]`);
            if (!card) {
                console.log('[Cinematic Sink] å¡ç‰‡ä¸å­˜åœ¨ï¼Œç›´æ¥æ‰§è¡Œå›è°ƒ');
                if (callback) callback();
                return;
            }

            console.log('[Cinematic Sink] å¼€å§‹åŠ¨ç”»ï¼ŒexerciseId:', exerciseId);

            // éœ‡åŠ¨åé¦ˆ
            if (navigator.vibrate) {
                navigator.vibrate([30, 50, 30]);
            }

            // é˜¶æ®µ1ï¼šæµ®èµ· (600ms)
            console.log('[Cinematic Sink] é˜¶æ®µ1ï¼šæµ®èµ·');
            card.classList.add('sinking-float-up');
            card.style.zIndex = '1000';
            card.style.position = 'relative';

            setTimeout(() => {
                // é˜¶æ®µ2ï¼šæ‚¬æµ®å‘¼å¸ (800ms)
                console.log('[Cinematic Sink] é˜¶æ®µ2ï¼šæ‚¬æµ®å‘¼å¸');
                card.classList.remove('sinking-float-up');
                card.classList.add('sinking-hover-breathe');

                setTimeout(() => {
                    // é˜¶æ®µ3ï¼šæ‰§è¡Œæ’åºå¹¶è®¡ç®—ç›®æ ‡ä½ç½®
                    // First: è®°å½•å½“å‰ä½ç½®å’ŒçŠ¶æ€
                    console.log('[Cinematic Sink] é˜¶æ®µ3ï¼šè®°å½•ä½ç½®å¹¶æ‰§è¡Œå›è°ƒ');
                    const firstRect = card.getBoundingClientRect();
                    const cardHTML = card.outerHTML; // ä¿å­˜å¡ç‰‡çš„HTML

                    console.log('[Cinematic Sink] åŸå§‹ä½ç½®:', firstRect.top, firstRect.left);

                    // æ‰§è¡Œå›è°ƒï¼ˆä¼šè§¦å‘é‡æ–°æ¸²æŸ“å’Œæ’åºï¼‰
                    if (callback) callback();

                    // ç­‰å¾…DOMæ›´æ–°
                    requestAnimationFrame(() => {
                        requestAnimationFrame(() => {
                            // æ‰¾åˆ°æ›´æ–°åçš„å¡ç‰‡å…ƒç´ 
                            const updatedCard = document.querySelector(`[data-exercise-id="${exerciseId}"]`);
                            if (!updatedCard) {
                                console.log('[Cinematic Sink] æ›´æ–°åå¡ç‰‡æœªæ‰¾åˆ°');
                                return;
                            }

                            // Last: è®°å½•æ–°ä½ç½®
                            const lastRect = updatedCard.getBoundingClientRect();
                            console.log('[Cinematic Sink] æ–°ä½ç½®:', lastRect.top, lastRect.left);

                            // Invert: è®¡ç®—ä½ç§»å¹¶åº”ç”¨
                            const deltaY = firstRect.top - lastRect.top;
                            const deltaX = firstRect.left - lastRect.left;
                            console.log('[Cinematic Sink] éœ€è¦ç§»åŠ¨:', deltaY, 'px (Y),', deltaX, 'px (X)');

                            // åˆ›å»ºåŠ¨ç”»è¿‡æ¸¡
                            updatedCard.style.transition = 'none';
                            updatedCard.style.transform = `translate(${deltaX}px, ${deltaY}px) scale(1.08)`;
                            updatedCard.style.zIndex = '1000';

                            // å¼ºåˆ¶é‡ç»˜
                            updatedCard.offsetHeight;

                            // Play: æ‰§è¡ŒåŠ¨ç”»
                            console.log('[Cinematic Sink] æ‰§è¡Œä¸‹æ²‰åŠ¨ç”»');
                            requestAnimationFrame(() => {
                                updatedCard.style.transition = 'transform 1.2s cubic-bezier(0.23, 1, 0.32, 1)';
                                updatedCard.style.transform = 'translate(0, 0) scale(1)';

                                // é˜¶æ®µ4ï¼šè½åœ°å®Œæˆåæ¸…ç†
                                setTimeout(() => {
                                    console.log('[Cinematic Sink] åŠ¨ç”»å®Œæˆï¼Œæ¸…ç†æ ·å¼');
                                    updatedCard.style.zIndex = '';
                                    updatedCard.style.transition = '';
                                }, 1200);
                            });
                        });
                    });
                }, 800);
            }, 600);
        }

        function showCelebrationInline(exerciseName) {
            // è°ƒç”¨æ–°çš„å®Œæˆèƒ¶å›Šå‡½æ•°
            showCompletionCapsule(exerciseName);
        }

        function updateRings(plan) {
            let strengthTotal = 0;
            let strengthCompleted = 0;
            let cardioTotal = 0;
            let cardioCompleted = 0;

            plan.forEach(exercise => {
                if (exercise.type === 'cardio') {
                    cardioTotal += 1;
                    if (exercise.completed) {
                        cardioCompleted += 1;
                    }
                } else {
                    // é»˜è®¤ä¸ºåŠ›é‡è®­ç»ƒ
                    strengthTotal += exercise.targetSets;
                    strengthCompleted += exercise.doneSets;
                }
            });

            document.getElementById('total-progress').textContent = strengthCompleted + cardioCompleted;

            // åŠ›é‡è®­ç»ƒå¤–åœˆç™¾åˆ†æ¯” (r=110, 2*Ï€*110=691.15)
            const strengthPercent = strengthTotal > 0 ? (strengthCompleted / strengthTotal) * 100 : 0;
            const outerCircumference = 691.15;
            const outerOffset = outerCircumference - (outerCircumference * Math.min(Math.max(strengthPercent, 1) / 100, 1));

            // æœ‰æ°§è®­ç»ƒå†…åœˆç™¾åˆ†æ¯” (r=88, 2*Ï€*88=552.92)
            const cardioPercent = cardioTotal > 0 ? (cardioCompleted / cardioTotal) * 100 : 0;
            const innerCircumference = 552.92;
            const innerOffset = innerCircumference - (innerCircumference * Math.min(Math.max(cardioPercent, 1) / 100, 1));

            // æ›´æ–°SVGåœ†ç¯
            const outerRing = document.getElementById('outer-ring');
            const innerRing = document.getElementById('inner-ring');
            if (outerRing) outerRing.style.strokeDashoffset = outerOffset;
            if (innerRing) innerRing.style.strokeDashoffset = innerOffset;
        }

        function updateBodyDataDisplay() {
            const bodyData = getBodyData();
            document.getElementById('body-weight').textContent = bodyData.weight || '--';
            document.getElementById('body-fat').textContent = bodyData.bodyFat || '--';
        }

        function updatePRList(plan) {
            const prList = document.getElementById('pr-list');

            if (plan.length === 0) {
                prList.innerHTML = '<p class="text-gray-500 dark:text-zinc-600 text-sm text-center py-4">æš‚æ— è®°å½•</p>';
                return;
            }

            let html = '';
            plan.forEach(exercise => {
                let shouldDisplay, detailText, progressText;

                if (exercise.type === 'cardio') {
                    // æœ‰æ°§è®­ç»ƒ
                    shouldDisplay = exercise.completed;
                    detailText = `${exercise.duration}åˆ†é’Ÿ`;
                    progressText = 'âœ“ å®Œæˆ';
                } else {
                    // åŠ›é‡è®­ç»ƒ
                    shouldDisplay = exercise.doneSets > 0;

                    // è®¡ç®—é‡é‡æ˜¾ç¤ºï¼ˆå…¼å®¹æ–°æ—§æ•°æ®æ ¼å¼ï¼‰
                    let weightText = '';
                    if (exercise.weightLogs && exercise.weightLogs.length > 0) {
                        // æ–°æ ¼å¼ï¼šå¯¹è±¡æ•°ç»„ [{weight, setNumber, timestamp}]
                        const weights = exercise.weightLogs.map(log =>
                            typeof log === 'object' ? log.weight : log
                        );
                        const maxWeight = Math.max(...weights);
                        const minWeight = Math.min(...weights);
                        if (minWeight === maxWeight) {
                            weightText = `${maxWeight}kg `;
                        } else {
                            weightText = `${minWeight}-${maxWeight}kg `;
                        }
                    } else if (exercise.initialWeight > 0) {
                        weightText = `${exercise.initialWeight}kg `;
                    }

                    detailText = `${weightText}${exercise.targetSets}ç»„ Ã— ${exercise.reps}æ¬¡`;
                    progressText = `${exercise.doneSets} / ${exercise.targetSets}`;
                }

                if (shouldDisplay) {
                    html += `
                        <div class="flex justify-between items-center bg-white dark:bg-black/20 rounded-xl p-3 border border-zinc-200 dark:border-white/5 shadow-sm dark:shadow-none">
                            <div>
                                <span class="text-gray-900 dark:text-white font-semibold">${exercise.name}</span>
                                <p class="text-gray-500 dark:text-zinc-500 text-xs">${detailText}</p>
                            </div>
                            <div class="text-right">
                                <span class="text-black dark:text-[#A3FF00] font-black">${progressText}</span>
                                <p class="text-gray-500 dark:text-zinc-500 text-xs">${exercise.type === 'cardio' ? 'å·²å®Œæˆ' : 'ç»„æ•°'}</p>
                            </div>
                        </div>
                    `;
                }
            });

            if (!html) {
                html = '<p class="text-gray-500 dark:text-zinc-600 text-sm text-center py-4">æš‚æ— è®°å½•</p>';
            }

            prList.innerHTML = html;
        }

        // æ¸…ç©ºæŒ‰é’®äº‹ä»¶
        function initClearButton() {
            document.getElementById('clear-all-btn').addEventListener('click', function() {
                if (confirm('ç¡®å®šè¦æ¸…ç©ºä»Šæ—¥è®¡åˆ’å—ï¼Ÿ')) {
                    const today = new Date().toDateString();
                    localStorage.removeItem('ironlog_plan_' + today);

                    // åŒæ—¶æ¸…ç©ºæ–°ç³»ç»Ÿçš„æ•°æ®
                    todayPlans = [];
                    saveData();
                    updateUI();

                    // æ¸…ç©ºåè‡ªåŠ¨å±•å¼€æ§åˆ¶é¢æ¿
                    initControlPanelState();
                }
            });
        }

        // åˆå§‹åŒ– V4.0 æ–°åŠŸèƒ½äº‹ä»¶ç›‘å¬å™¨
        function initV4Features() {
            // ä¸»é¢˜åˆ‡æ¢æŒ‰é’®
            const themeToggleBtn = document.getElementById('theme-toggle-btn');
            if (themeToggleBtn) {
                themeToggleBtn.addEventListener('click', function() {
                    toggleTheme();
                });
            }

            // åŠ¨ä½œå®Œæˆè¦†ç›–å±‚ - ç»§ç»­ä¸‹ä¸€é¡¹æŒ‰é’®
            const nextExerciseBtn = document.getElementById('next-exercise-btn');
            if (nextExerciseBtn) {
                nextExerciseBtn.addEventListener('click', function() {
                    // æš‚æ—¶ç¦ç”¨æ­¤åŠŸèƒ½
                    console.log('Next exercise feature not yet implemented');
                });
            }

            // åŠ¨ä½œå®Œæˆè¦†ç›–å±‚ - å®ŒæˆæŒ‰é’®
            const finishExerciseBtn = document.getElementById('finish-exercise-btn');
            if (finishExerciseBtn) {
                finishExerciseBtn.addEventListener('click', function() {
                    const overlay = document.getElementById('exercise-complete-overlay');
                    if (overlay) {
                        overlay.classList.add('hidden');
                        overlay.style.display = 'none';
                    }
                });
            }

            // ç»“æŸè®­ç»ƒæŒ‰é’®
            const endSessionBtn = document.getElementById('end-session-btn');
            if (endSessionBtn) {
                endSessionBtn.addEventListener('click', function() {
                    if (confirm('ç¡®å®šè¦ç»“æŸä»Šå¤©çš„è®­ç»ƒå—ï¼Ÿ')) {
                        // åœæ­¢è®¡æ—¶å™¨
                        if (sessionTimerInterval) {
                            clearInterval(sessionTimerInterval);
                            sessionTimerInterval = null;
                        }
                        sessionStartTime = null;
                        endSessionBtn.classList.add('hidden');

                        // æ˜¾ç¤ºè®­ç»ƒæ€»ç»“
                        showWorkoutSummary();
                    }
                });
            }
        }

        // æ˜¾ç¤ºè®­ç»ƒæ€»ç»“
        function showWorkoutSummary() {
            const plan = getTodaysPlan();
            if (!plan || plan.length === 0) return;

            // è®¡ç®—ç»Ÿè®¡æ•°æ®
            let totalExercises = 0;
            let completedExercises = 0;
            let totalSets = 0;
            let completedSets = 0;

            plan.forEach(exercise => {
                if (exercise.type === 'cardio') {
                    totalExercises++;
                    if (exercise.completed) {
                        completedExercises++;
                    }
                } else {
                    totalExercises++;
                    totalSets += exercise.targetSets;
                    completedSets += exercise.doneSets;
                    if (exercise.doneSets >= exercise.targetSets) {
                        completedExercises++;
                    }
                }
            });

            // æ ¼å¼åŒ–è®­ç»ƒæ—¶é—´
            const minutes = Math.floor(sessionElapsedTime / 60);
            const seconds = sessionElapsedTime % 60;
            const timeStr = `${minutes}åˆ†${seconds}ç§’`;

            // åˆ›å»ºæ€»ç»“å¼¹çª—
            const overlay = document.createElement('div');
            overlay.className = 'fixed inset-0 bg-black/60 backdrop-blur-sm z-50 flex items-center justify-center p-4';
            overlay.innerHTML = `
                <div class="bg-white dark:bg-zinc-900 rounded-3xl p-8 max-w-md w-full shadow-2xl animate-fade-in">
                    <h2 class="text-2xl font-black text-gray-900 dark:text-white mb-6 text-center">ğŸ‰ è®­ç»ƒå®Œæˆï¼</h2>

                    <div class="space-y-4 mb-8">
                        <div class="flex justify-between items-center p-4 bg-zinc-50 dark:bg-zinc-800 rounded-xl">
                            <span class="text-gray-600 dark:text-zinc-400">è®­ç»ƒæ—¶é•¿</span>
                            <span class="text-xl font-bold text-[#A3FF00]">${timeStr}</span>
                        </div>
                        <div class="flex justify-between items-center p-4 bg-zinc-50 dark:bg-zinc-800 rounded-xl">
                            <span class="text-gray-600 dark:text-zinc-400">å®ŒæˆåŠ¨ä½œ</span>
                            <span class="text-xl font-bold text-gray-900 dark:text-white">${completedExercises}/${totalExercises}</span>
                        </div>
                        <div class="flex justify-between items-center p-4 bg-zinc-50 dark:bg-zinc-800 rounded-xl">
                            <span class="text-gray-600 dark:text-zinc-400">å®Œæˆç»„æ•°</span>
                            <span class="text-xl font-bold text-gray-900 dark:text-white">${completedSets}/${totalSets}</span>
                        </div>
                    </div>

                    <button onclick="this.closest('.fixed').remove()" class="w-full py-4 bg-[#A3FF00] hover:bg-[#9add00] text-black font-black rounded-xl transition-colors duration-200 active:scale-95">
                        å¤ªæ£’äº†ï¼
                    </button>
                </div>
            `;

            document.body.appendChild(overlay);

            // ç‚¹å‡»èƒŒæ™¯å…³é—­
            overlay.addEventListener('click', function(e) {
                if (e.target === overlay) {
                    overlay.remove();
                }
            });
        }

        // æ›´æ–°æ—¥æœŸæ˜¾ç¤º - ä¸­æ–‡æ ¼å¼
        function updateDateDisplay() {
            const now = new Date();
            const days = ['æ˜ŸæœŸæ—¥', 'æ˜ŸæœŸä¸€', 'æ˜ŸæœŸäºŒ', 'æ˜ŸæœŸä¸‰', 'æ˜ŸæœŸå››', 'æ˜ŸæœŸäº”', 'æ˜ŸæœŸå…­'];
            const dayName = days[now.getDay()];
            const month = now.getMonth() + 1;
            const date = now.getDate();
            const dateStr = `${dayName} Â· ${month}æœˆ${date}æ—¥`;
            document.getElementById('current-date').textContent = dateStr;
        }

        // ============ è·Ÿç»ƒæ¨¡å¼ ============

        let currentExerciseIndex = null;
        let currentExercise = null;

        // ============ è‡ªåŠ¨è®¡æ—¶ç³»ç»Ÿ ============

        let sessionStartTime = null;
        let sessionTimerInterval = null;
        let sessionElapsedTime = 0;

        function startSessionTimer() {
            console.log('[SessionTimer] å¯åŠ¨ä¼šè¯è®¡æ—¶å™¨');
            if (sessionStartTime === null) {
                sessionStartTime = new Date();
                sessionTimerInterval = setInterval(updateSessionTimer, 1000);

                // æ˜¾ç¤ºæ§åˆ¶å…ƒç´ 
                const endBtn = document.getElementById('end-session-btn');
                const timerContainer = document.getElementById('timer-container');
                const statusDot = document.getElementById('status-dot');

                console.log('[SessionTimer] æ˜¾ç¤ºæ§åˆ¶å…ƒç´ ');
                console.log('[SessionTimer] endBtn:', endBtn);
                console.log('[SessionTimer] timerContainer:', timerContainer);
                console.log('[SessionTimer] statusDot:', statusDot);

                if (endBtn) endBtn.classList.remove('hidden');
                if (timerContainer) timerContainer.classList.remove('hidden');
                if (statusDot) statusDot.classList.remove('hidden');

                console.log('[SessionTimer] æ§åˆ¶å…ƒç´ å·²æ˜¾ç¤º');
            }
        }

        function updateSessionTimer() {
            sessionElapsedTime++;
            const minutes = Math.floor(sessionElapsedTime / 60);
            const seconds = sessionElapsedTime % 60;
            const display = `${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
            document.getElementById('session-timer').textContent = display;
        }

        function stopSessionTimer() {
            if (sessionTimerInterval) {
                clearInterval(sessionTimerInterval);
                sessionTimerInterval = null;
            }

            if (sessionStartTime) {
                const endTime = new Date();
                const totalMinutes = Math.round((endTime - sessionStartTime) / 60000);
                alert(`è®­ç»ƒç»“æŸï¼æ€»æ—¶é•¿ï¼š${totalMinutes} åˆ†é’Ÿ`);

                // ä¿å­˜è®­ç»ƒæ—¶é•¿åˆ° localStorage
                const today = new Date().toDateString();
                const sessionKey = `ironlog_session_${today}`;
                const sessionData = {
                    date: today,
                    startTime: sessionStartTime.toISOString(),
                    endTime: endTime.toISOString(),
                    totalMinutes: totalMinutes,
                    completedExercises: sessionElapsedTime
                };
                localStorage.setItem(sessionKey, JSON.stringify(sessionData));
            }

            // é‡ç½®
            sessionStartTime = null;
            sessionElapsedTime = 0;
            document.getElementById('session-timer').textContent = '00:00';
            // éšè—æ‰€æœ‰æ§åˆ¶å…ƒç´ 
            document.getElementById('end-session-btn').classList.add('hidden');
            document.getElementById('timer-container').classList.add('hidden');
            document.getElementById('status-dot').classList.add('hidden');
        }

        function openWorkoutMode(index) {
            const plan = getTodaysPlan();
            currentExerciseIndex = index;
            currentExercise = plan[index];

            if (!currentExercise) {
                alert('æ‰¾ä¸åˆ°è®­ç»ƒåŠ¨ä½œï¼Œè¯·é‡è¯•');
                return;
            }

            document.getElementById('workout-exercise-name').textContent = currentExercise.name;

            if (currentExercise.type === 'cardio') {
                // æœ‰æ°§è®­ç»ƒ
                document.getElementById('workout-target').textContent = `ç›®æ ‡ï¼š${currentExercise.duration}åˆ†é’Ÿ`;
                // éšè—é‡é‡è¾“å…¥åŒº
                document.querySelector('#workout-mode > div.px-8.mb-6').style.display = 'none';
            } else {
                // åŠ›é‡è®­ç»ƒ
                let weightText = '';
                if (currentExercise.weightLogs && currentExercise.weightLogs.length > 0) {
                    // å…¼å®¹æ–°æ—§æ•°æ®æ ¼å¼
                    const weights = currentExercise.weightLogs.map(log =>
                        typeof log === 'object' ? log.weight : log
                    );
                    const maxWeight = Math.max(...weights);
                    const minWeight = Math.min(...weights);
                    weightText = minWeight === maxWeight ? `${maxWeight}kg ` : `${minWeight}-${maxWeight}kg `;
                } else if (currentExercise.initialWeight > 0) {
                    weightText = `${currentExercise.initialWeight}kg `;
                }

                // æ˜¾ç¤ºé‡é‡è¾“å…¥åŒºå¹¶è®¾ç½®åˆå§‹å€¼
                document.querySelector('#workout-mode > div.px-8.mb-6').style.display = 'block';

                // è®¾ç½®å½“å‰é‡é‡è¾“å…¥æ¡†çš„å€¼ï¼ˆå…¼å®¹æ–°æ—§æ•°æ®æ ¼å¼ï¼‰
                let currentWeight;
                let currentReps = currentExercise.reps || 10;  // é»˜è®¤æ¬¡æ•°
                const currentSetNumber = currentExercise.doneSets;  // å½“å‰è¦åšçš„æ˜¯ç¬¬å‡ ç»„

                // ä¼˜å…ˆä½¿ç”¨ plannedSets çš„æ•°æ®
                if (currentExercise.plannedSets && currentExercise.plannedSets.length > currentSetNumber) {
                    const plannedSet = currentExercise.plannedSets[currentSetNumber];
                    currentWeight = plannedSet.weight;
                    currentReps = plannedSet.reps;
                } else if (currentExercise.weightLogs && currentExercise.weightLogs.length > 0) {
                    // å¦‚æœå·²ç»æœ‰è®°å½•çš„ç»„æ•°ï¼Œä½¿ç”¨æœ€åä¸€ç»„çš„é‡é‡
                    const lastLog = currentExercise.weightLogs[currentExercise.weightLogs.length - 1];
                    currentWeight = typeof lastLog === 'object' ? lastLog.weight : lastLog;
                } else {
                    // å¦åˆ™ä½¿ç”¨åˆå§‹é‡é‡
                    currentWeight = currentExercise.initialWeight || 0;
                }

                document.getElementById('current-set-weight').value = currentWeight;
                document.getElementById('current-set-reps').value = currentReps;  // è®¾ç½®æ¬¡æ•°è¾“å…¥æ¡†çš„é»˜è®¤å€¼

                // æ˜¾ç¤ºä¸Šä¸€ç»„çš„é‡é‡æç¤º
                const historyHint = document.getElementById('weight-history-hint');
                const lastWeightSpan = document.getElementById('last-weight');

                // ä¼˜å…ˆæ˜¾ç¤ºä¸Šä¸€ç»„çš„å®é™…å®Œæˆæ•°æ®
                if (currentExercise.weightLogs && currentExercise.weightLogs.length > 0) {
                    historyHint.classList.remove('hidden');
                    const lastLog = currentExercise.weightLogs[currentExercise.weightLogs.length - 1];
                    lastWeightSpan.textContent = typeof lastLog === 'object' ? lastLog.weight : lastLog;
                } else if (currentExercise.plannedSets && currentExercise.plannedSets.length > 0 && currentSetNumber > 0) {
                    // å¦‚æœè¿˜æ²¡æœ‰å®Œæˆè¿‡ç»„ï¼Œä½†æœ‰è®¡åˆ’æ•°æ®ï¼Œæ˜¾ç¤ºä¸Šä¸€ç»„çš„è®¡åˆ’æ•°æ®
                    historyHint.classList.remove('hidden');
                    lastWeightSpan.textContent = currentExercise.plannedSets[currentSetNumber - 1].weight;
                } else {
                    historyHint.classList.add('hidden');
                }

                // æ›´æ–°ç›®æ ‡æ˜¾ç¤ºä¸­çš„æ¬¡æ•°
                document.getElementById('workout-target').textContent =
                    `ç›®æ ‡ï¼š${weightText}${currentExercise.targetSets}ç»„ Ã— ${currentReps}æ¬¡`;
            }

            updateWorkoutProgress();
            updateCompleteButtonState();

            document.getElementById('workout-mode').classList.remove('hidden');
            document.body.style.overflow = 'hidden';
        }

        function closeWorkoutMode() {
            document.getElementById('workout-mode').classList.add('hidden');
            document.body.style.overflow = 'auto';
            currentExerciseIndex = null;
            currentExercise = null;
        }

        function updateWorkoutProgress() {
            if (currentExercise.type === 'cardio') {
                // æœ‰æ°§è®­ç»ƒï¼šæ˜¾ç¤ºå®ŒæˆçŠ¶æ€
                document.getElementById('workout-progress').textContent = currentExercise.completed ? 'âœ“ å®Œæˆ' : 'æœªå®Œæˆ';
            } else {
                // åŠ›é‡è®­ç»ƒï¼šæ˜¾ç¤ºç»„æ•°è¿›åº¦
                document.getElementById('workout-progress').textContent = `${currentExercise.doneSets} / ${currentExercise.targetSets}`;
            }
        }

        function updateCompleteButtonState() {
            const btn = document.getElementById('complete-set-btn');

            if (currentExercise.type === 'cardio') {
                // æœ‰æ°§è®­ç»ƒï¼šå·²å®Œæˆåˆ™ç¦ç”¨
                if (currentExercise.completed) {
                    btn.classList.add('opacity-50', 'cursor-not-allowed');
                    btn.classList.remove('hover:shadow-lg');
                    btn.disabled = true;
                } else {
                    btn.classList.remove('opacity-50', 'cursor-not-allowed');
                    btn.classList.add('hover:shadow-lg');
                    btn.disabled = false;
                }
            } else {
                // åŠ›é‡è®­ç»ƒï¼šæ£€æŸ¥æ˜¯å¦å®Œæˆæ‰€æœ‰ç»„æ•°
                if (currentExercise.doneSets >= currentExercise.targetSets) {
                    btn.classList.add('opacity-50', 'cursor-not-allowed');
                    btn.classList.remove('hover:shadow-lg');
                    btn.disabled = true;
                } else {
                    btn.classList.remove('opacity-50', 'cursor-not-allowed');
                    btn.classList.add('hover:shadow-lg');
                    btn.disabled = false;
                }
            }
        }

        function initWorkoutMode() {
            const completeBtn = document.getElementById('complete-set-btn');
            const closeBtn = document.getElementById('close-workout-btn');

            completeBtn.addEventListener('click', function() {
                if (!currentExercise) return;

                // ç¬¬ä¸€æ¬¡å®Œæˆä¸€ç»„æ—¶ï¼Œå¯åŠ¨è®¡æ—¶å™¨
                startSessionTimer();

                if (currentExercise.type === 'cardio') {
                    // æœ‰æ°§è®­ç»ƒï¼šç›´æ¥æ ‡è®°å®Œæˆ
                    if (currentExercise.completed) {
                        return;
                    }

                    currentExercise.completed = true;

                    const plan = getTodaysPlan();
                    plan[currentExerciseIndex] = currentExercise;
                    saveTodaysPlan(plan);

                    updateWorkoutProgress();
                    updateCompleteButtonState();

                    // æ˜¾ç¤ºåŠ¨ä½œå®Œæˆè¦†ç›–å±‚
                    showExerciseCompleteOverlay();
                } else {
                    // åŠ›é‡è®­ç»ƒï¼šæ£€æŸ¥æ˜¯å¦å·²å®Œæˆ
                    if (currentExercise.doneSets >= currentExercise.targetSets) {
                        return;
                    }

                    // è·å–å½“å‰é‡é‡å’Œæ¬¡æ•°
                    const currentWeight = parseFloat(document.getElementById('current-set-weight').value) || 0;
                    const currentReps = parseInt(document.getElementById('current-set-reps').value) || currentExercise.reps;

                    if (!currentExercise.weightLogs) {
                        currentExercise.weightLogs = [];
                    }

                    // è®°å½•è¯¦ç»†çš„é‡é‡æ—¥å¿—ï¼ŒåŒ…å«å®é™…å®Œæˆçš„æ¬¡æ•°
                    currentExercise.weightLogs.push({
                        weight: currentWeight,
                        reps: currentReps,
                        setNumber: currentExercise.doneSets + 1,
                        timestamp: new Date().toISOString()
                    });

                    // ç«‹å³å¢åŠ ç»„æ•°å¹¶ä¿å­˜
                    currentExercise.doneSets++;

                    const plan = getTodaysPlan();
                    plan[currentExerciseIndex] = currentExercise;
                    saveTodaysPlan(plan);

                    updateWorkoutProgress();
                    updateCompleteButtonState();

                    // æ£€æŸ¥æ˜¯å¦å®Œæˆæ‰€æœ‰ç»„æ•°
                    if (currentExercise.doneSets >= currentExercise.targetSets) {
                        // å…¨éƒ¨å®Œæˆï¼æ˜¾ç¤ºåŠ¨ä½œå®Œæˆè¦†ç›–å±‚
                        showExerciseCompleteOverlay();
                    } else {
                        // è¿˜æœ‰ç»„æ•°æœªå®Œæˆï¼Œå¼€å§‹å€’è®¡æ—¶
                        startRestTimer();
                    }
                }
            });

            closeBtn.addEventListener('click', function() {
                closeWorkoutMode();
                updateUI();
            });
        }

        // ============ ä¼‘æ¯å€’è®¡æ—¶ ============

        let timerInterval = null;
        let timeLeft = 90;
        let isTimerMinimized = false;  // è·Ÿè¸ªå€’è®¡æ—¶æ˜¯å¦æœ€å°åŒ–

        function startRestTimer() {
            // ä½¿ç”¨å½“å‰åŠ¨ä½œçš„ä¼‘æ¯æ—¶é—´
            const restTime = currentExercise.restTime || 90;
            timeLeft = restTime;
            isTimerMinimized = false;  // é‡ç½®æœ€å°åŒ–çŠ¶æ€

            const overlay = document.getElementById('rest-timer-overlay');
            const timerBar = document.getElementById('rest-timer-bar');
            const nextSetPreview = document.getElementById('next-set-preview');

            // éšè—æ‚¬æµ®æ¡ï¼Œæ˜¾ç¤ºå…¨å±é®ç½©
            timerBar.classList.add('hidden');
            overlay.classList.remove('hidden');
            overlay.style.display = 'flex';
            overlay.style.zIndex = '9999';

            // æ˜¾ç¤ºä¸‹ä¸€ç»„é¢„å‘Š
            updateNextSetPreview(nextSetPreview);

            // æ¸…é™¤æ—§çš„å®šæ—¶å™¨
            if (timerInterval) {
                clearInterval(timerInterval);
                timerInterval = null;
            }

            // ä½¿ç”¨å±€éƒ¨å˜é‡ç¡®ä¿å€’è®¡æ—¶æ­£å¸¸å·¥ä½œ
            let countdown = restTime;

            // ç«‹å³æ›´æ–°ä¸€æ¬¡æ˜¾ç¤º
            updateTimerDisplay(countdown);

            timerInterval = setInterval(() => {
                countdown--;
                timeLeft = countdown;

                updateTimerDisplay(countdown);

                if (countdown <= 0) {
                    clearInterval(timerInterval);
                    timerInterval = null;
                    completeSetAndStopTimer();
                }
            }, 1000);
        }

        // æ›´æ–°ä¸‹ä¸€ç»„é¢„å‘Š
        function updateNextSetPreview(previewElement) {
            if (!currentExercise || currentExercise.type === 'cardio') {
                previewElement.classList.add('hidden');
                return;
            }

            const nextSetNumber = currentExercise.doneSets;  // ä¸‹ä¸€ç»„çš„ç¼–å·
            let nextWeight = null;
            let nextReps = currentExercise.reps || 10;

            // ä¼˜å…ˆä» plannedSets è·å–ä¸‹ä¸€ç»„æ•°æ®
            if (currentExercise.plannedSets && currentExercise.plannedSets.length > nextSetNumber) {
                nextWeight = currentExercise.plannedSets[nextSetNumber].weight;
                nextReps = currentExercise.plannedSets[nextSetNumber].reps;
            } else if (currentExercise.weightLogs && currentExercise.weightLogs.length > 0) {
                // ä½¿ç”¨å½“å‰ç»„çš„é‡é‡
                const lastLog = currentExercise.weightLogs[currentExercise.weightLogs.length - 1];
                nextWeight = typeof lastLog === 'object' ? lastLog.weight : lastLog;
            } else {
                nextWeight = currentExercise.initialWeight || 0;
            }

            // å¦‚æœè¿˜æœ‰ä¸‹ä¸€ç»„ï¼Œæ˜¾ç¤ºé¢„å‘Š
            if (nextSetNumber < currentExercise.targetSets) {
                previewElement.classList.remove('hidden');
                previewElement.innerHTML = `ä¸‹ä¸€ç»„: <span class="text-[#A3FF00] font-semibold">${nextWeight}kg Ã— ${nextReps}</span>`;
            } else {
                previewElement.classList.add('hidden');
            }
        }

        function updateTimerDisplay(countdown) {
            const minutes = Math.floor(countdown / 60);
            const seconds = countdown % 60;
            const display = `${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;

            // æ›´æ–°å…¨å±æ˜¾ç¤º
            document.getElementById('timer-display').textContent = display;
            // æ›´æ–°æ‚¬æµ®æ¡æ˜¾ç¤º
            document.getElementById('timer-bar-display').textContent = display;
        }

        function minimizeTimer() {
            isTimerMinimized = true;
            const overlay = document.getElementById('rest-timer-overlay');
            const timerBar = document.getElementById('rest-timer-bar');

            // éšè—å…¨å±é®ç½©
            overlay.classList.add('hidden');
            overlay.style.display = 'none';

            // æ˜¾ç¤ºæ‚¬æµ®æ¡
            timerBar.classList.remove('hidden');
        }

        function maximizeTimer() {
            isTimerMinimized = false;
            const overlay = document.getElementById('rest-timer-overlay');
            const timerBar = document.getElementById('rest-timer-bar');

            // éšè—æ‚¬æµ®æ¡
            timerBar.classList.add('hidden');

            // æ˜¾ç¤ºå…¨å±é®ç½©
            overlay.classList.remove('hidden');
            overlay.style.display = 'flex';
        }

        function completeSetAndStopTimer() {
            // å€’è®¡æ—¶ç»“æŸï¼Œåªéœ€åœæ­¢è®¡æ—¶å™¨
            // ç»„æ•°å·²ç»åœ¨ç‚¹å‡»æŒ‰é’®æ—¶å¢åŠ äº†
            stopRestTimer();
        }

        function stopRestTimer() {
            if (timerInterval) {
                clearInterval(timerInterval);
                timerInterval = null;
            }

            isTimerMinimized = false;

            const overlay = document.getElementById('rest-timer-overlay');
            const timerBar = document.getElementById('rest-timer-bar');
            const nextSetPreview = document.getElementById('next-set-preview');

            // éšè—å…¨å±é®ç½©å’Œæ‚¬æµ®æ¡
            overlay.classList.add('hidden');
            overlay.style.display = 'none';
            overlay.style.zIndex = '';

            timerBar.classList.add('hidden');
            nextSetPreview.classList.add('hidden');  // éšè—ä¸‹ä¸€ç»„é¢„å‘Š
        }

        // ============ åº†ç¥å¼¹çª— ============

        function showExerciseCompleteOverlay() {
            document.getElementById('completed-exercise-name').textContent = currentExercise.name;
            document.getElementById('exercise-complete-overlay').classList.remove('hidden');
            document.getElementById('exercise-complete-overlay').style.display = 'flex';

            // æŸ¥æ‰¾ä¸‹ä¸€ä¸ªæœªå®Œæˆçš„åŠ¨ä½œ
            const plan = getTodaysPlan();
            const nextExercise = findNextIncompleteExercise(plan, currentExerciseIndex);
            const nextBtn = document.getElementById('next-exercise-btn');

            if (nextExercise) {
                nextBtn.textContent = `ç»§ç»­ï¼š${nextExercise.name}`;
                nextBtn.classList.remove('hidden');
            } else {
                nextBtn.classList.add('hidden');
            }
        }

        function findNextIncompleteExercise(plan, currentIndex) {
            for (let i = currentIndex + 1; i < plan.length; i++) {
                const exercise = plan[i];
                if (exercise.type === 'cardio') {
                    if (!exercise.completed) {
                        return exercise;
                    }
                } else {
                    if (exercise.doneSets < exercise.targetSets) {
                        return exercise;
                    }
                }
            }
            return null;
        }

        function showCelebration() {
            document.getElementById('celebration-text').textContent = `${currentExercise.name}å®Œæˆï¼`;
            document.getElementById('celebration-overlay').classList.remove('hidden');
        }

        function hideCelebration() {
            document.getElementById('celebration-overlay').classList.add('hidden');
            closeWorkoutMode();
            updateUI();
        }

        function initRestTimerOverlay() {
            // å…¨å±é®ç½©çš„è·³è¿‡æŒ‰é’®
            document.getElementById('skip-rest-btn').addEventListener('click', function() {
                completeSetAndStopTimer();
            });

            // å…¨å±é®ç½©çš„ç¼©å°æŒ‰é’®
            document.getElementById('minimize-timer-btn').addEventListener('click', function() {
                minimizeTimer();
            });

            // æ‚¬æµ®æ¡çš„è·³è¿‡æŒ‰é’®
            document.getElementById('timer-bar-skip-btn').addEventListener('click', function() {
                completeSetAndStopTimer();
            });

            // æ‚¬æµ®æ¡çš„æœ€å¤§åŒ–æŒ‰é’®
            document.getElementById('timer-bar-expand-btn').addEventListener('click', function() {
                maximizeTimer();
            });

            document.getElementById('add-30s-btn').addEventListener('click', function() {
                // æ·»åŠ 30ç§’
                timeLeft += 30;
                // æ›´æ–°æ˜¾ç¤º
                updateTimerDisplay(timeLeft);
            });

            document.getElementById('celebration-ok-btn').addEventListener('click', function() {
                hideCelebration();
            });
        }

        // ============ æ ‡ç­¾é¡µåˆ‡æ¢ ============

        function initTabNavigation() {
            const navItems = document.querySelectorAll('.nav-item');

            navItems.forEach(item => {
                item.addEventListener('click', function() {
                    const tabName = this.dataset.tab;
                    updateTab(tabName);
                });
            });

            // æ¢å¤ä¸Šæ¬¡é€‰æ‹©çš„ tab
            const lastTab = localStorage.getItem('ironlog_last_tab') || 'workout';
            updateTab(lastTab);
        }

        function updateTab(tabId) {
            // 1. åˆ‡æ¢ Tab å†…å®¹
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.toggle('hidden', content.id !== `tab-${tabId}`);
                content.classList.toggle('active', content.id === `tab-${tabId}`);
            });

            // 2. æ›´æ–°å¯¼èˆªæ ·å¼ (Liquid Capsule Logic)
            document.querySelectorAll('.nav-item').forEach(item => {
                const isActive = item.dataset.tab === tabId;

                // åˆ‡æ¢ Active çŠ¶æ€é’©å­ (ç”¨äºè§¦å‘ CSS åŠ¨ç”»)
                item.classList.toggle('nav-active', isActive);

                // æ¸…é™¤æ‰€æœ‰é¢œè‰²ç±»
                item.classList.remove(
                    'bg-black/5', 'text-black', // Light Active
                    'text-gray-400', // Light Inactive
                    'dark:bg-[#A3FF00]/15', 'dark:text-[#A3FF00]', // Dark Active (å…‰æ™•åŒ–)
                    'dark:text-zinc-500' // Dark Inactive
                );

                if (isActive) {
                    // === é€‰ä¸­çŠ¶æ€ ===
                    // Light: ææ·¡ç°åº• + é»‘å­— (Apple Style)
                    // Dark: 15%é€æ˜åº¦è§å…‰ç»¿å…‰æ™• + è§å…‰ç»¿å­—
                    item.classList.add('bg-black/5', 'text-black', 'dark:bg-[#A3FF00]/15', 'dark:text-[#A3FF00]');

                    // å›¾æ ‡å¡«å……åˆ‡æ¢ (é€‰ä¸­æ—¶å˜å®å¿ƒ)
                    const icon = item.querySelector('svg');
                    if(icon) icon.setAttribute('fill', 'currentColor');

                } else {
                    // === æœªé€‰ä¸­çŠ¶æ€ ===
                    // çº¯è‰²æ–‡å­—ï¼Œæ— èƒŒæ™¯
                    item.classList.add('text-gray-400', 'dark:text-zinc-500');

                    // å›¾æ ‡æ¢å¤çº¿æ¡†
                    const icon = item.querySelector('svg');
                    if(icon) icon.setAttribute('fill', 'none');
                }
            });

            // 3. ç‰¹æ®Šé¡µé¢åˆå§‹åŒ–
            if (tabId === 'calendar') {
                renderCalendar();
            }

            localStorage.setItem('ironlog_last_tab', tabId);
        }

        // ============ æ—¥å†é¡µé¢ ============

        let currentCalendarDate = new Date();

        function renderCalendar() {
            const grid = document.getElementById('calendar-grid');
            const monthTitle = document.getElementById('current-month');

            const year = currentCalendarDate.getFullYear();
            const month = currentCalendarDate.getMonth();

            monthTitle.textContent = `${year}å¹´${month + 1}æœˆ`;

            const firstDay = new Date(year, month, 1).getDay();
            const firstDayIndex = firstDay === 0 ? 6 : firstDay - 1;

            const daysInMonth = new Date(year, month + 1, 0).getDate();

            let html = '';

            for (let i = 0; i < firstDayIndex; i++) {
                html += '<div></div>';
            }

            for (let day = 1; day <= daysInMonth; day++) {
                const dateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                const dateKey = new Date(dateStr).toDateString();
                const stored = localStorage.getItem('ironlog_plan_' + dateKey);

                let bgClass = 'bg-gray-100 dark:bg-white/5';
                let textColor = 'text-gray-900 dark:text-white';

                if (stored) {
                    const plan = JSON.parse(stored);

                    // æ£€æŸ¥æ˜¯å¦æœ‰å®Œæˆçš„è®­ç»ƒ
                    const hasCompleted = plan.some(ex => {
                        if (ex.type === 'cardio') {
                            return ex.completed;
                        } else {
                            return ex.doneSets > 0;
                        }
                    });

                    // æ£€æŸ¥æ˜¯å¦å…¨éƒ¨å®Œæˆ
                    const allCompleted = plan.length > 0 && plan.every(ex => {
                        if (ex.type === 'cardio') {
                            return ex.completed;
                        } else {
                            return ex.doneSets >= ex.targetSets;
                        }
                    });

                    if (allCompleted) {
                        bgClass = 'bg-[#A3FF00]';
                        textColor = 'text-black';
                    } else if (hasCompleted) {
                        bgClass = 'bg-red-600/80';
                        textColor = 'text-white';
                    }
                }

                html += `
                    <div class="calendar-day aspect-square ${bgClass} ${textColor} rounded-lg flex items-center justify-center cursor-pointer hover:opacity-80 transition-colors duration-200" data-date="${dateStr}">
                        <span class="text-sm font-semibold">${day}</span>
                    </div>
                `;
            }

            grid.innerHTML = html;

            grid.querySelectorAll('.calendar-day').forEach(dayEl => {
                dayEl.addEventListener('click', function() {
                    const dateStr = this.dataset.date;
                    showDateDetails(dateStr);
                });
            });
        }

        function showDateDetails(dateStr) {
            const dateKey = new Date(dateStr).toDateString();
            const stored = localStorage.getItem('ironlog_plan_' + dateKey);

            const container = document.getElementById('selected-date-workout');
            const title = document.getElementById('selected-date-title');
            const content = document.getElementById('selected-date-content');

            const date = new Date(dateStr);
            title.textContent = `${date.getMonth() + 1}æœˆ${date.getDate()}æ—¥`;

            if (!stored) {
                content.innerHTML = '<p class="text-gray-500 dark:text-zinc-600 text-center py-4">æ— è®­ç»ƒè®°å½•</p>';
            } else {
                const plan = JSON.parse(stored);
                let html = '';

                plan.forEach(exercise => {
                    let isCompleted, statusClass, detailText;

                    if (exercise.type === 'cardio') {
                        // æœ‰æ°§è®­ç»ƒ
                        isCompleted = exercise.completed;
                        statusClass = isCompleted ? 'text-[#A3FF00]' : 'text-gray-900 dark:text-white';
                        detailText = `${exercise.duration}åˆ†é’Ÿ`;
                    } else {
                        // åŠ›é‡è®­ç»ƒ
                        isCompleted = exercise.doneSets >= exercise.targetSets;
                        statusClass = isCompleted ? 'text-[#A3FF00]' : 'text-gray-900 dark:text-white';

                        // è®¡ç®—é‡é‡æ˜¾ç¤ºï¼ˆå…¼å®¹æ–°æ—§æ•°æ®æ ¼å¼ï¼‰
                        let weightText = '';
                        if (exercise.weightLogs && exercise.weightLogs.length > 0) {
                            // æ–°æ ¼å¼ï¼šå¯¹è±¡æ•°ç»„ [{weight, setNumber, timestamp}]
                            const weights = exercise.weightLogs.map(log =>
                                typeof log === 'object' ? log.weight : log
                            );
                            const maxWeight = Math.max(...weights);
                            const minWeight = Math.min(...weights);
                            if (minWeight === maxWeight) {
                                weightText = `${maxWeight}kg `;
                            } else {
                                weightText = `${minWeight}-${maxWeight}kg `;
                            }
                        } else if (exercise.initialWeight > 0) {
                            weightText = `${exercise.initialWeight}kg `;
                        }

                        detailText = `${weightText}${exercise.doneSets} / ${exercise.targetSets}ç»„ Ã— ${exercise.reps}æ¬¡`;
                    }

                    html += `
                        <div class="bg-gray-100 dark:bg-black/20 rounded-lg p-3 mb-2 border border-gray-200 dark:border-white/5">
                            <span class="${statusClass} font-semibold">${exercise.name}</span>
                            <p class="text-gray-500 dark:text-zinc-400 text-sm">${detailText}</p>
                        </div>
                    `;
                });

                content.innerHTML = html;
            }

            container.classList.remove('hidden');
        }

        function initCalendar() {
            document.getElementById('prev-month').addEventListener('click', function() {
                currentCalendarDate.setMonth(currentCalendarDate.getMonth() - 1);
                renderCalendar();
                document.getElementById('selected-date-workout').classList.add('hidden');
            });

            document.getElementById('next-month').addEventListener('click', function() {
                currentCalendarDate.setMonth(currentCalendarDate.getMonth() + 1);
                renderCalendar();
                document.getElementById('selected-date-workout').classList.add('hidden');
            });
        }

        // ============ èº«ä½“æ•°æ®ç¼–è¾‘ ============

        function initBodyData() {
            document.getElementById('edit-body-data-btn').addEventListener('click', function() {
                const weight = prompt('è¯·è¾“å…¥ä½“é‡ (kg):');
                const bodyFat = prompt('è¯·è¾“å…¥ä½“è„‚ç‡ (%):');

                if (weight !== null && weight.trim() !== '') {
                    const bodyData = getBodyData();
                    bodyData.weight = parseFloat(weight);
                    bodyData.bodyFat = bodyFat ? parseFloat(bodyFat) : null;
                    bodyData.history.push({
                        date: new Date().toISOString(),
                        weight: bodyData.weight,
                        bodyFat: bodyData.bodyFat
                    });
                    saveBodyData(bodyData);
                    updateBodyDataDisplay();
                }
            });
        }

        // ============ ç»„é—´è®¡æ—¶å™¨ ============

        let restTimer = null;
        let restTimeLeft = 90;

        function initRestTimer() {
            document.querySelectorAll('.rest-time-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    selectedRestTime = parseInt(this.dataset.time);
                    restTimeLeft = selectedRestTime;

                    // æ›´æ–°æŒ‰é’®æ ·å¼ - Apple é£æ ¼
                    document.querySelectorAll('.rest-time-btn').forEach(b => {
                        // æœªé€‰ä¸­ï¼šæµ…è‰²ç™½è‰²+è¾¹æ¡†ï¼Œæ·±è‰²é€æ˜
                        b.classList.remove('bg-black', 'dark:bg-[#A3FF00]/20', 'text-white', 'dark:text-[#A3FF00]', 'border-transparent', 'dark:border-[#A3FF00]/30');
                        b.classList.add('bg-white', 'dark:bg-black/20', 'border-zinc-200', 'dark:border-none', 'text-gray-600', 'dark:text-zinc-400');
                    });
                    // é€‰ä¸­ï¼šæµ…è‰²é»‘è‰²ï¼Œæ·±è‰²è§å…‰ç»¿
                    this.classList.remove('bg-white', 'dark:bg-black/20', 'border-zinc-200', 'dark:border-none', 'text-gray-600', 'dark:text-zinc-400');
                    this.classList.add('bg-black', 'dark:bg-[#A3FF00]/20', 'text-white', 'dark:text-[#A3FF00]', 'border-transparent', 'dark:border-[#A3FF00]/30');

                    updateManualTimerDisplay();
                });
            });

            document.getElementById('start-timer-btn').addEventListener('click', function() {
                if (restTimer) {
                    clearInterval(restTimer);
                    restTimer = null;
                    this.textContent = 'å¼€å§‹';
                } else {
                    this.textContent = 'æš‚åœ';
                    restTimer = setInterval(() => {
                        restTimeLeft--;
                        updateManualTimerDisplay();

                        if (restTimeLeft <= 0) {
                            clearInterval(restTimer);
                            restTimer = null;
                            this.textContent = 'å¼€å§‹';

                            if (navigator.vibrate) {
                                navigator.vibrate([200, 100, 200]);
                            }
                            alert('ä¼‘æ¯æ—¶é—´ç»“æŸï¼');
                        }
                    }, 1000);
                }
            });

            document.getElementById('reset-timer-btn').addEventListener('click', function() {
                if (restTimer) {
                    clearInterval(restTimer);
                    restTimer = null;
                }
                restTimeLeft = selectedRestTime;
                updateManualTimerDisplay();
                document.getElementById('start-timer-btn').textContent = 'å¼€å§‹';
            });

            // è®¾ç½®é»˜è®¤é€‰ä¸­90ç§’
            const defaultBtn = document.querySelector(`.rest-time-btn[data-time="90"]`);
            if (defaultBtn) {
                defaultBtn.click();
            }
        }

        function updateManualTimerDisplay() {
            document.getElementById('rest-timer-display').textContent = restTimeLeft;

            const ring = document.getElementById('rest-timer-ring');
            const circumference = 2 * Math.PI * 65;
            const offset = circumference - (circumference * (restTimeLeft / selectedRestTime));
            ring.style.strokeDashoffset = offset;

            // æ›´æ–°åœ†ç¯é¢œè‰²ï¼šæµ…è‰²æ¨¡å¼é»‘è‰²ï¼Œæ·±è‰²æ¨¡å¼è§å…‰ç»¿
            const isDark = document.documentElement.classList.contains('dark');
            ring.style.stroke = isDark ? '#A3FF00' : '#000000';
        }

        // ============ V15.0 å·¦æ»‘åˆ é™¤åŠŸèƒ½ ============

        // ============ V16.0 ç„¦ç‚¹æ¨¡å¼å…¨å±€å˜é‡ ============
        let activeCardId = null; // å½“å‰æ¿€æ´»ï¼ˆå±•å¼€ï¼‰çš„å¡ç‰‡ ID
        let foundFirstActive = false; // æ˜¯å¦å·²ç»æ‰¾åˆ°ç¬¬ä¸€ä¸ªæ¿€æ´»å¡ç‰‡

        // ============ V19.0 è¾…åŠ©å‡½æ•° ============

        // å¼€å§‹è®­ç»ƒï¼ˆå±•å¼€å¡ç‰‡ï¼‰
        // åˆ é™¤é‡å¤çš„å‡½æ•°å®šä¹‰ï¼Œä½¿ç”¨å‰é¢å®šä¹‰çš„ startExercise(id)
        function collapseExercise(exerciseId) {
            const plan = getTodaysPlan();
            const exercise = plan.find(ex => ex.id === exerciseId);

            if (exercise && exercise.isStarted && exercise.doneSets === 0) {
                // å¦‚æœè¿˜æ²¡åšä»»ä½•ç»„ï¼Œå…è®¸å®Œå…¨æ”¶èµ·
                exercise.isStarted = false;
                saveTodaysPlan(plan);

                // éœ‡åŠ¨åé¦ˆ
                if (navigator.vibrate) navigator.vibrate(10);

                // é‡ç»˜ç•Œé¢
                if (document.startViewTransition) {
                    document.startViewTransition(() => {
                        renderPlanList(plan);
                    });
                } else {
                    renderPlanList(plan);
                }
            }
        }

        // V21.1: åˆ‡æ¢è¯¦æƒ…å±•å¼€/æ”¶èµ·çŠ¶æ€
        function toggleDetails(exerciseId) {
            const plan = getTodaysPlan();
            const exercise = plan.find(ex => ex.id === exerciseId);

            if (exercise) {
                // åˆ‡æ¢ isDetailsOpen çŠ¶æ€
                exercise.isDetailsOpen = !exercise.isDetailsOpen;

                saveTodaysPlan(plan);

                // éœ‡åŠ¨åé¦ˆ
                if (navigator.vibrate) navigator.vibrate(10);

                // é‡ç»˜ç•Œé¢
                if (document.startViewTransition) {
                    document.startViewTransition(() => {
                        renderPlanList(plan);
                    });
                } else {
                    renderPlanList(plan);
                }
            }
        }

        // åˆ‡æ¢æ¿€æ´»å¡ç‰‡
        function setActiveCard(id) {
            // å¦‚æœç‚¹å‡»çš„æ˜¯å½“å‰å·²ç»æ¿€æ´»çš„ï¼Œæˆ–è€…æ˜¯åˆ é™¤æŒ‰é’®åŒºåŸŸï¼Œå¿½ç•¥
            if (activeCardId === id) return;

            // éœ‡åŠ¨åé¦ˆ
            if (navigator.vibrate) navigator.vibrate(30);

            // æ›´æ–°å…¨å±€çŠ¶æ€
            activeCardId = id;

            // è§¦å‘é‡ç»˜ (åˆ©ç”¨ View Transitions å®ç°å¹³æ»‘å±•å¼€/æ”¶èµ·)
            if (document.startViewTransition) {
                document.startViewTransition(() => {
                    renderPlanList(getTodaysPlan());
                });
            } else {
                renderPlanList(getTodaysPlan());
            }
        }

        // ============ V15.0 å·¦æ»‘åˆ é™¤åŠŸèƒ½ ============

        let touchStartX = 0;
        let touchStartY = 0;
        let currentSwipedCard = null; // å½“å‰æ­£åœ¨æ»‘åŠ¨çš„å¡ç‰‡

        function handleTouchStart(e) {
            const cardLayer = e.target.closest('.card-content-layer');
            if (!cardLayer) return;

            // é˜²æ­¢å¤šæŒ‡è§¦æ‘¸å¹²æ‰°
            if (e.touches.length > 1) return;

            // å¦‚æœç‚¹å‡»çš„æ˜¯äº¤äº’å…ƒç´ ï¼Œä¸è§¦å‘æ»‘åŠ¨
            if (e.target.tagName === 'INPUT' ||
                e.target.tagName === 'BUTTON' ||
                e.target.closest('button') ||
                e.target.closest('.check-bubble') ||
                e.target.closest('.quick-action-btn')) {
                return;
            }

            touchStartX = e.touches[0].clientX;
            touchStartY = e.touches[0].clientY;

            // 1. æŒ‰ä¸‹ç¬é—´ï¼Œç»™ä¸ªå¾®å°çš„ç¼©å°åé¦ˆ (æ¨¡æ‹Ÿç‰©ç†æŒ‰å‹)
            // æ³¨æ„ï¼šåªå˜ scaleï¼Œä¸å˜ä½ç½®ï¼Œä»¥å…å½±å“æ»‘åŠ¨
            cardLayer.style.transition = 'transform 0.2s';
            cardLayer.style.transform = 'scale(0.98)';

            // å…³é—­å…¶ä»–å·²æ‰“å¼€çš„å¡ç‰‡
            if (currentSwipedCard && currentSwipedCard !== cardLayer) {
                // é‡ç½®å…¶ä»–å¡ç‰‡æ—¶ï¼Œä¹Ÿè¦æ¸…é™¤ transform
                currentSwipedCard.style.transform = '';
                currentSwipedCard = null;
            }
        }

        function handleTouchMove(e) {
            const cardLayer = e.target.closest('.card-content-layer');
            if (!cardLayer) return;

            const touchX = e.touches[0].clientX;
            const touchY = e.touches[0].clientY;
            const deltaX = touchX - touchStartX;
            const deltaY = touchY - touchStartY;

            // 1. å‚ç›´æ»šåŠ¨ä¼˜å…ˆï¼šå¦‚æœæ˜¯ä¸Šä¸‹åˆ’ï¼Œä»€ä¹ˆéƒ½ä¸åšï¼Œè®©æµè§ˆå™¨æ»šåŠ¨é¡µé¢
            if (Math.abs(deltaY) > Math.abs(deltaX)) return;

            // 2. å·¦æ»‘é€»è¾‘
            if (deltaX < 0) {
                // å…³é”®ï¼šä¸€æ—¦æ£€æµ‹åˆ°æ˜¯æ˜æ˜¾çš„å·¦æ»‘ï¼Œç«‹åˆ»é˜»æ­¢é»˜è®¤è¡Œä¸º
                if (e.cancelable) e.preventDefault();

                // åŠ¨æ€è®¡ç®—ä½ç§» (å¢åŠ é˜»å°¼æ„Ÿ)
                const moveX = Math.max(deltaX, -100);
                cardLayer.style.transform = `translateX(${moveX}px)`;
            }
        }

        function handleTouchEnd(e) {
            const cardLayer = e.target.closest('.card-content-layer');
            if (!cardLayer) return;

            const touchEndX = e.changedTouches[0].clientX;
            const deltaX = touchEndX - touchStartX;
            const threshold = -60; // ç¨å¾®å¢åŠ é˜ˆå€¼ï¼Œé˜²è¯¯è§¦

            // 2. æ¾æ‰‹æ—¶ï¼Œæ¸…é™¤æŒ‰å‹ç¼©æ”¾
            // ç¨å¾®å»¶è¿Ÿä¸€ç‚¹æ¸…é™¤ï¼Œé¿å…åŠ¨ç”»è·³å˜
            setTimeout(() => {
                // å¦‚æœæ²¡æœ‰è§¦å‘å·¦æ»‘åˆ é™¤ï¼Œå°±å®Œå…¨å¤åŸ
                if (deltaX >= threshold) {
                    cardLayer.style.transform = '';
                }
            }, 100);

            if (deltaX < threshold) {
                // æ‰“å¼€åˆ é™¤èœå•
                cardLayer.style.transform = 'translateX(-80px)';
                currentSwipedCard = cardLayer;
                if (navigator.vibrate) navigator.vibrate(20);

                // æ£€æŸ¥æ˜¯å¦ç‚¹å‡»äº†åˆ é™¤æŒ‰é’®
                const swipeContainer = cardLayer.closest('.swipe-container');
                const deleteLayer = swipeContainer?.querySelector('.delete-action-layer');

                if (deleteLayer) {
                    // æ·»åŠ ç‚¹å‡»åˆ é™¤æŒ‰é’®çš„äº‹ä»¶ç›‘å¬
                    deleteLayer.onclick = function() {
                        deleteExercise(swipeContainer);
                    };
                }
            } else {
                // è¿™ä¸€æ­¥åœ¨ä¸Šé¢ setTimeout é‡Œå·²ç»å¤„ç†äº†å¤åŸï¼Œè¿™é‡Œåªéœ€ç½®ç©º
                currentSwipedCard = null;
            }
        }

        // åˆ é™¤åŠŸèƒ½
        function deleteExercise(container) {
            if (!container) return;

            const exerciseId = container.dataset.exerciseId;
            if (!exerciseId) return;

            // 1. éœ‡åŠ¨åé¦ˆ
            if (navigator.vibrate) navigator.vibrate([30, 50, 30]);

            // 2. æ’­æ”¾åˆ é™¤åŠ¨ç”»
            const cardLayer = container.querySelector('.card-content-layer');
            if (cardLayer) {
                cardLayer.classList.add('being-deleted');
            }

            // 3. ç­‰åŠ¨ç”»æ’­å®Œå†åˆ æ•°æ®
            setTimeout(() => {
                const plan = getTodaysPlan();
                const index = plan.findIndex(ex => ex.id === exerciseId);

                if (index > -1) {
                    plan.splice(index, 1);
                    saveTodaysPlan(plan);
                    updateUI();
                }

                // é‡ç½®å½“å‰æ»‘åŠ¨çš„å¡ç‰‡
                currentSwipedCard = null;
            }, 400);
        }

        function initSwipeToDelete() {
            // æ·»åŠ äº‹ä»¶ç›‘å¬å™¨ï¼ˆä½¿ç”¨äº‹ä»¶å§”æ‰˜ï¼‰
            document.addEventListener('touchstart', handleTouchStart, { passive: false });
            document.addEventListener('touchmove', handleTouchMove, { passive: false });
            document.addEventListener('touchend', handleTouchEnd);

            // ç‚¹å‡»é¡µé¢å…¶ä»–åœ°æ–¹å…³é—­å·²æ‰“å¼€çš„å¡ç‰‡
            document.addEventListener('click', function(e) {
                if (currentSwipedCard && !e.target.closest('.swipe-container')) {
                    currentSwipedCard.style.transform = 'translateX(0)';
                    currentSwipedCard = null;
                }
            });
        }

        // ============ åˆå§‹åŒ– ============

        document.addEventListener('DOMContentLoaded', function() {
            // æ›´æ–°æ—¥æœŸæ˜¾ç¤º
            updateDateDisplay();

            // è‡ªåŠ¨ä¿®å¤æ‰€æœ‰localStorageä¸­çš„è®­ç»ƒæ•°æ®
            Object.keys(localStorage).forEach(key => {
                if (key.startsWith('ironlog_plan_')) {
                    try {
                        const plan = JSON.parse(localStorage.getItem(key));
                        let needsFix = false;

                        plan.forEach(exercise => {
                            if (exercise.type === 'cardio') {
                                // æœ‰æ°§è®­ç»ƒæ•°æ®ä¿®å¤
                                if (exercise.completed === undefined || exercise.completed === null) {
                                    exercise.completed = false;
                                    needsFix = true;
                                }
                            } else {
                                // åŠ›é‡è®­ç»ƒæ•°æ®ä¿®å¤
                                if (!exercise.type) {
                                    exercise.type = 'strength';
                                    needsFix = true;
                                }
                                // ä¿®å¤å¼‚å¸¸çš„doneSets
                                if (exercise.doneSets > 100 || exercise.doneSets === undefined || exercise.doneSets === null) {
                                    exercise.doneSets = 0;
                                    needsFix = true;
                                }
                                // ç¡®ä¿restTimeå­˜åœ¨
                                if (!exercise.restTime) {
                                    exercise.restTime = 90;
                                    needsFix = true;
                                }

                                // å…¼å®¹æ—§æ•°æ®ç»“æ„ï¼šå°† weight è¿ç§»åˆ° initialWeight å’Œ weightLogs
                                if (exercise.weight !== undefined && exercise.weight !== null) {
                                    // å¦‚æœæœ‰æ—§çš„ weight å­—æ®µï¼Œè¿ç§»åˆ°æ–°ç»“æ„
                                    if (!exercise.initialWeight) {
                                        exercise.initialWeight = exercise.weight;
                                    }
                                    if (!exercise.weightLogs) {
                                        exercise.weightLogs = [];
                                    }
                                    // åˆ é™¤æ—§çš„ weight å­—æ®µ
                                    delete exercise.weight;
                                    needsFix = true;
                                }

                                // ç¡®ä¿ initialWeight å­˜åœ¨
                                if (exercise.initialWeight === undefined || exercise.initialWeight === null) {
                                    exercise.initialWeight = 0;
                                    needsFix = true;
                                }

                                // ç¡®ä¿ weightLogs å­˜åœ¨ï¼Œå¹¶å…¼å®¹æ—§æ ¼å¼
                                if (!exercise.weightLogs) {
                                    exercise.weightLogs = [];
                                    needsFix = true;
                                } else if (exercise.weightLogs.length > 0 && typeof exercise.weightLogs[0] !== 'object') {
                                    // æ£€æµ‹åˆ°æ—§æ ¼å¼ï¼ˆçº¯æ•°å­—æ•°ç»„ï¼‰ï¼Œè¿ç§»åˆ°æ–°æ ¼å¼
                                    const oldWeights = exercise.weightLogs;
                                    exercise.weightLogs = oldWeights.map((weight, index) => ({
                                        weight: weight,
                                        setNumber: index + 1,
                                        timestamp: null  // æ—§æ•°æ®æ²¡æœ‰æ—¶é—´æˆ³
                                    }));
                                    needsFix = true;
                                }

                                // ç¡®ä¿ plannedSets å­˜åœ¨ï¼ˆå¦‚æœæ˜¯åŠ›é‡è®­ç»ƒï¼‰
                                if (exercise.type === 'strength' && !exercise.plannedSets) {
                                    exercise.plannedSets = null;
                                }
                            }
                        });

                        if (needsFix) {
                            localStorage.setItem(key, JSON.stringify(plan));
                        }
                    } catch (e) {
                        // é™é»˜å¤„ç†é”™è¯¯
                    }
                }
            });

            initTheme();  // åˆå§‹åŒ–ä¸»é¢˜
            initTabNavigation();
            initRestTimer();
            initInputConsole();
            initClearButton();
            initV4Features();
            initWorkoutMode();
            initRestTimerOverlay();
            initCalendar();
            initBodyData();
            initSwipeToDelete();  // V15.0 åˆå§‹åŒ–å·¦æ»‘åˆ é™¤

            // V25/V26: Initialize new data system
            initApp();

            // åˆå§‹åŒ–æ™ºèƒ½ä¼‘æ¯èƒ¶å›ŠæŒ‰é’®äº‹ä»¶
            initSmartRestButtons();
        });
    </script>
</body>
</html>
